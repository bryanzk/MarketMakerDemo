<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Market Maker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Japanese Style Color Palette */
        :root {
            --japanese-bg: #FFF8F0; /* Warm off-white */
            --japanese-card: #FFFFFF;
            --japanese-text: #4A4A4A;
            --japanese-text-light: #8B8B8B;
            --japanese-accent-pink: #FFB6C1; /* Sakura pink */
            --japanese-accent-blue: #B0C4DE; /* Soft blue */
            --japanese-accent-green: #98D8C8; /* Mint green */
            --japanese-accent-orange: #FFD4A3; /* Peach */
            --japanese-shadow: rgba(0, 0, 0, 0.05);
            --japanese-border: #E8E8E8;
        }

        body {
            font-family: 'Inter', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #FFF8F0 0%, #FFF5E6 100%);
            background-attachment: fixed;
            color: var(--japanese-text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--japanese-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--japanese-shadow);
            border: 1px solid var(--japanese-border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--japanese-text-light);
            font-weight: 500;
        }

        .card .value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 10px;
            color: var(--japanese-text);
        }

        .sub-text {
            font-size: 0.8rem;
            color: var(--japanese-text-light);
            margin-top: 5px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #B0C4DE 0%, #9BB5D1 100%);
            color: #FFFFFF;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA8B8 100%);
            color: #FFFFFF;
        }

        .btn-success {
            background: linear-gradient(135deg, #98D8C8 0%, #7FC8B8 100%);
            color: #FFFFFF;
        }

        .btn:disabled {
            background: #E8E8E8;
            color: #B8B8B8;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #E8F5E9;
            color: #4CAF50;
        }

        .status-inactive {
            background-color: #FFE0E0;
            color: #E57373;
        }

        .status-error {
            background-color: #FFF3E0;
            color: #FFB74D;
        }

        .error-message {
            background-color: #FFE0E0;
            color: #E57373;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 3px solid #FFB6C1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--japanese-border);
        }

        th {
            background-color: #F8F8F8;
            color: var(--japanese-text);
            font-weight: 500;
        }

        .log-console {
            background: #2C2C2C;
            color: #98D8C8;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: rgba(74, 74, 74, 0.95);
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .toast.success {
            background: linear-gradient(135deg, #98D8C8 0%, #7FC8B8 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA8B8 100%);
        }

        /* Tooltip System */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            z-index: 1;
        }

        .tooltip-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background: rgba(107, 91, 115, 0.2);
            color: #6B5B73;
            font-size: 10px;
            font-weight: bold;
            margin-left: 4px;
            vertical-align: middle;
            transition: all 0.2s;
        }

        .tooltip-container:hover .tooltip-icon {
            background: rgba(107, 91, 115, 0.4);
            transform: scale(1.1);
        }

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            background: linear-gradient(135deg, #FFFFFF 0%, #FFF8F0 100%);
            color: #4A4A4A;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid #FFD4A3;
            width: 300px;
            max-width: 90vw;
            font-size: 12px;
            line-height: 1.6;
            z-index: 99999 !important;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
        }

        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #FFD4A3;
        }

        .tooltip-container:hover .tooltip-content {
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Position tooltip dynamically on hover */
        .tooltip-container {
            position: relative;
        }

        .tooltip-title {
            font-weight: 600;
            color: #6B5B73;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .tooltip-en {
            color: #8B7A8B;
            margin-bottom: 4px;
        }

        .tooltip-cn {
            color: #4A4A4A;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ================================================================== -->
        <!-- Portfolio Overview and Risk Indicators - Side by Side -->
        <!-- ================================================================== -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; align-items: stretch;">
        <!-- Portfolio Overview (US-1.x) -->
        <div id="portfolioOverview" class="portfolio-overview" style="
            background: linear-gradient(135deg, #FFE4E1 0%, #FFD4A3 100%);
            padding: 20px;
            border-radius: 12px;
            color: #4A4A4A;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 style="margin: 0; font-size: 18px; color: #6B5B73;">üè¶ Portfolio Overview</h2>
                    <div style="font-size: 11px; color: #8B7A8B; background: rgba(255, 255, 255, 0.6); padding: 3px 8px; border-radius: 4px;">
                        üìÖ Since: <span id="sessionStartTime" style="color: #6B5B73;">--</span>
                    </div>
                </div>
                <div style="font-size: 13px; color: #6B5B73;">
                    Wallet: <span id="portfolioCapital" style="color: #4A4A4A; font-weight: bold;">$10,000</span>
                    <span style="margin: 0 8px;">|</span>
                    <span class="tooltip-container" data-term="Available">
                        Available: <span id="portfolioAvailable" style="color: #7FC8B8; font-weight: bold;">$10,000</span>
                        <span class="tooltip-icon">‚ÑπÔ∏è</span>
                        <div class="tooltip-content"></div>
                    </span>
                </div>
            </div>
            <div class="card-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Total PnL">
                            Total PnL<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="portfolioTotalPnl" style="font-size: 1.5rem; font-weight: bold; color: #7FC8B8;">+$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Trading Fees">
                            Trading Fees<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="portfolioCommission" style="font-size: 1.5rem; font-weight: bold; color: #FFD4A3;">$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Net PnL">
                            Net PnL<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="portfolioNetPnl" style="font-size: 1.5rem; font-weight: bold; color: #7FC8B8;">+$0.00</div>
                </div>
            </div>
            <div class="card-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Portfolio Sharpe">
                            Portfolio Sharpe<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="portfolioSharpe" style="font-size: 1.5rem; font-weight: bold;">--</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">Active Strategies</div>
                    <div id="portfolioActiveCount" style="font-size: 1.5rem; font-weight: bold;">0 / 2</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">Portfolio Risk</div>
                    <div id="portfolioRisk" style="font-size: 1.5rem; font-weight: bold; color: #7FC8B8;">Low ‚úì</div>
                </div>
            </div>
        </div>

        <!-- Risk Indicators (US-R1, US-R2, US-R3) - P0 -->
        <div id="riskIndicators" style="
            background: linear-gradient(135deg, #4a1d1d 0%, #6b2d2d 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            flex-direction: column;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 18px; color: #fca5a5;">‚ö†Ô∏è Risk Indicators</h2>
                <div style="font-size: 13px;">
                    Overall Risk: <span id="overallRiskLevel" class="risk-badge" style="
                        padding: 4px 12px;
                        border-radius: 12px;
                        font-weight: bold;
                        background: #10b981;
                        color: white;
                    ">LOW</span>
                </div>
            </div>
            <div class="card-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <!-- Liquidation Buffer -->
                <div id="liqBufferCard" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border: 2px solid transparent;">
                    <div style="font-size: 12px; color: #fca5a5; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Liquidation Buffer">
                            Liquidation Buffer<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="liqBufferValue" style="font-size: 1.8rem; font-weight: bold; color: #10b981;">--</div>
                    <div id="liqBufferStatus" style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #6b7280; margin-right: 5px;"></span>
                        No Position
                    </div>
                </div>
                
                <!-- Inventory Drift -->
                <div id="invDriftCard" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border: 2px solid transparent;">
                    <div style="font-size: 12px; color: #fca5a5; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Inventory Drift">
                            Inventory Drift<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="invDriftValue" style="font-size: 1.8rem; font-weight: bold; color: #10b981;">0%</div>
                    <div id="invDriftStatus" style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 5px;"></span>
                        Balanced
                    </div>
                </div>
                
                <!-- Max Drawdown -->
                <div id="maxDrawdownCard" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border: 2px solid transparent;">
                    <div style="font-size: 12px; color: #fca5a5; margin-bottom: 5px;">
                        <span class="tooltip-container" data-term="Max Drawdown">
                            Max Drawdown<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div id="maxDrawdownValue" style="font-size: 1.8rem; font-weight: bold; color: #10b981;">0%</div>
                    <div id="maxDrawdownStatus" style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 5px;"></span>
                        Excellent
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End of Portfolio Overview and Risk Indicators side-by-side container -->

        <!-- ================================================================== -->
        <!-- Strategy Comparison Table (US-2.x) -->
        <!-- ================================================================== -->
        <div id="strategyComparison" class="card" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">üìä Strategy Comparison</h3>
                <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="fetchPortfolio()">
                    üîÑ Refresh
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table id="strategyTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead style="background: #f3f4f6;">
                        <tr>
                            <th style="padding: 12px 8px; text-align: left; cursor: pointer;" onclick="sortStrategies('name')">
                                Strategy <span class="sort-icon"></span>
                            </th>
                            <th style="padding: 12px 8px; text-align: center;">Status</th>
                            <th style="padding: 12px 8px; text-align: right; cursor: pointer;" onclick="sortStrategies('pnl')">
                                <span class="tooltip-container" data-term="PnL">
                                    PnL<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                    <div class="tooltip-content"></div>
                                </span>
                                <span class="sort-icon">‚ñº</span>
                            </th>
                            <th style="padding: 12px 8px; text-align: right; cursor: pointer;" onclick="sortStrategies('sharpe')">
                                <span class="tooltip-container" data-term="Sharpe Ratio">
                                    Sharpe<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                    <div class="tooltip-content"></div>
                                </span>
                                <span class="sort-icon"></span>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; cursor: pointer;" onclick="sortStrategies('health')">
                                Health <span class="sort-icon"></span>
                            </th>
                            <th style="padding: 12px 8px; text-align: right;">Allocation</th>
                            <th style="padding: 12px 8px; text-align: right; cursor: pointer;" onclick="sortStrategies('roi')">
                                ROI <span class="sort-icon"></span>
                            </th>
                            <th style="padding: 12px 8px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="strategyTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #9ca3af;">
                                Loading strategies...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ================================================================== -->
        <!-- Tab Navigation -->
        <!-- ================================================================== -->
        <div class="tab-nav" style="margin-bottom:20px;">
            <button class="btn btn-primary" id="tradeTabBtn" onclick="showTab('trade')">
                Fixed Spread Strategy
            </button>
            <button class="btn" id="fundingTabBtn" onclick="showTab('funding')">
                Funding Rate Skew Strategy
            </button>
            <button class="btn" id="dashboardTabBtn" onclick="showTab('dashboard')">
                Performance Dashboard
            </button>
        </div>
        <div id="tradeTab">
            <div class="header">
                <h1>Binance Market Maker (MVP)</h1>
                <div style="text-align: right;">
                    <div>
                        <span id="currentSymbol" style="font-weight: bold; margin-right: 10px;">--</span>
                        <span id="botStatus" class="status-badge status-inactive">STOPPED</span>
                    </div>
                    <div id="stageDisplay" style="font-size: 12px; color: #6b7280; margin-top: 5px; font-weight: bold;">
                        Idle
                    </div>
                    <div style="margin-top: 8px;">
                        <a href="/evaluation" class="btn btn-secondary" style="font-size: 12px; padding:6px 12px;">
                            üîé Open LLM Trade Lab
                        </a>
                    </div>
                </div>
            </div>

            <div id="errorDisplay" class="error-message" style="display: none;"></div>
            <div id="alertDisplay" class="error-message"
                style="display: none; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                <strong>‚ö†Ô∏è Alert:</strong> <span id="alertMessage"></span>
                <div id="alertSuggestion" style="font-size: 12px; margin-top: 5px;"></div>
            </div>

            <div class="card-grid" style="grid-template-columns: repeat(3, 1fr);">
                <!-- Real-time Market Data -->
                <div class="card">
                    <h3>Mid Price</h3>
                    <div class="value" id="midPrice" style="color: #B0C4DE;">--</div>
                    <div class="sub-text">Current Market Price</div>
                </div>
                <div class="card">
                    <h3>
                        <span class="tooltip-container" data-term="Position">
                            Position (ETH)<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </h3>
                    <div class="value" id="position" style="color: #7FC8B8;">--</div>
                    <div class="sub-text">Current Position Size</div>
                </div>
                <div class="card">
                    <h3>
                        <span class="tooltip-container" data-term="Leverage">
                            Leverage<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </h3>
                    <div class="value" id="leverage" style="color: #FFD4A3;">--</div>
                    <div class="sub-text">Current Leverage</div>
                </div>
                
                <!-- Account Overview (Combined Balance + Unrealized PnL) -->
                <div class="card" style="background: linear-gradient(135deg, #FFF5E6 0%, #FFE4E1 100%); border: 1px solid #FFD4A3;">
                    <h3 style="color: #6B5B73;">Account Overview</h3>
                    <div style="margin-top: 10px;">
                        <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                            <span class="tooltip-container" data-term="Balance">
                                Balance (USDT)<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                <div class="tooltip-content"></div>
                            </span>
                        </div>
                        <div class="value" id="balance" style="color: #7FC8B8; font-size: 1.3rem;">--</div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #FFD4A3;">
                        <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                            <span class="tooltip-container" data-term="Unrealized PnL">
                                Unrealized PnL<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                <div class="tooltip-content"></div>
                            </span>
                        </div>
                        <div class="value" id="pnl" style="color: #FFB6C1; font-size: 1.3rem;">--</div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #FFD4A3;">
                        <div style="font-size: 12px; color: #8B7A8B; margin-bottom: 5px;">
                            <span class="tooltip-container" data-term="Equity">
                                Equity<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                <div class="tooltip-content"></div>
                            </span>
                        </div>
                        <div class="value" id="equity" style="color: #B0C4DE; font-size: 1.3rem;">--</div>
                        <div class="sub-text" style="color: #8B7A8B; font-size: 11px;">Balance + Unrealized PnL</div>
                    </div>
                </div>
                
                <!-- Funding Rate Info -->
                <div class="card">
                    <h3>
                        <span class="tooltip-container" data-term="Funding Rate">
                            Funding Rate<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </h3>
                    <div class="value" id="fundingRate" style="color: #FFB6C1;">--</div>
                    <div class="sub-text">Current Funding Rate</div>
                </div>
                <div class="card">
                    <h3>
                        <span class="tooltip-container" data-term="Est. Daily Yield">
                            Est. Daily Yield<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </h3>
                    <div class="value" id="dailyYield" style="color: #7FC8B8;">--</div>
                    <div class="sub-text">Based on Funding Rate</div>
                </div>
            </div>

            <!-- Main Control Section: Left (Control Panel) + Right (Suggestions & Constraints) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; align-items: stretch;">
                <!-- Left: Control Panel -->
                <div class="card" style="display: flex; flex-direction: column;">
                    <h3>Control Panel</h3>
                    
                    <!-- Trading Pair - Highlighted -->
                    <div style="background: linear-gradient(135deg, #FFE4E1 0%, #FFD4A3 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #FFB6C1;">
                        <div style="font-size: 11px; color: #6B5B73; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">üìä Trading Pair</div>
                        <select id="pairSelect" onchange="updatePair()" style="
                            width: 100%;
                            padding: 12px 15px;
                            font-size: 18px;
                            font-weight: bold;
                            background: #FFFFFF;
                            color: #7FC8B8;
                            border: 2px solid #98D8C8;
                            border-radius: 8px;
                            cursor: pointer;
                            outline: none;
                        ">
                            <optgroup label="Mainstream">
                                <option value="BTC/USDT:USDT">BTC/USDT</option>
                                <option value="ETH/USDT:USDT" selected>ETH/USDT</option>
                                <option value="SOL/USDT:USDT">SOL/USDT</option>
                            </optgroup>
                            <optgroup label="Memecoins">
                                <option value="DOGE/USDT:USDT">DOGE/USDT</option>
                                <option value="1000SHIB/USDT:USDT">1000SHIB/USDT</option>
                                <option value="1000PEPE/USDT:USDT">1000PEPE/USDT</option>
                                <option value="WIF/USDT:USDT">WIF/USDT</option>
                                <option value="1000FLOKI/USDT:USDT">1000FLOKI/USDT</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Start/Stop Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="startBtn" class="btn btn-success" onclick="startFixedSpreadBot()" style="flex: 1; padding: 12px;">‚ñ∂ Start Bot</button>
                        <button id="stopBtn" class="btn btn-danger" onclick="stopStrategyInstance('fixed_spread')" disabled style="flex: 1; padding: 12px;">‚èπ Stop Bot</button>
                    </div>

                    <!-- Trading Parameters - Highlighted -->
                    <div style="background: linear-gradient(135deg, #FFF5E6 0%, #FFE4E1 100%); padding: 15px; border-radius: 10px; border: 1px solid #FFD4A3;">
                        <div style="font-size: 11px; color: #6B5B73; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">‚öôÔ∏è Trading Parameters</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 12px; color: #8B7A8B; display: block; margin-bottom: 5px;">
                                    <span class="tooltip-container" data-term="Spread">
                                        Spread (%)<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                        <div class="tooltip-content"></div>
                                    </span>
                                </label>
                                <input type="number" id="spreadInput" step="0.001" value="0.002" style="
                                    width: 100%;
                                    padding: 10px;
                                    font-size: 16px;
                                    font-weight: bold;
                                    background: #FFFFFF;
                                    color: #FFB6C1;
                                    border: 2px solid #FFD4A3;
                                    border-radius: 6px;
                                    box-sizing: border-box;
                                ">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #8B7A8B; display: block; margin-bottom: 5px;">Quantity</label>
                                <input type="number" id="qtyInput" step="0.01" value="0.02" min="0.001" max="1000" style="
                                    width: 100%;
                                    padding: 10px;
                                    font-size: 16px;
                                    font-weight: bold;
                                    background: #FFFFFF;
                                    color: #FFB6C1;
                                    border: 2px solid #FFD4A3;
                                    border-radius: 6px;
                                    box-sizing: border-box;
                                " onchange="validateQuantity()">
                            </div>
                        </div>

                        <div id="skewFactorContainer" style="display: none; margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #8B7A8B; display: block; margin-bottom: 5px;">
                                <span class="tooltip-container" data-term="Skew Factor">
                                    Skew Factor<span class="tooltip-icon">‚ÑπÔ∏è</span>
                                    <div class="tooltip-content"></div>
                                </span>
                            </label>
                            <input type="number" id="skewFactorInput" step="10" value="100" style="
                                width: 100%;
                                padding: 10px;
                                font-size: 16px;
                                font-weight: bold;
                                background: #FFFFFF;
                                color: #FFB6C1;
                                border: 2px solid #FFD4A3;
                                border-radius: 6px;
                                box-sizing: border-box;
                            ">
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Controls funding rate impact on price skew.</div>
                        </div>

                        <button class="btn btn-primary" style="width: 100%; padding: 10px; font-weight: bold;"
                            onclick="updateConfig()">üíæ Update Config</button>
                    </div>

                    <!-- Leverage Section -->
                    <div style="background: #FFF5E6; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #FFD4A3;">
                        <label style="font-size: 12px; color: #6B5B73; display: block; margin-bottom: 8px;">Leverage (<span id="leverageRange">1-125</span>x)</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="leverageInput" min="1" max="125" value="5" style="
                                width: 80px;
                                padding: 8px;
                                font-size: 14px;
                                font-weight: bold;
                                background: #FFFFFF;
                                color: #B0C4DE;
                                border: 1px solid #FFD4A3;
                                border-radius: 4px;
                                text-align: center;
                            ">
                            <button class="btn btn-primary" style="flex: 1; padding: 8px 12px; font-size: 12px;"
                                onclick="updateLeverage()">Update Leverage</button>
                        </div>
                    </div>

                    <!-- Hidden strategy select for compatibility -->
                    <select id="strategySelect" style="display: none;" onchange="toggleStrategyParams()">
                        <option value="fixed_spread">Fixed Spread</option>
                        <option value="funding_rate">Funding Rate Skew</option>
                    </select>
                </div>
                
                <!-- Right: Strategy Suggestions & Trading Constraints -->
                <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                    <div class="card" style="flex-shrink: 0;">
                        <h3>Strategy Suggestions</h3>
                        <div id="suggestionBox" style="margin-top: 10px;">
                            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Market Condition:</div>
                            <div id="marketCondition" class="status-badge" style="background: #e5e7eb; color: #374151;">
                                Loading...</div>

                            <div style="margin-top: 15px; font-size: 14px; font-weight: bold;">Recommendation:</div>
                            <div style="font-size: 13px; margin-top: 5px;">
                                Spread: <span id="recSpread" style="font-weight: bold;">--</span> |
                                Leverage: <span id="recLeverage" style="font-weight: bold;">--</span>
                            </div>

                            <div style="margin-top: 15px; font-size: 14px; font-weight: bold;">Reasoning:</div>
                            <div id="recReason" style="font-size: 12px; color: #6b7280; margin-top: 5px; line-height: 1.4;">
                                --
                            </div>

                            <button class="btn btn-success" style="margin-top: 15px; width: 100%; font-size: 12px;"
                                onclick="applySuggestion()">Apply Recommendation</button>
                        </div>
                    </div>

                    <!-- Multi-LLM Evaluation Panel -->
                    <div class="card" style="flex-shrink: 0;" id="evaluationCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                            <div>
                                <h3 style="margin: 0;">Multi-LLM Evaluation / Â§öÊ®°ÂûãËØÑ‰º∞</h3>
                                <div style="font-size: 12px; color: #6b7280;">Gemini ¬∑ OpenAI ¬∑ Claude</div>
                            </div>
                            <button id="runEvaluationBtn" class="btn btn-primary" style="font-size: 12px;"
                                onclick="runEvaluation()">üöÄ Run Evaluation</button>
                        </div>

                        <div id="evaluationStatusText" style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                            Waiting for evaluation...
                        </div>

                        <div id="evaluationErrorBox"
                            style="display: none; margin-top: 10px; background: #fef2f2; border-left: 3px solid #ef4444; padding: 8px; font-size: 12px; color: #991b1b;">
                        </div>

                        <div id="evaluationConsensusCard"
                            style="display: none; margin-top: 12px; border: 1px dashed #c4b5fd; padding: 12px; border-radius: 8px; background: #f5f3ff;">
                            <div style="font-size: 14px; font-weight: bold; color: #6d28d9;">ü§ù Consensus Recommendation</div>
                            <div style="margin-top: 8px; font-size: 13px;">
                                <div>Strategy: <span id="evaluationConsensusStrategy" style="font-weight: bold;">--</span></div>
                                <div>Consensus Level: <span id="evaluationConsensusLevel">--</span></div>
                                <div>Confidence: <span id="evaluationConsensusConfidence">--</span></div>
                                <div>Spread / Skew / Qty / Leverage:
                                    <span id="evaluationConsensusParams" style="font-weight: bold;">--</span>
                                </div>
                            </div>
                            <div id="evaluationConsensusStats" style="margin-top: 6px; font-size: 12px; color: #4b5563;">
                                Avg PnL / Sharpe / WinRate: --
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #6b7280;" id="evaluationConsensusReasoning">
                                --
                            </div>
                            <button class="btn btn-success" style="margin-top: 12px; width: 100%; font-size: 12px;"
                                onclick="applyEvaluation('consensus')">Apply Consensus</button>
                        </div>

                        <div id="evaluationResultsWrapper" style="margin-top: 15px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 13px; font-weight: bold;">Model Comparison</div>
                                <div id="evaluationLastRun"
                                    style="font-size: 11px; color: #6b7280; text-align: right;"></div>
                            </div>
                            <div style="overflow-x: auto; margin-top: 8px;">
                                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f3f4f6; text-align: left;">
                                            <th>Rank</th>
                                            <th>Provider</th>
                                            <th>Strategy</th>
                                            <th>Spread</th>
                                            <th>Skew</th>
                                            <th>Qty</th>
                                            <th>Leverage</th>
                                            <th>Confidence</th>
                                            <th>PnL</th>
                                            <th>Sharpe</th>
                                            <th>Win%</th>
                                            <th>Score</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="evaluationResultsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <h3 style="flex-shrink: 0; margin-bottom: 10px;">Trading Constraints</h3>
                        <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; min-height: 0;">
                            <!-- Binance Exchange Limits -->
                            <div style="display: flex; flex-direction: column;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #3b82f6;">üìä Binance Exchange Limits</div>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Min Quantity:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintMinQty">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Max Quantity:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintMaxQty">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Step Size:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintStepSize">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Min Notional:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintMinNotional">--</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Internal Limits -->
                            <div style="display: flex; flex-direction: column;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #10b981;">‚öôÔ∏è Internal Limits</div>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Max Position:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintMaxPos">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Current Leverage:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintLeverage">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Current Spread:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintSpread">--</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #6b7280;">Order Quantity:</td>
                                        <td style="text-align: right; font-weight: bold;" id="constraintQty">--</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order History and System Logs -->
            <div class="card-grid">
                <div class="card" style="grid-column: span 2;">
                    <h3>Active Orders</h3>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders here -->
                        </tbody>
                    </table>
                </div>
                <!-- System Activity Log -->
                <div class="card" style="grid-column: span 2;">
                    <h3>System Activity</h3>
                    <div id="systemLogs"
                        style="height: 150px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb; padding: 10px; font-family: monospace; font-size: 12px; color: #374151;">
                        <div style="color: #9ca3af;">Waiting for activity...</div>
                    </div>
                </div>

                <!-- Order Error Display -->
                <div id="orderErrorDisplay" class="card"
                    style="grid-column: span 2; display: none; background: #fef2f2; border-left: 4px solid #ef4444;">
                    <h3 style="color: #dc2626;">‚ö†Ô∏è API Error</h3>
                    <div id="orderErrorContent" style="font-size: 13px; line-height: 1.6;"></div>
                </div>

                <!-- Order History -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Order History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="historySymbolFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Symbols</option>
                            <option value="ETH/USDT:USDT">ETH/USDT</option>
                            <option value="BTC/USDT:USDT">BTC/USDT</option>
                        </select>
                        <select id="historyStatusFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Status</option>
                            <option value="placed">Placed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="filled">Filled</option>
                        </select>
                        <select id="historyTimeFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="orderHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Side</th>
                                    <th style="padding: 8px; text-align: right;">Price</th>
                                    <th style="padding: 8px; text-align: right;">Qty</th>
                                    <th style="padding: 8px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="orderHistoryBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No orders
                                        yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Error History -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Error History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="errorTypeFilter" onchange="fetchErrorHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Types</option>
                            <option value="invalid_price">Invalid Price</option>
                            <option value="invalid_quantity">Invalid Quantity</option>
                            <option value="notional_below_min">Notional Too Small</option>
                            <option value="exchange_error">Exchange Error</option>
                        </select>
                        <select id="errorTimeFilter" onchange="fetchErrorHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="errorHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Type</th>
                                    <th style="padding: 8px; text-align: left;">Message</th>
                                </tr>
                            </thead>
                            <tbody id="errorHistoryBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af;">
                                        No errors recorded
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Settings -->
                <div class="card" style="grid-column: span 2;">
                    <h3>PnL Trend Chart</h3>
                    <canvas id="pnlChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div id="fundingTab" style="display: none;">
            <div class="header">
                <h1>Funding Rate Skew Strategy</h1>
                <div style="text-align: right;">
                    <div>
                        <span id="currentSymbolFunding" style="font-weight: bold; margin-right: 10px;">--</span>
                        <span id="botStatusFunding" class="status-badge status-inactive">STOPPED</span>
                    </div>
                    <div id="stageDisplayFunding"
                        style="font-size: 12px; color: #6b7280; margin-top: 5px; font-weight: bold;">
                        Idle
                    </div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h3>Funding Overview</h3>
                    <div style="font-size: 13px; color: #6b7280;">Current Funding Rate</div>
                    <div class="value" id="fundingRateFunding">--</div>
                    <div class="sub-text">Positive = Paying, Negative = Receiving</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">Est. Daily Yield (Funding Only)
                    </div>
                    <div class="value" id="dailyFundingYield">--</div>
                </div>
                <div class="card">
                    <h3>Position & Notional</h3>
                    <div style="font-size: 13px; color: #6b7280;">Net Position</div>
                    <div class="value" id="positionFunding">--</div>
                    <div class="sub-text">Base asset (e.g., ETH)</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">
                        <span class="tooltip-container" data-term="Notional">
                            Notional Value<span class="tooltip-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip-content"></div>
                        </span>
                    </div>
                    <div class="value" id="notionalFunding">--</div>
                </div>
                <div class="card">
                    <h3>Spread & Skew</h3>
                    <div style="font-size: 13px; color: #6b7280;">Base Spread</div>
                    <div class="value" id="spreadFunding">--</div>
                    <div class="sub-text">From current strategy config</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">Funding Skew Factor</div>
                    <div class="value" id="skewFunding">--</div>
                </div>
                <div class="card">
                    <h3>Funding Condition</h3>
                    <div id="fundingConditionBadge" class="status-badge"
                        style="background: #e5e7eb; color: #374151; font-size: 12px;">
                        Loading...
                    </div>
                    <div id="fundingConditionText"
                        style="font-size: 12px; color: #6b7280; margin-top: 10px; line-height: 1.5;">
                        This tab focuses on Funding Rate Skew strategy. When funding is positive, the bot prefers short
                        bias; when negative, it prefers long bias.
                    </div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card" style="grid-column: span 2;">
                    <h3>Funding Strategy Control</h3>
                    <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin-top: 5px;">
                        Âú®ËøôÈáå‰Ω†ÂèØ‰ª•Áõ¥Êé•ÂêØÂä® / ÂÅúÊ≠¢ BotÔºåÂπ∂‰∏ìÈó®‰∏∫ Funding Rate Skew Á≠ñÁï•Ë∞ÉÊï¥ÂèÇÊï∞„ÄÇ
                        Â∫ïÂ±Ç‰ªçÁÑ∂Â§çÁî®‰∏é Trade È°µÁõ∏ÂêåÁöÑÂêéÁ´ØÈÖçÁΩÆÊé•Âè£„ÄÇ
                    </p>

                    <!-- Bot Start / Stop -->
                    <div style="display: flex; gap: 10px; margin-top: 15px; margin-bottom: 10px;">
                        <button id="startFundingBtn" class="btn btn-success" onclick="startFundingBot()">Start
                            Bot</button>
                        <button id="stopFundingBtn" class="btn btn-danger" onclick="stopStrategyInstance('funding_rate')" disabled>Stop
                            Bot</button>

                    </div>

                    <hr>

                    <!-- Pair Select -->
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            Trading Pair (Funding Tab):
                            <select id="pairSelectFunding" onchange="updateFundingPair()"
                                style="padding: 5px; border-radius: 4px; margin-left: 5px;">
                                <option value="">Loading funding rates...</option>
                            </select>
                        </label>
                    </div>

                    <hr>

                    <!-- Funding-specific Parameters -->
                    <div style="margin-top: 10px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-size: 13px;">
                                Spread (%):
                                <input type="number" id="spreadFundingInput" step="0.001" value="0.002"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                            <label style="font-size: 13px;">
                                Qty:
                                <input type="number" id="qtyFundingInput" step="0.01" value="0.02"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                            <label style="font-size: 13px;">
                                Skew Factor:
                                <input type="number" id="skewFactorFundingInput" step="10" value="100"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                            Ë∞ÉÊï¥ÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆÔºå‰ºö‰ª• Funding Rate Skew Á≠ñÁï•Á±ªÂûãÊõ¥Êñ∞ÂêéÁ´ØÈÖçÁΩÆ„ÄÇ
                        </div>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateFundingConfig()">
                            Update Funding Config
                        </button>
                    </div>

                    <hr>

                    <!-- Leverage for Funding -->
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            Leverage (Funding):
                            <input type="number" id="leverageFundingInput" min="1" max="125" value="5"
                                style="margin-left: 5px; width: 80px;">
                        </label>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateFundingLeverage()">
                            Update Funding Leverage
                        </button>
                    </div>

                    <div style="margin-top: 15px; font-size: 12px; color: #6b7280;">
                        ÊèêÁ§∫ÔºöFunding Tab ÁöÑÂèÇÊï∞Êõ¥Êñ∞‰ºöÂêåÊ≠•Âà∞Â∫ïÂ±ÇÁ≠ñÁï•Ôºå‰Ω†‰πüÂèØ‰ª•Âú® Trade È°µÁúãÂà∞ÊïàÊûú„ÄÇ
                    </div>
                </div>

                <div class="card" style="grid-column: span 2;">
                    <h3>Funding Strategy Order History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="fundingHistoryStatusFilter" onchange="fetchFundingOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Status</option>
                            <option value="placed">Placed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="filled">Filled</option>
                        </select>
                        <select id="fundingHistoryTimeFilter" onchange="fetchFundingOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="fundingOrderHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Side</th>
                                    <th style="padding: 8px; text-align: right;">Price</th>
                                    <th style="padding: 8px; text-align: right;">Qty</th>
                                    <th style="padding: 8px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="fundingOrderHistoryBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">
                                        No funding strategy orders yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Funding Error History -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Funding Error History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="fundingErrorTypeFilter" onchange="fetchFundingErrorHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Types</option>
                            <option value="invalid_price">Invalid Price</option>
                            <option value="invalid_quantity">Invalid Quantity</option>
                            <option value="notional_below_min">Notional Too Small</option>
                            <option value="exchange_error">Exchange Error</option>
                        </select>
                        <select id="fundingErrorTimeFilter" onchange="fetchFundingErrorHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="fundingErrorHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Type</th>
                                    <th style="padding: 8px; text-align: left;">Message</th>
                                </tr>
                            </thead>
                            <tbody id="fundingErrorHistoryBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af;">
                                        No funding errors recorded
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Error Display for Funding Tab
                     ÊîæÂú® Funding Strategy Control + Order History ‰∏ãÈù¢ÔºåÈÅøÂÖçÊå§Âç†Âè≥‰æßÂ∏ÉÂ±Ä -->
                <div id="orderErrorDisplayFunding" class="card"
                    style="grid-column: span 2; display: none; background: #fef2f2; border-left: 4px solid #ef4444;">
                    <h3 style="color: #dc2626;">‚ö†Ô∏è API Error</h3>
                    <div id="orderErrorContentFunding" style="font-size: 13px; line-height: 1.6;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardTab" style="display: none;">
        <div class="header">
            <h1>Performance Dashboard</h1>
            <div style="text-align: right;">
                <button class="btn btn-success" onclick="fetchPerformance()">Refresh Data</button>
            </div>
        </div>

        <div class="card-grid">
            <!-- Key Business Metrics -->
            <div class="card">
                <h3>Realized PnL</h3>
                <div class="value" id="dashRealizedPnl" style="color: #7FC8B8;">--</div>
                <div class="sub-text">Gross Profit/Loss</div>
            </div>
            <div class="card">
                <h3>Trading Fees</h3>
                <div class="value" id="dashCommission" style="color: #FFD4A3;">--</div>
                <div class="sub-text">Total Commission Paid</div>
            </div>
            <div class="card">
                <h3>Net PnL</h3>
                <div class="value" id="dashNetPnl" style="color: #7FC8B8;">--</div>
                <div class="sub-text">After Fees</div>
            </div>
            <div class="card">
                <h3>Win Rate</h3>
                <div class="value" id="dashWinRate">--</div>
                <div class="sub-text">Winning Trades / Total</div>
            </div>
            <div class="card">
                <h3>Sharpe Ratio</h3>
                <div class="value" id="dashSharpe">--</div>
                <div class="sub-text">Risk-Adjusted Return</div>
            </div>
            <div class="card">
                <h3>Max Drawdown</h3>
                <div class="value" id="dashDrawdown" style="color: #FFB6C1;">--</div>
                <div class="sub-text">Peak to Trough Decline</div>
            </div>
        </div>

        <div class="card-grid" style="grid-template-columns: 2fr 1fr;">
            <!-- PnL Chart -->
            <div class="card">
                <h3>PnL Growth</h3>
                <canvas id="dashPnlChart" style="max-height: 300px;"></canvas>
            </div>
            <!-- Trade Distribution -->
            <div class="card">
                <h3>Trade Distribution</h3>
                <canvas id="dashTradeDistChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div class="card-grid">
            <!-- Operational Metrics -->
            <div class="card">
                <h3>
                    <span class="tooltip-container" data-term="Latency">
                        Tick-to-Trade Latency<span class="tooltip-icon">‚ÑπÔ∏è</span>
                        <div class="tooltip-content"></div>
                    </span>
                </h3>
                <div class="value" id="dashLatency">--</div>
                <div class="sub-text">Avg time to execute</div>
            </div>
            <div class="card">
                <h3>
                    <span class="tooltip-container" data-term="Fill Rate">
                        Fill Rate<span class="tooltip-icon">‚ÑπÔ∏è</span>
                        <div class="tooltip-content"></div>
                    </span>
                </h3>
                <div class="value" id="dashFillRate">--</div>
                <div class="sub-text">Filled / Placed Orders</div>
            </div>
            <div class="card">
                <h3>
                    <span class="tooltip-container" data-term="Slippage">
                        Slippage<span class="tooltip-icon">‚ÑπÔ∏è</span>
                        <div class="tooltip-content"></div>
                    </span>
                </h3>
                <div class="value" id="dashSlippage">--</div>
                <div class="sub-text">Avg execution slippage</div>
            </div>
            <div class="card">
                <h3>Total Trades</h3>
                <div class="value" id="dashTotalTrades">--</div>
                <div class="sub-text">Count of all trades</div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        // Tooltip definitions - Bilingual explanations for trading terms
        const tooltipDefinitions = {
            'PnL': {
                en: 'Profit and Loss. The difference between the current value and the initial investment.',
                cn: 'Áõà‰∫è„ÄÇÂΩìÂâç‰ª∑ÂÄº‰∏éÂàùÂßãÊäïËµÑÁöÑÂ∑ÆÈ¢ù„ÄÇ'
            },
            'Total PnL': {
                en: 'Total Profit and Loss. Cumulative realized gains/losses from all closed trades.',
                cn: 'ÊÄªÁõà‰∫è„ÄÇÊâÄÊúâÂ∑≤Âπ≥‰ªì‰∫§ÊòìÁöÑÁ¥ØËÆ°ÂÆûÁé∞Áõà‰∫è„ÄÇ'
            },
            'Net PnL': {
                en: 'Net Profit and Loss. Total PnL minus trading fees and commissions.',
                cn: 'ÂáÄÁõà‰∫è„ÄÇÊÄªÁõà‰∫èÂáèÂéª‰∫§ÊòìÊâãÁª≠Ë¥πÂíå‰Ω£Èáë„ÄÇ'
            },
            'Unrealized PnL': {
                en: 'Unrealized Profit and Loss. Potential profit/loss from open positions that haven\'t been closed yet.',
                cn: 'Êú™ÂÆûÁé∞Áõà‰∫è„ÄÇÊù•Ëá™Êú™Âπ≥‰ªìÂ§¥ÂØ∏ÁöÑÊΩúÂú®Áõà‰∫è„ÄÇ'
            },
            'Realized PnL': {
                en: 'Realized Profit and Loss. Actual profit/loss from closed trades.',
                cn: 'Â∑≤ÂÆûÁé∞Áõà‰∫è„ÄÇÊù•Ëá™Â∑≤Âπ≥‰ªì‰∫§ÊòìÁöÑÂÆûÈôÖÁõà‰∫è„ÄÇ'
            },
            'Leverage': {
                en: 'Leverage. The ratio of borrowed funds to your own capital. Higher leverage = higher risk and potential returns.',
                cn: 'Êù†ÊùÜ„ÄÇÂÄüÂÖ•ËµÑÈáë‰∏éËá™ÊúâËµÑÈáëÁöÑÊØî‰æã„ÄÇÊù†ÊùÜË∂äÈ´òÔºåÈ£éÈô©ÂíåÊΩúÂú®Êî∂ÁõäË∂äÂ§ß„ÄÇ'
            },
            'Funding Rate': {
                en: 'Funding Rate. Periodic fee paid between long and short positions. Positive = longs pay shorts, Negative = shorts pay longs.',
                cn: 'ËµÑÈáëË¥πÁéá„ÄÇÂ§öÁ©∫ÂèåÊñπÂÆöÊúüÊîØ‰ªòÁöÑË¥πÁî®„ÄÇÊ≠£Êï∞=Â§öÂ§¥ÊîØ‰ªòÁ©∫Â§¥ÔºåË¥üÊï∞=Á©∫Â§¥ÊîØ‰ªòÂ§öÂ§¥„ÄÇ'
            },
            'Est. Daily Yield': {
                en: 'Estimated Daily Yield. Expected daily return based on funding rate (funding occurs 3 times per day).',
                cn: 'È¢Ñ‰º∞Êó•Êî∂ÁõäÁéá„ÄÇÂü∫‰∫éËµÑÈáëË¥πÁéá‰º∞ÁÆóÁöÑÊó•Êî∂ÁõäÁéáÔºàËµÑÈáëË¥πÁéáÊØè8Â∞èÊó∂Êî∂Âèñ‰∏ÄÊ¨°Ôºå‰∏ÄÂ§©3Ê¨°Ôºâ„ÄÇ'
            },
            'Spread': {
                en: 'Spread. The difference between bid and ask prices. Your profit comes from this spread.',
                cn: '‰ª∑Â∑Æ„ÄÇ‰π∞‰ª∑ÂíåÂçñ‰ª∑‰πãÈó¥ÁöÑÂ∑ÆÈ¢ù„ÄÇÊÇ®ÁöÑÂà©Ê∂¶Êù•Ëá™Ëøô‰∏™‰ª∑Â∑Æ„ÄÇ'
            },
            'Position': {
                en: 'Position. Your current holdings in the trading pair. Positive = long, Negative = short.',
                cn: 'ÊåÅ‰ªì„ÄÇÊÇ®Âú®ÂΩìÂâç‰∫§ÊòìÂØπ‰∏≠ÁöÑÊåÅÊúâÈáè„ÄÇÊ≠£Êï∞=Â§öÂ§¥ÔºåË¥üÊï∞=Á©∫Â§¥„ÄÇ'
            },
            'Equity': {
                en: 'Equity. Total account value = Balance + Unrealized PnL.',
                cn: 'ÊùÉÁõä„ÄÇË¥¶Êà∑ÊÄª‰ª∑ÂÄº = ‰ΩôÈ¢ù + Êú™ÂÆûÁé∞Áõà‰∫è„ÄÇ'
            },
            'Balance': {
                en: 'Balance. Available USDT in your account.',
                cn: '‰ΩôÈ¢ù„ÄÇÊÇ®Ë¥¶Êà∑‰∏≠ÂèØÁî®ÁöÑ USDT„ÄÇ'
            },
            'Available': {
                en: 'Available Balance. Funds available for new trades (excludes margin used in open positions).',
                cn: 'ÂèØÁî®‰ΩôÈ¢ù„ÄÇÂèØÁî®‰∫éÊñ∞‰∫§ÊòìÁöÑËµÑÈáëÔºà‰∏çÂåÖÊã¨Â∑≤Áî®‰∫éÂºÄ‰ªìÁöÑ‰øùËØÅÈáëÔºâ„ÄÇ'
            },
            'Sharpe Ratio': {
                en: 'Sharpe Ratio. Risk-adjusted return metric. Higher = better risk-adjusted performance. >2 = excellent, >1 = good.',
                cn: 'Â§èÊôÆÊØîÁéá„ÄÇÈ£éÈô©Ë∞ÉÊï¥ÂêéÁöÑÊî∂ÁõäÊåáÊ†á„ÄÇÊï∞ÂÄºË∂äÈ´òÔºåÈ£éÈô©Ë∞ÉÊï¥ÂêéÁöÑË°®Áé∞Ë∂äÂ•Ω„ÄÇ>2=‰ºòÁßÄÔºå>1=ËâØÂ•Ω„ÄÇ'
            },
            'Portfolio Sharpe': {
                en: 'Portfolio Sharpe Ratio. Overall risk-adjusted performance across all strategies.',
                cn: 'ÁªÑÂêàÂ§èÊôÆÊØîÁéá„ÄÇÊâÄÊúâÁ≠ñÁï•ÁöÑÊï¥‰ΩìÈ£éÈô©Ë∞ÉÊï¥ÂêéË°®Áé∞„ÄÇ'
            },
            'Max Drawdown': {
                en: 'Max Drawdown. Largest peak-to-trough decline. Measures worst-case loss from a peak.',
                cn: 'ÊúÄÂ§ßÂõûÊí§„ÄÇ‰ªéÂ≥∞ÂÄºÂà∞Ë∞∑Â∫ïÁöÑÊúÄÂ§ßË∑åÂπÖ„ÄÇË°°Èáè‰ªéÂ≥∞ÂÄºÁöÑÊúÄÂùèÊÉÖÂÜµÊçüÂ§±„ÄÇ'
            },
            'Slippage': {
                en: 'Slippage. Difference between expected and actual execution price. Measured in basis points (bps).',
                cn: 'ÊªëÁÇπ„ÄÇÈ¢ÑÊúüÊâßË°å‰ª∑Ê†º‰∏éÂÆûÈôÖÊâßË°å‰ª∑Ê†ºÁöÑÂ∑ÆÈ¢ù„ÄÇ‰ª•Âü∫ÁÇπ(bps)‰∏∫Âçï‰Ωç„ÄÇ'
            },
            'Fill Rate': {
                en: 'Fill Rate. Percentage of placed orders that were successfully executed.',
                cn: 'Êàê‰∫§Áéá„ÄÇÊàêÂäüÊâßË°åÁöÑËÆ¢ÂçïÂç†‰∏ãÂçïÊÄªÊï∞ÁöÑÁôæÂàÜÊØî„ÄÇ'
            },
            'Latency': {
                en: 'Tick-to-Trade Latency. Time from market data update to order placement. Lower is better.',
                cn: '‰∫§ÊòìÂª∂Ëøü„ÄÇ‰ªéÂ∏ÇÂú∫Êï∞ÊçÆÊõ¥Êñ∞Âà∞‰∏ãÂçïÁöÑÊó∂Èó¥„ÄÇË∂ä‰ΩéË∂äÂ•Ω„ÄÇ'
            },
            'Win Rate': {
                en: 'Win Rate. Percentage of profitable trades out of total trades.',
                cn: 'ËÉúÁéá„ÄÇÁõàÂà©‰∫§ÊòìÂç†ÊÄª‰∫§ÊòìÊï∞ÁöÑÁôæÂàÜÊØî„ÄÇ'
            },
            'Skew Factor': {
                en: 'Skew Factor. Adjusts price bias based on funding rate. Higher = stronger bias adjustment.',
                cn: 'ÂÅèÊñúÂõ†Â≠ê„ÄÇÊ†πÊçÆËµÑÈáëË¥πÁéáË∞ÉÊï¥‰ª∑Ê†ºÂÅèÂêë„ÄÇÊï∞ÂÄºË∂äÈ´òÔºåÂÅèÂêëË∞ÉÊï¥Ë∂äÂº∫„ÄÇ'
            },
            'Notional': {
                en: 'Notional Value. Total value of the position = Position Size √ó Current Price.',
                cn: 'Âêç‰πâ‰ª∑ÂÄº„ÄÇÊåÅ‰ªìÊÄª‰ª∑ÂÄº = ÊåÅ‰ªìÈáè √ó ÂΩìÂâç‰ª∑Ê†º„ÄÇ'
            },
            'Liquidation Buffer': {
                en: 'Liquidation Buffer. Safety margin before forced liquidation. Below 10% = warning, below 5% = critical.',
                cn: 'Âº∫Âπ≥ÁºìÂÜ≤„ÄÇË∑ùÁ¶ªÂº∫Âà∂Âπ≥‰ªìÁöÑÂÆâÂÖ®Ë∑ùÁ¶ª„ÄÇ‰Ωé‰∫é10%ÈúÄË≠¶ÊÉïÔºå‰Ωé‰∫é5%ÈúÄÁ´ãÂç≥Ë°åÂä®„ÄÇ'
            },
            'Inventory Drift': {
                en: 'Inventory Drift. Position imbalance. Positive = net long, Negative = net short. Large drift = directional risk.',
                cn: 'Â∫ìÂ≠òÂÅèÁßª„ÄÇÊåÅ‰ªì‰∏çÂπ≥Ë°°Á®ãÂ∫¶„ÄÇÊ≠£ÂÄº=ÂáÄÂ§öÂ§¥ÔºåË¥üÂÄº=ÂáÄÁ©∫Â§¥„ÄÇÂÅèÁßªËøáÂ§ßÊÑèÂë≥ÁùÄÊñπÂêëÊÄßÈ£éÈô©„ÄÇ'
            },
            'Trading Fees': {
                en: 'Trading Fees. Total commission paid to the exchange for all trades.',
                cn: '‰∫§ÊòìÊâãÁª≠Ë¥π„ÄÇÊîØ‰ªòÁªô‰∫§ÊòìÊâÄÁöÑÊâÄÊúâ‰∫§ÊòìÁöÑ‰Ω£ÈáëÊÄªÈ¢ù„ÄÇ'
            }
        };

        // Function to initialize tooltips
        function initializeTooltips() {
            const containers = document.querySelectorAll('.tooltip-container[data-term]');
            
            containers.forEach(container => {
                const term = container.getAttribute('data-term');
                const def = tooltipDefinitions[term];
                if (def) {
                    const tooltipContent = container.querySelector('.tooltip-content');
                    if (tooltipContent) {
                        tooltipContent.innerHTML = `
                            <div class="tooltip-title">${term}</div>
                            <div class="tooltip-en">${def.en}</div>
                            <div class="tooltip-cn">${def.cn}</div>
                        `;
                        
                        // Add hover event to position tooltip dynamically (fixed positioning)
                        container.addEventListener('mouseenter', function(e) {
                            const tooltip = this.querySelector('.tooltip-content');
                            if (tooltip) {
                                const rect = this.getBoundingClientRect();
                                
                                // Position above the element by default
                                let top = rect.top - 10;
                                let left = rect.left + (rect.width / 2);
                                
                                // Get tooltip dimensions (need to make it visible temporarily)
                                tooltip.style.visibility = 'hidden';
                                tooltip.style.display = 'block';
                                const tooltipRect = tooltip.getBoundingClientRect();
                                tooltip.style.display = '';
                                
                                // Center horizontally
                                left = left - (tooltipRect.width / 2);
                                
                                // Adjust if tooltip goes off screen
                                if (left < 10) left = 10;
                                if (left + tooltipRect.width > window.innerWidth - 10) {
                                    left = window.innerWidth - tooltipRect.width - 10;
                                }
                                
                                // Position above, or below if no space
                                if (top - tooltipRect.height < 10) {
                                    top = rect.bottom + 10; // Show below
                                } else {
                                    top = top - tooltipRect.height - 10; // Show above
                                }
                                
                                tooltip.style.top = top + 'px';
                                tooltip.style.left = left + 'px';
                            }
                        });
                    }
                }
            });
        }

        function isTabVisible(tabId) {
            const el = document.getElementById(tabId);
            if (!el) return false;
            // ÈªòËÆ§Ê≤°ÊúâÊòæÂºè display ÁöÑËßÜ‰∏∫ÂèØËßÅ
            // ‰ΩøÁî® getComputedStyle Ëé∑ÂèñÂÆûÈôÖÁöÑ display ÂÄº
            const computedStyle = window.getComputedStyle(el);
            return computedStyle.display !== 'none';
        }

        function showTab(tabName) {
            document.getElementById('tradeTab').style.display = tabName === 'trade' ? 'block' : 'none';
            document.getElementById('fundingTab').style.display = tabName === 'funding' ? 'block' : 'none';
            document.getElementById('dashboardTab').style.display = tabName === 'dashboard' ? 'block' : 'none';

            // Update buttons
            document.getElementById('tradeTabBtn').className = tabName === 'trade' ? 'btn btn-primary' : 'btn';
            document.getElementById('fundingTabBtn').className = tabName === 'funding' ? 'btn btn-primary' : 'btn';
            document.getElementById('dashboardTabBtn').className = tabName === 'dashboard' ? 'btn btn-primary' : 'btn';

            // ‰∏çÂêå Tab ÂàáÊç¢Êó∂Ôºå‰∏ªÂä®Âà∑Êñ∞‰∏éÂΩìÂâçÁ≠ñÁï•Áõ∏ÂÖ≥ÁöÑÂÖ≥ÈîÆÊï∞ÊçÆÔºå‰øùËØÅÂÜ≥Á≠ñÊó∂ÁúãÂà∞ÁöÑÊòØÊúÄÊñ∞Áä∂ÊÄÅ
            if (tabName === 'trade') {
                // Fixed Spread Á≠ñÁï•ËßÜËßíÔºöÁä∂ÊÄÅ + Áª©Êïà + Âª∫ËÆÆ + ÂÖ®Â±ÄËÆ¢ÂçïÂéÜÂè≤
                fetchStatus();
                fetchPerformance();
                fetchSuggestions();
                fetchOrderHistory();
            } else if (tabName === 'dashboard') {
                // ÂàáÂà∞ Dashboard Êó∂Âà∑Êñ∞Áª©ÊïàÊï∞ÊçÆ
                fetchPerformance();
            } else if (tabName === 'funding') {
                // Funding Skew Á≠ñÁï•ËßÜËßíÔºöÁä∂ÊÄÅ + Áª©Êïà + Âª∫ËÆÆ + Funding ‰∏ìÁî®ËÆ¢ÂçïÂéÜÂè≤ + Âä®ÊÄÅ‰∫§ÊòìÂØπÂä†ËΩΩ
                fetchStatus();
                fetchPerformance();
                fetchSuggestions();
                fetchFundingOrderHistory();
                loadFundingPairs(); // Load funding rates and update pair dropdown
            }
        }

        function showToast(message, type = 'success') {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "toast show " + type;
            setTimeout(function () { x.className = x.className.replace("show", "").replace(type, ""); }, 3000);
        }

        function toggleStrategyParams() {
            const strategy = document.getElementById('strategySelect').value;
            const skewContainer = document.getElementById('skewFactorContainer');
            if (strategy === 'funding_rate') {
                skewContainer.style.display = 'block';
            } else {
                skewContainer.style.display = 'none';
            }
        }



        async function startFixedSpreadBot() {
            // Á°Æ‰øùÂΩìÂâçÁ≠ñÁï•‰∏∫ Fixed SpreadÔºåÂπ∂‰ΩøÁî® Trade Tab ‰∏äÁöÑÂèÇÊï∞
            const strategySelect = document.getElementById('strategySelect');
            if (strategySelect) {
                strategySelect.value = 'fixed_spread';
                toggleStrategyParams();
            }
            // Áõ¥Êé•Áî®‰∏ªÊéßÂà∂Èù¢ÊùøÂΩìÂâçÂèÇÊï∞Êõ¥Êñ∞ÈÖçÁΩÆÔºåÁÑ∂ÂêéÂêØÂä®Á≠ñÁï•ÂÆû‰æã
            const configResult = await updateConfig();
            if (configResult && configResult.error) {
                showToast('ÈÖçÁΩÆÊõ¥Êñ∞Â§±Ë¥•: ' + configResult.error, 'error');
                return;
            }
            // ÂêØÂä® fixed_spread Á≠ñÁï•ÂÆû‰æã
            await startStrategyInstance('fixed_spread');
        }

        async function startFundingBot() {
            // Â∞Ü Funding Tab ‰∏äÁöÑÂèÇÊï∞ÂêåÊ≠•Âà∞‰∏ªÊéßÂà∂Èù¢ÊùøËæìÂÖ•
            const spreadFundingInput = document.getElementById('spreadFundingInput');
            const qtyFundingInput = document.getElementById('qtyFundingInput');
            const skewFactorFundingInput = document.getElementById('skewFactorFundingInput');

            const mainSpread = document.getElementById('spreadInput');
            const mainQty = document.getElementById('qtyInput');
            const mainSkew = document.getElementById('skewFactorInput');
            const strategySelect = document.getElementById('strategySelect');

            if (spreadFundingInput && mainSpread) {
                mainSpread.value = spreadFundingInput.value;
            }
            if (qtyFundingInput && mainQty) {
                mainQty.value = qtyFundingInput.value;
            }
            if (skewFactorFundingInput && mainSkew) {
                mainSkew.value = skewFactorFundingInput.value;
            }
            if (strategySelect) {
                strategySelect.value = 'funding_rate';
                toggleStrategyParams();
            }

            // ‰ª• Funding Rate Á≠ñÁï•Êõ¥Êñ∞ÈÖçÁΩÆÂπ∂ÂêØÂä®Á≠ñÁï•ÂÆû‰æã
            await updateFundingConfig();
            // ÂêØÂä® funding_rate Á≠ñÁï•ÂÆû‰æã
            await startStrategyInstance('funding_rate');
        }

        async function fetchStatus() {
            // Skip if already fetching
            if (statusFetching) return;
            
            statusFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout for status
                
                const res = await fetch('/api/status', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();

                if (data.error) return;

                document.getElementById('midPrice').innerText = data.mid_price ? data.mid_price.toFixed(2) : '--';
                document.getElementById('position').innerText = data.position;
                
                // Update Account Overview
                const balance = data.balance ? parseFloat(data.balance) : 0;
                const unrealizedPnl = data.pnl ? parseFloat(data.pnl) : 0;
                const equity = balance + unrealizedPnl;
                
                document.getElementById('balance').innerText = balance > 0 ? balance.toFixed(2) : '--';
                document.getElementById('pnl').innerText = unrealizedPnl !== 0 ? (unrealizedPnl >= 0 ? '+' : '') + unrealizedPnl.toFixed(4) : '--';
                
                // Update Equity (Balance + Unrealized PnL)
                const equityEl = document.getElementById('equity');
                if (equityEl) {
                    equityEl.innerText = equity > 0 ? equity.toFixed(2) : '--';
                    equityEl.style.color = equity >= balance ? '#7FC8B8' : '#FFB6C1';
                }
                
                const currentSymbol = data.symbol || '--';
                document.getElementById('currentSymbol').innerText = currentSymbol;

                // Update order history symbol filter when symbol changes
                if (currentSymbol && currentSymbol !== '--') {
                    updateOrderHistorySymbolFilter(currentSymbol);
                }

                // Mirror into Funding tab: symbol, position, notional
                const currentSymbolFunding = document.getElementById('currentSymbolFunding');
                if (currentSymbolFunding) {
                    currentSymbolFunding.innerText = data.symbol || '--';
                }
                const positionFunding = document.getElementById('positionFunding');
                const notionalFunding = document.getElementById('notionalFunding');
                if (positionFunding) {
                    positionFunding.innerText = data.position;
                }
                if (notionalFunding && data.mid_price && data.position !== undefined) {
                    const notional = data.mid_price * data.position;
                    notionalFunding.innerText = notional.toFixed(2) + ' USDT';
                }

                // Update Funding Rate and Yield
                if (data.funding_rate !== undefined) {
                    const rate = data.funding_rate * 100;
                    const fundingRateEl = document.getElementById('fundingRate');
                    const dailyYieldEl = document.getElementById('dailyYield');
                    
                    if (fundingRateEl) {
                        fundingRateEl.innerText = rate.toFixed(4) + '%';
                    }
                    if (dailyYieldEl) {
                        const dailyYield = rate * 3;
                        dailyYieldEl.innerText = dailyYield.toFixed(4) + '%';
                        // Color code daily yield: Pink = paying, Green = receiving
                        if (dailyYield > 0) dailyYieldEl.style.color = '#FFB6C1';
                        else if (dailyYield < 0) dailyYieldEl.style.color = '#7FC8B8';
                        else dailyYieldEl.style.color = '#8B7A8B';
                    }

                    // Funding tab mirrors funding metrics
                    const fundingRateFunding = document.getElementById('fundingRateFunding');
                    const dailyFundingYield = document.getElementById('dailyFundingYield');
                    if (fundingRateFunding) {
                        fundingRateFunding.innerText = rate.toFixed(4) + '%';
                        // Color code for funding tab
                        if (rate > 0) fundingRateFunding.style.color = '#FFB6C1';
                        else if (rate < 0) fundingRateFunding.style.color = '#7FC8B8';
                        else fundingRateFunding.style.color = '#8B7A8B';
                    }
                    if (dailyFundingYield) {
                        const dailyYield = rate * 3;
                        dailyFundingYield.innerText = dailyYield.toFixed(4) + '%';
                        // Color code for daily yield
                        if (dailyYield > 0) dailyFundingYield.style.color = '#FFB6C1';
                        else if (dailyYield < 0) dailyFundingYield.style.color = '#7FC8B8';
                        else dailyFundingYield.style.color = '#8B7A8B';
                    }

                    // Color code funding rate
                    const fundingElem = document.getElementById('fundingRate');
                    if (rate > 0) fundingElem.style.color = '#FFB6C1'; // Pink (paying)
                    else if (rate < 0) fundingElem.style.color = '#7FC8B8'; // Green (receiving)
                    else fundingElem.style.color = '#8B7A8B';

                    // Funding condition badge
                    const conditionBadge = document.getElementById('fundingConditionBadge');
                    const conditionText = document.getElementById('fundingConditionText');
                    if (conditionBadge && conditionText) {
                        let conditionLabel = 'Neutral Funding';
                        let badgeBg = '#e5e7eb';
                        let badgeColor = '#374151';
                        if (rate > 0.03) {
                            conditionLabel = 'Positive Funding (Short-biased)';
                            badgeBg = '#fee2e2';
                            badgeColor = '#991b1b';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéá‰∏∫Ê≠£ÔºåÁ©∫Â§¥‰∏Ä‰æßËé∑ÂæóËµÑÈáëË¥πÁî®ÔºåÁ≠ñÁï•ÂèØ‰ª•ÈÄÇÂΩìÂÅèÁ©∫ÔºàÂçñÂá∫‰∏Ä‰æßÊõ¥ÁßØÊûÅÊä•‰ª∑Ôºâ„ÄÇ';
                        } else if (rate < -0.03) {
                            conditionLabel = 'Negative Funding (Long-biased)';
                            badgeBg = '#d1fae5';
                            badgeColor = '#065f46';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéá‰∏∫Ë¥üÔºåÂ§öÂ§¥‰∏Ä‰æßËé∑ÂæóËµÑÈáëË¥πÁî®ÔºåÁ≠ñÁï•ÂèØ‰ª•ÈÄÇÂΩìÂÅèÂ§öÔºà‰π∞ÂÖ•‰∏Ä‰æßÊõ¥ÁßØÊûÅÊä•‰ª∑Ôºâ„ÄÇ';
                        } else {
                            conditionLabel = 'Near-Neutral Funding';
                            badgeBg = '#e5e7eb';
                            badgeColor = '#374151';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéáÊé•Ëøë‰∏≠ÊÄßÔºåÂèØ‰ª•ËßÜ‰∏∫ÊôÆÈÄöÂÅöÂ∏ÇÁéØÂ¢ÉÔºå‰ª•Âü∫Á°Ä Fixed Spread ÈÖçÁΩÆ‰∏∫‰∏ª„ÄÇ';
                        }
                        conditionBadge.innerText = conditionLabel;
                        conditionBadge.style.backgroundColor = badgeBg;
                        conditionBadge.style.color = badgeColor;
                    }
                }

                // Update Strategy UI if not focused (to avoid overwriting user input while typing)
                const strategySelect = document.getElementById('strategySelect');
                if (document.activeElement !== strategySelect && data.strategy_type) {
                    strategySelect.value = data.strategy_type;
                    toggleStrategyParams();
                }

                const skewInput = document.getElementById('skewFactorInput');
                const skewFundingInput = document.getElementById('skewFactorFundingInput');
                if (document.activeElement !== skewInput && data.skew_factor !== undefined) {
                    skewInput.value = data.skew_factor;
                }
                if (skewFundingInput && document.activeElement !== skewFundingInput && data.skew_factor !== undefined) {
                    skewFundingInput.value = data.skew_factor;
                }

                // Sync spread & qty from backend into both tabsÔºå‰øùËØÅÁúãÂà∞ÁöÑÊòØÂºïÊìéÂΩìÂâçÁúüÂÆûÈÖçÁΩÆ
                const spreadInput = document.getElementById('spreadInput');
                const spreadFundingInput = document.getElementById('spreadFundingInput');
                const qtyInputEl = document.getElementById('qtyInput');
                const qtyFundingInput = document.getElementById('qtyFundingInput');
                const spreadFunding = document.getElementById('spreadFunding');
                const skewFunding = document.getElementById('skewFunding');

                if (data.spread !== undefined && data.spread !== null) {
                    const spreadPct = data.spread * 100;
                    // ‰∏ªÊéßÂà∂Èù¢ÊùøËæìÂÖ•ÔºàÈÅøÂÖçÊâìÂ≠óÊó∂Ë¢´Ë¶ÜÁõñÔºâ
                    if (spreadInput && document.activeElement !== spreadInput) {
                        spreadInput.value = spreadPct.toFixed(3);
                    }
                    // Funding Tab ËæìÂÖ•
                    if (spreadFundingInput && document.activeElement !== spreadFundingInput) {
                        spreadFundingInput.value = spreadPct.toFixed(3);
                    }
                    // Funding Tab ÁöÑ„ÄåSpread & Skew„ÄçÂ±ïÁ§∫Âç°Áâá
                    if (spreadFunding) {
                        spreadFunding.innerText = spreadPct.toFixed(3) + '%';
                    }
                }

                if (data.quantity !== undefined && data.quantity !== null) {
                    if (qtyInputEl && document.activeElement !== qtyInputEl) {
                        qtyInputEl.value = data.quantity;
                    }
                    if (qtyFundingInput && document.activeElement !== qtyFundingInput) {
                        qtyFundingInput.value = data.quantity;
                    }
                }

                if (skewFunding && data.skew_factor !== undefined) {
                    skewFunding.innerText = data.skew_factor;
                }

                // Update Leverage Input Max and Value if not focused
                const leverageInput = document.getElementById('leverageInput');
                const leverageFundingInput = document.getElementById('leverageFundingInput');
                if (data.max_leverage) {
                    leverageInput.max = data.max_leverage;
                    if (leverageFundingInput) {
                        leverageFundingInput.max = data.max_leverage;
                    }
                    document.getElementById('leverageRange').innerText = `1-${data.max_leverage}`;
                }
                if (document.activeElement !== leverageInput && data.leverage) {
                    leverageInput.value = data.leverage;
                }
                if (leverageFundingInput && document.activeElement !== leverageFundingInput && data.leverage) {
                    leverageFundingInput.value = data.leverage;
                }

                // Update Qty Input Limits
                if (data.limits) {
                    if (data.limits.minQty && qtyInputEl) qtyInputEl.min = data.limits.minQty;
                    if (data.limits.stepSize && qtyInputEl) qtyInputEl.step = data.limits.stepSize;
                    if (data.limits.maxQty && qtyInputEl) qtyInputEl.max = Math.min(data.limits.maxQty, 1000); // Cap at 1000 for UI

                    // Update Binance Constraints Display with proper formatting
                    const formatNumber = (value) => {
                        if (value === null || value === undefined) return '--';
                        if (value >= 1) return value.toFixed(2);
                        if (value >= 0.01) return value.toFixed(4);
                        if (value >= 0.001) return value.toFixed(6);
                        return value.toExponential(2);
                    };
                    
                    document.getElementById('constraintMinQty').innerText = formatNumber(data.limits.minQty);
                    document.getElementById('constraintMaxQty').innerText = formatNumber(data.limits.maxQty);
                    document.getElementById('constraintStepSize').innerText = formatNumber(data.limits.stepSize);
                    document.getElementById('constraintMinNotional').innerText = data.limits.minNotional ? data.limits.minNotional.toFixed(2) + ' USDT' : '--';
                } else {
                    // If limits not available, show placeholders
                    document.getElementById('constraintMinQty').innerText = '--';
                    document.getElementById('constraintMaxQty').innerText = '--';
                    document.getElementById('constraintStepSize').innerText = '--';
                    document.getElementById('constraintMinNotional').innerText = '--';
                }

                // Update Internal Constraints Display
                document.getElementById('constraintMaxPos').innerText = '0.5';  // From config.py MAX_POSITION
                document.getElementById('constraintLeverage').innerText = data.leverage ? data.leverage + 'x' : '--';

                const constraintSpread = document.getElementById('constraintSpread');
                const constraintQty = document.getElementById('constraintQty');
                if (constraintSpread) {
                    if (data.spread !== undefined && data.spread !== null) {
                        const spreadPct = data.spread * 100;
                        constraintSpread.innerText = spreadPct.toFixed(3) + '%';
                    } else if (spreadInput) {
                        constraintSpread.innerText = spreadInput.value + '%';
                    }
                }
                if (constraintQty) {
                    let qtyValue = null;
                    if (data.quantity !== undefined && data.quantity !== null) {
                        qtyValue = data.quantity;
                    } else if (qtyInputEl) {
                        qtyValue = parseFloat(qtyInputEl.value);
                    }
                    if (qtyValue !== null && !isNaN(qtyValue)) {
                        // Format quantity display: show up to 4 decimal places if needed
                        if (qtyValue >= 1) {
                            constraintQty.innerText = qtyValue.toFixed(2);
                        } else if (qtyValue >= 0.01) {
                            constraintQty.innerText = qtyValue.toFixed(4);
                        } else {
                            constraintQty.innerText = qtyValue.toFixed(6);
                        }
                    } else {
                        constraintQty.innerText = '--';
                    }
                }

                const statusBadge = document.getElementById('botStatus');
                const statusBadgeFunding = document.getElementById('botStatusFunding');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const startFundingBtn = document.getElementById('startFundingBtn');
                const stopFundingBtn = document.getElementById('stopFundingBtn');

                // Update error display (if exists - declared later)
                const mainErrorDisplay = document.getElementById('errorDisplay');
                if (data.error && mainErrorDisplay) {
                    mainErrorDisplay.textContent = data.error;
                    mainErrorDisplay.style.display = 'block';
                    statusBadge.innerText = "ERROR";
                    statusBadge.className = "status-badge status-error";
                    if (statusBadgeFunding) {
                        statusBadgeFunding.innerText = "ERROR";
                        statusBadgeFunding.className = "status-badge status-error";
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    if (startFundingBtn && stopFundingBtn) {
                        startFundingBtn.disabled = false;
                        stopFundingBtn.disabled = true;
                    }
                    return;
                } else if (mainErrorDisplay) {
                    mainErrorDisplay.style.display = 'none';
                }

                // Update status badges and buttons based on strategy instance running states
                // Check strategy instance status (isolated control)
                let fixedSpreadRunning = false;
                let fundingRateRunning = false;
                
                if (data.strategy_instance_status) {
                    // Use strategy instance status if available
                    fixedSpreadRunning = data.strategy_instance_status.fixed_spread || false;
                    fundingRateRunning = data.strategy_instance_status.funding_rate || false;
                } else {
                    // Fallback: Use global active state only if strategy_instance_status is not available
                    // But we need to determine which strategy is active based on strategy_type
                    if (data.active) {
                        const currentStrategyType = data.strategy_type || 'fixed_spread';
                        if (currentStrategyType === 'fixed_spread') {
                            fixedSpreadRunning = true;
                            fundingRateRunning = false;
                        } else if (currentStrategyType === 'funding_rate') {
                            fixedSpreadRunning = false;
                            fundingRateRunning = true;
                        } else {
                            // Unknown strategy type, disable both
                            fixedSpreadRunning = false;
                            fundingRateRunning = false;
                        }
                    }
                }
                
                // Update Fixed Spread buttons
                if (statusBadge) {
                    if (fixedSpreadRunning) {
                        statusBadge.innerText = "RUNNING";
                        statusBadge.className = "status-badge status-active";
                    } else {
                        statusBadge.innerText = "STOPPED";
                        statusBadge.className = "status-badge status-inactive";
                    }
                }
                if (startBtn) startBtn.disabled = fixedSpreadRunning;
                if (stopBtn) stopBtn.disabled = !fixedSpreadRunning;
                
                // Update Funding Rate buttons
                if (statusBadgeFunding) {
                    if (fundingRateRunning) {
                        statusBadgeFunding.innerText = "RUNNING";
                        statusBadgeFunding.className = "status-badge status-active";
                    } else {
                        statusBadgeFunding.innerText = "STOPPED";
                        statusBadgeFunding.className = "status-badge status-inactive";
                    }
                }
                if (startFundingBtn) startFundingBtn.disabled = fundingRateRunning;
                if (stopFundingBtn) stopFundingBtn.disabled = !fundingRateRunning;

                // Update Stage Display
                const stageDisplay = document.getElementById('stageDisplay');
                const stageDisplayFunding = document.getElementById('stageDisplayFunding');
                if (data.stage) {
                    stageDisplay.innerText = data.stage;
                    if (stageDisplayFunding) {
                        stageDisplayFunding.innerText = data.stage;
                    }

                    // Highlight Risk Check
                    if (data.stage === 'Risk Check') {
                        stageDisplay.style.color = '#d97706'; // Amber
                        stageDisplay.innerText = '‚ö†Ô∏è Risk Checking...';
                        if (stageDisplayFunding) {
                            stageDisplayFunding.style.color = '#d97706';
                            stageDisplayFunding.innerText = '‚ö†Ô∏è Risk Checking...';
                        }
                    } else if (data.stage === 'Execution') {
                        stageDisplay.style.color = '#7FC8B8'; // Green
                        if (stageDisplayFunding) {
                            stageDisplayFunding.style.color = '#7FC8B8';
                        }
                    } else {
                        stageDisplay.style.color = '#6b7280'; // Gray
                        if (stageDisplayFunding) {
                            stageDisplayFunding.style.color = '#6b7280';
                        }
                    }
                }

                // Update System Logs
                const logsContainer = document.getElementById('systemLogs');
                if (data.logs && data.logs.length > 0) {
                    logsContainer.innerHTML = ''; // Clear current
                    data.logs.forEach(log => {
                        const line = document.createElement('div');
                        line.innerHTML = `<span style="color: #6b7280;">[${log.timestamp}]</span> <b>${log.stage}</b>`;
                        logsContainer.appendChild(line);
                    });
                    // Auto-scroll to bottom
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }

                // Update Order Error Display (both Trade and Funding tabs)
                const orderErrorDisplay = document.getElementById('orderErrorDisplay');
                const orderErrorContent = document.getElementById('orderErrorContent');
                const orderErrorDisplayFunding = document.getElementById('orderErrorDisplayFunding');
                const orderErrorContentFunding = document.getElementById('orderErrorContentFunding');
                
                if (data.last_error && data.last_error.message) {
                    // ÊòæÁ§∫ÈîôËØØÂØπÂ∫îÁöÑ‰∫§ÊòìÂØπ
                    const errorSymbol = data.last_error.symbol || 'Unknown';
                    let errorHtml = `<div style="margin-bottom: 8px;"><strong>Symbol:</strong> ${errorSymbol}</div>`;
                    errorHtml += `<div style="margin-bottom: 8px;"><strong>Type:</strong> ${data.last_error.type}</div>`;
                    errorHtml += `<div style="margin-bottom: 8px;"><strong>Message:</strong> ${data.last_error.message}</div>`;
                    if (data.last_error.details) {
                        errorHtml += `<div style="font-size: 11px; color: #991b1b; margin-top: 5px;">${data.last_error.details}</div>`;
                    }
                    // Update Trade tab error display
                    if (orderErrorContent) orderErrorContent.innerHTML = errorHtml;
                    if (orderErrorDisplay) orderErrorDisplay.style.display = 'block';
                    // Update Funding tab error display
                    if (orderErrorContentFunding) orderErrorContentFunding.innerHTML = errorHtml;
                    if (orderErrorDisplayFunding) orderErrorDisplayFunding.style.display = 'block';
                } else {
                    if (orderErrorDisplay) orderErrorDisplay.style.display = 'none';
                    if (orderErrorDisplayFunding) orderErrorDisplayFunding.style.display = 'none';
                }

            // Update Alert Display
            const alertDisplay = document.getElementById('alertDisplay');
            if (data.alert) {
                document.getElementById('alertMessage').innerText = data.alert.message;

                let suggestionHtml = `<div style="margin-top: 5px;">${data.alert.suggestion || ''}</div>`;

                // Check for structured suggestions options
                if (data.alert.options) {
                    suggestionHtml += `<div style="display: flex; gap: 5px; margin-top: 10px;">`;
                    data.alert.options.forEach(opt => {
                        suggestionHtml += `
                                <button class="btn" style="padding: 5px 10px; font-size: 11px; background: #fff; border: 1px solid #d1d5db;"
                                    onclick="applySuggestionOption(${opt.spread})">
                                    <strong>${opt.label}</strong><br>${(opt.spread * 100).toFixed(2)}%
                                </button>
                            `;
                    });
                    suggestionHtml += `</div>`;
                }

                document.getElementById('alertSuggestion').innerHTML = suggestionHtml;
                alertDisplay.style.display = 'block';
            } else {
                alertDisplay.style.display = 'none';
            }

            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';
            data.orders.forEach(o => {
                const row = `<tr><td>${o.id}</td><td>${o.side}</td><td>${o.price}</td><td>${o.amount}</td></tr>`;
                tbody.innerHTML += row;
            });

        } catch (e) {
            if (e.name !== 'AbortError') {
                console.error('Error fetching status:', e);
            }
        } finally {
            statusFetching = false;
        }
        }

        async function controlBot(action) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const startFundingBtn = document.getElementById('startFundingBtn');
            const stopFundingBtn = document.getElementById('stopFundingBtn');

            // Immediately update button states for responsive feedback
            if (action === 'start') {
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.innerText = 'Starting...';
                }
                if (startFundingBtn) {
                    startFundingBtn.disabled = true;
                    startFundingBtn.innerText = 'Starting...';
                }
            } else {
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.innerText = 'Stopping...';
                }
                if (stopFundingBtn) {
                    stopFundingBtn.disabled = true;
                    stopFundingBtn.innerText = 'Stopping...';
                }
            }

            try {
                await fetch(`/api/control?action=${action}`, { method: 'POST' });
                fetchStatus();
            } catch (e) {
                console.error(e);
            } finally {
                // Reset button text
                if (startBtn) startBtn.innerText = 'Start Bot';
                if (stopBtn) stopBtn.innerText = 'Stop Bot';
                if (startFundingBtn) startFundingBtn.innerText = 'Start Bot';
                if (stopFundingBtn) stopFundingBtn.innerText = 'Stop Bot';
            }
        }

        // Validate Quantity input
        function validateQuantity() {
            const qtyInput = document.getElementById('qtyInput');
            if (!qtyInput) return;
            
            let value = parseFloat(qtyInput.value);
            if (isNaN(value) || value <= 0) {
                qtyInput.value = '0.02';
                showToast('Quantity must be greater than 0', 'error');
                return;
            }
            if (value > 1000) {
                qtyInput.value = '1000';
                showToast('Quantity cannot exceed 1000', 'error');
                return;
            }
            if (value < 0.001) {
                qtyInput.value = '0.001';
                showToast('Quantity must be at least 0.001', 'error');
                return;
            }
        }

        async function updateConfig() {
            const spread = parseFloat(document.getElementById('spreadInput').value);
            const qtyInput = document.getElementById('qtyInput');
            let qty = parseFloat(qtyInput.value);
            const strategy = document.getElementById('strategySelect').value;
            const skewFactor = parseFloat(document.getElementById('skewFactorInput').value);

            // Validate quantity before sending
            if (isNaN(qty) || qty <= 0 || qty > 1000) {
                showToast('Invalid quantity. Please enter a value between 0.001 and 1000', 'error');
                qtyInput.value = '0.02';
                return { error: 'Invalid quantity' };
            }

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spread,
                        quantity: qty,
                        strategy_type: strategy,
                        skew_factor: skewFactor
                    })
                });

                const data = await res.json();

                if (data.error) {
                    showToast(data.error, 'error');
                    return data;
                } else {
                    showToast('Config Updated Successfully!', 'success');
                    // Clear alert display if it was showing
                    const alertDisplay = document.getElementById('alertDisplay');
                    if (alertDisplay) alertDisplay.style.display = 'none';
                    return data;
                }
            } catch (e) {
                console.error('Error updating config:', e);
                showToast('Êõ¥Êñ∞ÈÖçÁΩÆÂ§±Ë¥•', 'error');
                return { error: 'Êõ¥Êñ∞ÈÖçÁΩÆÂ§±Ë¥•: ' + e.message };
            }
        }

        async function updateFundingConfig() {
            const spreadInput = document.getElementById('spreadFundingInput');
            const qtyInput = document.getElementById('qtyFundingInput');
            const skewInput = document.getElementById('skewFactorFundingInput');

            const spread = parseFloat(spreadInput.value);
            const qty = parseFloat(qtyInput.value);
            const skewFactor = parseFloat(skewInput.value);
            const strategy = 'funding_rate';

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spread,
                        quantity: qty,
                        strategy_type: strategy,
                        skew_factor: skewFactor
                    })
                });

                const data = await res.json();

                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('Funding Config Updated Successfully!', 'success');
                    // ÂêåÊ≠•‰∏ªÊéßÂà∂Èù¢ÊùøÁöÑËæìÂÖ•ÂÄº‰∏éÁ≠ñÁï•ÈÄâÊã©
                    const mainSpread = document.getElementById('spreadInput');
                    const mainQty = document.getElementById('qtyInput');
                    const mainSkew = document.getElementById('skewFactorInput');
                    const strategySelect = document.getElementById('strategySelect');
                    if (mainSpread) mainSpread.value = spreadInput.value;
                    if (mainQty) mainQty.value = qtyInput.value;
                    if (mainSkew) mainSkew.value = skewInput.value;
                    if (strategySelect) {
                        strategySelect.value = strategy;
                        toggleStrategyParams();
                    }
                    document.getElementById('alertDisplay').style.display = 'none';
                }
            } catch (e) {
                showToast('Network Error', 'error');
            }
        }

        async function updateLeverage() {
            const leverage = parseInt(document.getElementById('leverageInput').value);
            if (leverage < 1 || leverage > 125) {
                showToast('Leverage must be between 1 and 125', 'error');
                return;
            }
            const res = await fetch('/api/leverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leverage)
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Leverage updated to ' + leverage + 'x', 'success');
                // Wait a bit for backend to update status
                await new Promise(resolve => setTimeout(resolve, 500));
                fetchStatus();
            }
        }

        async function updateFundingLeverage() {
            const leverageInputFunding = document.getElementById('leverageFundingInput');
            const leverage = parseInt(leverageInputFunding.value);
            if (leverage < 1 || leverage > 125) {
                showToast('Leverage must be between 1 and 125', 'error');
                return;
            }
            const res = await fetch('/api/leverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leverage)
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Leverage updated to ' + leverage + 'x', 'success');
                // ÂêåÊ≠•‰∏ªÊéßÂà∂Èù¢ÊùøÁöÑÊù†ÊùÜËæìÂÖ•
                const mainLev = document.getElementById('leverageInput');
                if (mainLev) mainLev.value = leverageInputFunding.value;
                await new Promise(resolve => setTimeout(resolve, 500));
                fetchStatus();
            }
        }

        // Update order history symbol filter dropdown with current trading pairs
        function updateOrderHistorySymbolFilter(currentSymbol) {
            const symbolFilter = document.getElementById('historySymbolFilter');
            if (!symbolFilter) return;
            
            // Get all available trading pairs from pairSelect
            const pairSelect = document.getElementById('pairSelect');
            if (!pairSelect) return;
            
            // Build options list
            let optionsHTML = '<option value="">All Symbols</option>';
            const existingOptions = new Set();
            
            // Add current symbol first (if not already added)
            if (currentSymbol && !existingOptions.has(currentSymbol)) {
                const displayName = currentSymbol.replace(':USDT', '').replace('/USDT', '');
                optionsHTML += `<option value="${currentSymbol}" selected>${displayName}</option>`;
                existingOptions.add(currentSymbol);
            }
            
            // Add all pairs from pairSelect
            for (let i = 0; i < pairSelect.options.length; i++) {
                const option = pairSelect.options[i];
                if (option.value && !existingOptions.has(option.value)) {
                    const displayName = option.value.replace(':USDT', '').replace('/USDT', '');
                    optionsHTML += `<option value="${option.value}">${displayName}</option>`;
                    existingOptions.add(option.value);
                }
            }
            
            symbolFilter.innerHTML = optionsHTML;
            
            // Set current symbol as selected
            if (currentSymbol) {
                symbolFilter.value = currentSymbol;
            }
        }

        async function updatePair(silent = false) {
            const symbol = document.getElementById('pairSelect').value;
            if (!symbol) return;
            
            const res = await fetch('/api/pair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });
            const result = await res.json();
            if (result.error) {
                if (!silent) {
                    showToast('Error: ' + result.error, 'error');
                }
            } else {
                if (!silent) {
                    showToast('Switched to ' + symbol, 'success');
                }
                
                // Update order history symbol filter to current pair
                updateOrderHistorySymbolFilter(symbol);
                
                // Refresh all data related to the trading pair (run in parallel for faster UX)
                const coreFetches = [
                    fetchStatus(),
                    fetchOrderHistory(),
                    fetchSuggestions(),
                    fetchPortfolio()
                ];
                
                if (isTabVisible('dashboardTab') || isTabVisible('tradeTab')) {
                    coreFetches.push(fetchPerformance());
                }
                
                if (isTabVisible('dashboardTab')) {
                    coreFetches.push(fetchRiskIndicators());
                }
                
                await Promise.allSettled(coreFetches);
            }
        }

        async function updateFundingPair() {
            const fundingSelect = document.getElementById('pairSelectFunding');
            if (!fundingSelect) return;
            const symbol = fundingSelect.value;
            if (!symbol) return;

            // Note: Currently, all strategy instances share the same exchange,
            // so changing the pair affects all strategies. This is a backend limitation.
            // We do NOT sync the main control panel's pair selector to maintain visual separation.

            const res = await fetch('/api/pair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Switched to ' + symbol, 'success');
                
                // Update order history symbol filter to current pair
                updateOrderHistorySymbolFilter(symbol);
                
                // Refresh all data related to the trading pair (parallel to reduce wait)
                const sharedFetches = [
                    fetchStatus(),
                    fetchOrderHistory(),
                    fetchSuggestions(),
                    fetchPortfolio()
                ];
                
                const fundingFetches = [
                    fetchFundingOrderHistory()
                ];
                
                if (isTabVisible('dashboardTab') || isTabVisible('fundingTab')) {
                    fundingFetches.push(fetchPerformance());
                }
                
                if (isTabVisible('dashboardTab')) {
                    fundingFetches.push(fetchRiskIndicators());
                }
                
                await Promise.allSettled([...sharedFetches, ...fundingFetches]);
            }
        }

        let currentSuggestion = null;
        let suggestionsLoaded = false;
        let suggestionsFetching = false;
        let evaluationState = {
            loading: false,
            results: [],
            aggregated: null,
            lastError: null,
            lastRunSymbol: null,
            lastRunAt: null,
        };

        async function fetchSuggestions() {
            // Skip if already fetching
            if (suggestionsFetching) return;
            
            // ÂàùÊ¨°Âä†ËΩΩÊó∂Ë∑≥ËøáÂèØËßÅÊÄßÊ£ÄÊü•ÔºåÁ°Æ‰øùÊï∞ÊçÆËÉΩË¢´Ëé∑Âèñ
            // ‰πãÂêéÁöÑËΩÆËØ¢Âè™Âú® Trade Tab ÂèØËßÅÊó∂ÊâçÂà∑Êñ∞
            if (suggestionsLoaded && !isTabVisible('tradeTab')) {
                return;
            }

            suggestionsFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout (increased due to slow API response)
                
                const res = await fetch('/api/suggestions', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                // Check if response is ok
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();

                const marketCondEl = document.getElementById('marketCondition');
                const recSpreadEl = document.getElementById('recSpread');
                const recLevEl = document.getElementById('recLeverage');
                const recReasonEl = document.getElementById('recReason');

                if (data.error) {
                    console.error('Suggestions error:', data.error);
                    if (marketCondEl) marketCondEl.innerText = 'Error';
                    if (recSpreadEl) recSpreadEl.innerText = '--';
                    if (recLevEl) recLevEl.innerText = '--';
                    if (recReasonEl) recReasonEl.innerText = data.error;
                    return;
                }

                currentSuggestion = data;
                suggestionsLoaded = true;

                if (marketCondEl) marketCondEl.innerText = data.condition || 'N/A';
                if (recSpreadEl) recSpreadEl.innerText = (data.spread !== undefined && data.spread !== null ? data.spread + '%' : '--');
                if (recLevEl) recLevEl.innerText = (data.leverage ? data.leverage + 'x' : '--');
                if (recReasonEl) recReasonEl.innerText = data.reason || 'No recommendation available';

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Error fetching suggestions:', e);
                }
                // Clear loading state even on error
                const marketCondEl = document.getElementById('marketCondition');
                const recSpreadEl = document.getElementById('recSpread');
                const recLevEl = document.getElementById('recLeverage');
                const recReasonEl = document.getElementById('recReason');
                if (marketCondEl && !suggestionsLoaded) {
                    // Only show error if we haven't loaded data before
                    marketCondEl.innerText = 'Error';
                }
                if (recSpreadEl && !suggestionsLoaded) recSpreadEl.innerText = '--';
                if (recLevEl && !suggestionsLoaded) recLevEl.innerText = '--';
                if (recReasonEl && !suggestionsLoaded) recReasonEl.innerText = 'Failed to load suggestions';
            } finally {
                suggestionsFetching = false;
            }
        }

        function getEvaluationSymbol() {
            const select = document.getElementById('pairSelect');
            const raw = select && select.value ? select.value : 'ETHUSDT';
            return raw.toUpperCase().replace(/[:\/-]/g, '');
        }

        function formatPercent(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `${(value * 100).toFixed(decimals)}%`;
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return Number(value).toFixed(decimals);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `$${Number(value).toFixed(2)}`;
        }

        function updateEvaluationUI() {
            const statusEl = document.getElementById('evaluationStatusText');
            const runBtn = document.getElementById('runEvaluationBtn');
            const errorBox = document.getElementById('evaluationErrorBox');
            const consensusCard = document.getElementById('evaluationConsensusCard');
            const resultsWrapper = document.getElementById('evaluationResultsWrapper');
            const resultsBody = document.getElementById('evaluationResultsBody');
            const lastRunEl = document.getElementById('evaluationLastRun');

            if (!statusEl) return;

            if (runBtn) runBtn.disabled = evaluationState.loading;

            if (evaluationState.loading) {
                statusEl.innerText = 'Running evaluation... Please wait.';
            } else if (evaluationState.lastRunAt) {
                statusEl.innerText = `Last run: ${evaluationState.lastRunSymbol || '--'} @ ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`;
            } else {
                statusEl.innerText = 'Ready to evaluate.';
            }

            if (errorBox) {
                if (evaluationState.lastError) {
                    errorBox.style.display = 'block';
                    errorBox.innerText = evaluationState.lastError;
                } else {
                    errorBox.style.display = 'none';
                }
            }

                if (consensusCard) {
                const aggregated = evaluationState.aggregated;
                if (aggregated && aggregated.consensus_proposal && aggregated.strategy_consensus) {
                    const proposal = aggregated.consensus_proposal;
                    const consensus = aggregated.strategy_consensus;
                    consensusCard.style.display = 'block';
                    const confidence = aggregated.consensus_confidence ?? 0;
                    document.getElementById('evaluationConsensusStrategy').innerText = proposal.recommended_strategy || '--';
                    document.getElementById('evaluationConsensusLevel').innerText = `${(consensus.consensus_level || '--').toUpperCase()} (${formatPercent(consensus.consensus_ratio || 0, 1)})`;
                    document.getElementById('evaluationConsensusConfidence').innerText = formatPercent(confidence, 1);
                    document.getElementById('evaluationConsensusParams').innerText =
                        `${formatPercent(proposal.spread || 0, 2)} ¬∑ Skew ${formatNumber(proposal.skew_factor || 0, 0)} ¬∑ Qty ${formatNumber(proposal.quantity || 0, 3)} ¬∑ Lev ${formatNumber(proposal.leverage || 0, 1)}x`;
                        document.getElementById('evaluationConsensusStats').innerText =
                            `Avg PnL ${formatCurrency(aggregated.avg_pnl || 0)} ¬∑ Avg Sharpe ${formatNumber(aggregated.avg_sharpe || 0, 2)} ¬∑ Avg Win ${formatPercent(aggregated.avg_win_rate || 0, 1)}`;
                    document.getElementById('evaluationConsensusReasoning').innerText =
                        proposal.reasoning || 'Consensus reasoning unavailable.';
                } else {
                    consensusCard.style.display = 'none';
                }
            }

            if (resultsWrapper && resultsBody) {
                if (evaluationState.results.length > 0) {
                    resultsWrapper.style.display = 'block';
                    lastRunEl.innerText = evaluationState.lastRunAt
                        ? `Updated ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`
                        : '';
                    const rows = evaluationState.results.map((result) => {
                        const proposal = result.proposal || {};
                        const simulation = result.simulation || {};
                        const disabledApply = !proposal.parse_success ? 'disabled' : '';
                        const providerSafe = (result.provider_name || '').replace(/"/g, '&quot;');
                        const rowClass = result.rank === 1 ? 'style="background: #fef3c7;"' : '';
                        return `
                        <tr ${rowClass}>
                            <td>${result.rank ?? '--'}</td>
                            <td>${result.provider_name || '--'}</td>
                            <td>${proposal.recommended_strategy || '--'}</td>
                            <td>${formatPercent(proposal.spread || 0, 2)}</td>
                            <td>${formatNumber(proposal.skew_factor || 0, 0)}</td>
                            <td>${formatNumber(proposal.quantity || 0, 3)}</td>
                            <td>${formatNumber(proposal.leverage || 0, 1)}x</td>
                            <td>${formatPercent(proposal.confidence || 0, 1)}</td>
                            <td>${formatCurrency(simulation.realized_pnl)}</td>
                            <td>${formatNumber(simulation.sharpe_ratio || 0, 2)}</td>
                            <td>${formatPercent(simulation.win_rate || 0, 1)}</td>
                            <td>${formatNumber(result.score || 0, 1)}</td>
                            <td>
                                <button class="btn btn-secondary" style="font-size: 11px;" ${disabledApply}
                                    onclick="applyEvaluation('individual', '${providerSafe}')">
                                    Apply
                                </button>
                            </td>
                        </tr>`;
                    }).join('');
                    resultsBody.innerHTML = rows;
                } else {
                    resultsWrapper.style.display = 'none';
                    if (lastRunEl) lastRunEl.innerText = '';
                }
            }
        }

        async function runEvaluation() {
            if (evaluationState.loading) return;
            evaluationState.loading = true;
            evaluationState.lastError = null;
            updateEvaluationUI();

            try {
                const symbolPayload = getEvaluationSymbol();
                const res = await fetch('/api/evaluation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbolPayload }),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                evaluationState.results = data.individual_results || [];
                evaluationState.aggregated = data.aggregated || null;
                evaluationState.lastRunSymbol = data.symbol || symbolPayload;
                evaluationState.lastRunAt = new Date().toISOString();
            } catch (err) {
                evaluationState.lastError = err?.message || 'Failed to run evaluation';
            } finally {
                evaluationState.loading = false;
                updateEvaluationUI();
            }
        }

        async function applyEvaluation(source, providerName = null) {
            try {
                const payload = { source };
                if (providerName) payload.provider_name = providerName;
                const res = await fetch('/api/evaluation/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showToast('Applied evaluation proposal successfully', 'success');
                fetchStatus();
            } catch (err) {
                showToast(err?.message || 'Failed to apply proposal', 'error');
            }
        }

        // Initialize evaluation UI on load
        updateEvaluationUI();

        async function applySuggestionOption(spread) {
            document.getElementById('spreadInput').value = spread;
            await updateConfig();
        }

        async function applySuggestion() {
            if (!currentSuggestion) return;

            // Update Inputs
            document.getElementById('spreadInput').value = currentSuggestion.spread;
            document.getElementById('leverageInput').value = currentSuggestion.leverage;

            // Apply Config
            await updateConfig();
            // Apply Leverage
            await updateLeverage();
        }

        async function loadFundingPairs() {
            try {
                const res = await fetch('/api/funding-rates');
                const data = await res.json();

                if (data.error) {
                    console.error('Error loading funding rates:', data.error);
                    return;
                }

                const select = document.getElementById('pairSelectFunding');
                if (!select) return;

                // Get current selection
                const currentSymbol = select.value || 'ETH/USDT:USDT';

                // Build options HTML
                let optionsHTML = '';

                // High funding rate group (top 3 by absolute value)
                const topPairs = data.slice(0, 3);
                if (topPairs.length > 0) {
                    optionsHTML += '<optgroup label="üî• High Funding Rate (Recommended)">';
                    topPairs.forEach(item => {
                        const rate = (item.funding_rate * 100).toFixed(3);
                        const symbol = item.symbol.split('/')[0];
                        const indicator = item.direction === 'short_favored' ? '‚ñº' : item.direction === 'long_favored' ? '‚ñ≤' : '‚îÄ';
                        optionsHTML += `<option value="${item.symbol}">${symbol} [${rate > 0 ? '+' : ''}${rate}%] ${indicator}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }

                // All pairs group
                optionsHTML += '<optgroup label="All Pairs">';
                data.forEach(item => {
                    const rate = (item.funding_rate * 100).toFixed(3);
                    const symbol = item.symbol.split('/')[0];
                    optionsHTML += `<option value="${item.symbol}">${symbol} [${rate > 0 ? '+' : ''}${rate}%]</option>`;
                });
                optionsHTML += '</optgroup>';

                select.innerHTML = optionsHTML;

                // Restore or select highest funding rate pair
                if (data.length > 0) {
                    const hasCurrentSymbol = data.some(item => item.symbol === currentSymbol);
                    select.value = hasCurrentSymbol ? currentSymbol : data[0].symbol;
                }
            } catch (e) {
                console.error('Error loading funding pairs:', e);
            }
        }

        let pnlChart = null;
        let dashPnlChart = null;
        let dashTradeDistChart = null;

        async function fetchPerformance() {
            // Skip if already fetching
            if (performanceFetching) return;
            
            // ‰ªÖÂΩìÊúâÈúÄË¶ÅÂ±ïÁ§∫Áª©ÊïàÁöÑ Tab ÂèØËßÅÊó∂ÊâçËØ∑Ê±ÇÔºåÈÅøÂÖçÈ°µÈù¢Á©∫Èó≤Êó∂ÁöÑÊó†Ë∞ìËΩÆËØ¢
            if (!isTabVisible('tradeTab') && !isTabVisible('dashboardTab') && !isTabVisible('fundingTab')) {
                return;
            }

            performanceFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                
                const res = await fetch('/api/performance', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();

                if (data.error) return;

                // Note: Realized PnL, Total Trades, Win Rate are now only shown in Dashboard Tab
                // Update Dashboard Metrics
                if (document.getElementById('dashRealizedPnl')) {
                    document.getElementById('dashRealizedPnl').innerText = data.realized_pnl ? data.realized_pnl.toFixed(4) + ' USDT' : '0.0000 USDT';
                    
                    // Update commission (trading fees)
                    const commissionEl = document.getElementById('dashCommission');
                    if (commissionEl) {
                        commissionEl.innerText = data.commission ? data.commission.toFixed(4) + ' USDT' : '0.0000 USDT';
                    }
                    
                    // Update net PnL (after fees)
                    const netPnlEl = document.getElementById('dashNetPnl');
                    if (netPnlEl) {
                        const netPnl = data.net_pnl !== undefined ? data.net_pnl : (data.realized_pnl || 0);
                        netPnlEl.innerText = netPnl.toFixed(4) + ' USDT';
                        // Color based on positive/negative
                        netPnlEl.style.color = netPnl >= 0 ? '#7FC8B8' : '#FFB6C1';
                    }
                    
                    document.getElementById('dashWinRate').innerText = data.win_rate ? data.win_rate.toFixed(2) + '%' : '0.00%';
                    document.getElementById('dashTotalTrades').innerText = data.total_trades || 0;

                    // Metrics from DataAgent
                    const metrics = data.metrics || {};
                    document.getElementById('dashSharpe').innerText = metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : '0.00';
                    document.getElementById('dashLatency').innerText = metrics.tick_to_trade_latency ? metrics.tick_to_trade_latency.toFixed(2) + 'ms' : 'N/A';
                    document.getElementById('dashSlippage').innerText = metrics.slippage_bps ? metrics.slippage_bps.toFixed(2) + ' bps' : '0 bps';
                    document.getElementById('dashFillRate').innerText = metrics.fill_rate ? (metrics.fill_rate * 100).toFixed(1) + '%' : 'N/A';

                    // Mock Drawdown for now if not in metrics
                    document.getElementById('dashDrawdown').innerText = '0.00%';
                }

                // Update Charts
                updatePnLChart(data.pnl_history || [], 'pnlChart'); // Trade Tab Chart
                updatePnLChart(data.pnl_history || [], 'dashPnlChart'); // Dashboard Chart
                updateTradeDistChart(data.winning_trades, data.losing_trades);

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Error fetching performance:', e);
                }
            } finally {
                performanceFetching = false;
            }
        }

        function updatePnLChart(pnlHistory, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let chartInstance = canvasId === 'pnlChart' ? pnlChart : dashPnlChart;

            // Extract labels (timestamps) and data (pnl values)
            const labels = pnlHistory.map(item => {
                const date = new Date(item[0]);
                return date.toLocaleTimeString();
            });
            const data = pnlHistory.map(item => item[1]);

            if (chartInstance) {
                // Update existing chart
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update('none'); // 'none' for no animation
            } else {
                // Create new chart
                const newChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Realized PnL (USDT)',
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value.toFixed(2) + ' USDT';
                                    }
                                }
                            },
                            x: {
                                display: true
                            }
                        }
                    }
                });

                if (canvasId === 'pnlChart') {
                    pnlChart = newChart;
                } else {
                    dashPnlChart = newChart;
                }
            }
        }

        function updateTradeDistChart(winning, losing) {
            const ctx = document.getElementById('dashTradeDistChart').getContext('2d');

            if (dashTradeDistChart) {
                dashTradeDistChart.data.datasets[0].data = [winning, losing];
                dashTradeDistChart.update();
            } else {
                dashTradeDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Winning', 'Losing'],
                        datasets: [{
                            data: [winning, losing],
                            backgroundColor: ['#10b981', '#ef4444'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        async function fetchOrderHistory() {
            try {
                // ËÆ¢ÂçïÂéÜÂè≤Âè™Âú® Trade Tab ‰∏≠Â±ïÁ§∫
                if (!isTabVisible('tradeTab')) {
                    return;
                }
                const symbolFilter = document.getElementById('historySymbolFilter').value;
                const statusFilter = document.getElementById('historyStatusFilter').value;
                const timeFilter = document.getElementById('historyTimeFilter').value;

                let url = '/api/order-history?';
                if (symbolFilter) url += `symbol=${symbolFilter}&`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const orders = await res.json();

                const tbody = document.getElementById('orderHistoryBody');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const time = new Date(order.timestamp * 1000).toLocaleTimeString();
                    let statusColor = '#3b82f6'; // Default Blue (Placed)
                    let statusText = order.status.toUpperCase();

                    if (order.status === 'cancelled') {
                        statusColor = '#9ca3af'; // Gray
                    } else if (order.status === 'filled') {
                        statusColor = '#10b981'; // Green
                    }

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${time}</td>
                            <td style="padding: 8px;">${order.symbol}</td>
                            <td style="padding: 8px; color: ${order.side === 'buy' ? '#10b981' : '#ef4444'}; font-weight: bold;">${order.side.toUpperCase()}</td>
                            <td style="padding: 8px; text-align: right;">${order.price.toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${order.quantity.toFixed(4)}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching order history:', e);
            }
        }

        async function fetchErrorHistory() {
            try {
                // Error History Âè™Âú® Trade Tab ‰∏≠Â±ïÁ§∫
                if (!isTabVisible('tradeTab')) {
                    return;
                }

                const typeFilter = document.getElementById('errorTypeFilter').value;
                const timeFilter = document.getElementById('errorTimeFilter').value;

                let url = '/api/error-history?';
                if (typeFilter) url += `error_type=${encodeURIComponent(typeFilter)}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const errors = await res.json();

                if (!Array.isArray(errors)) {
                    console.error('Error history API returned non-array payload:', errors);
                    const tbody = document.getElementById('errorHistoryBody');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ef4444;">Failed to load errors</td></tr>';
                    return;
                }

                const tbody = document.getElementById('errorHistoryBody');
                if (!errors || errors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af;">No errors recorded</td></tr>';
                    return;
                }

                tbody.innerHTML = errors.map(err => {
                    const timeStr = new Date(err.timestamp * 1000).toLocaleTimeString();
                    const type = err.type || 'unknown';
                    const msg = err.message || '';
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${timeStr}</td>
                            <td style="padding: 8px;">${err.symbol || ''}</td>
                            <td style="padding: 8px;">${type}</td>
                            <td style="padding: 8px;">${msg}</td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching error history:', e);
            }
        }

        async function fetchFundingOrderHistory() {
            try {
                // Funding Á≠ñÁï•ËÆ¢ÂçïÂéÜÂè≤Âè™Âú® Funding Tab ÂèØËßÅÊó∂ËØ∑Ê±Ç
                if (!isTabVisible('fundingTab')) {
                    return;
                }
                const statusFilter = document.getElementById('fundingHistoryStatusFilter').value;
                const timeFilter = document.getElementById('fundingHistoryTimeFilter').value;

                // ÈªòËÆ§ËøêË°å ETHUSDT ÁöÑ Funding Á≠ñÁï•Ôºå‰πüÂèØ‰ª•Áî®ÂΩìÂâç Funding Tab ÁöÑ symbol
                const currentSymbolFunding = document.getElementById('currentSymbolFunding').innerText || '';
                const symbolParam = currentSymbolFunding || 'ETH/USDT:USDT';

                let url = `/api/order-history?symbol=${encodeURIComponent(symbolParam)}&strategy_type=funding_rate&`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const orders = await res.json();

                const tbody = document.getElementById('fundingOrderHistoryBody');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No funding strategy orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const time = new Date(order.timestamp * 1000).toLocaleTimeString();
                    let statusColor = '#3b82f6'; // Default Blue (Placed)
                    let statusText = order.status.toUpperCase();

                    if (order.status === 'cancelled') {
                        statusColor = '#9ca3af'; // Gray
                    } else if (order.status === 'filled') {
                        statusColor = '#10b981'; // Green
                    }

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${time}</td>
                            <td style="padding: 8px;">${order.symbol}</td>
                            <td style="padding: 8px; color: ${order.side === 'buy' ? '#10b981' : '#ef4444'}; font-weight: bold;">${order.side.toUpperCase()}</td>
                            <td style="padding: 8px; text-align: right;">${order.price.toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${order.quantity.toFixed(4)}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching funding order history:', e);
            }
        }

        async function fetchFundingErrorHistory() {
            try {
                // Funding ÈîôËØØÂéÜÂè≤Âè™Âú® Funding Tab ÂèØËßÅÊó∂ËØ∑Ê±Ç
                if (!isTabVisible('fundingTab')) {
                    return;
                }

                const typeFilter = document.getElementById('fundingErrorTypeFilter').value;
                const timeFilter = document.getElementById('fundingErrorTimeFilter').value;

                // ‰ΩøÁî®ÂΩìÂâç Funding Tab ÁöÑ symbolÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈÄÄÂõû ETH/USDT:USDT
                const currentSymbolFunding = document.getElementById('currentSymbolFunding').innerText || '';
                const symbolParam = currentSymbolFunding || 'ETH/USDT:USDT';

                let url = `/api/error-history?symbol=${encodeURIComponent(symbolParam)}&strategy_type=funding_rate&`;
                if (typeFilter) url += `error_type=${encodeURIComponent(typeFilter)}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const errors = await res.json();

                if (!Array.isArray(errors)) {
                    console.error('Funding error history API returned non-array payload:', errors);
                    const tbody = document.getElementById('fundingErrorHistoryBody');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ef4444;">Failed to load funding errors</td></tr>';
                    return;
                }

                const tbody = document.getElementById('fundingErrorHistoryBody');
                if (!errors || errors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af;">No funding errors recorded</td></tr>';
                    return;
                }

                tbody.innerHTML = errors.map(err => {
                    const timeStr = new Date(err.timestamp * 1000).toLocaleTimeString();
                    const type = err.type || 'unknown';
                    const msg = err.message || '';
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${timeStr}</td>
                            <td style="padding: 8px;">${err.symbol || ''}</td>
                            <td style="padding: 8px;">${type}</td>
                            <td style="padding: 8px;">${msg}</td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching funding error history:', e);
            }
        }

        // ================================================================
        // Portfolio Management Functions (US-1.x, US-2.x)
        // ================================================================

        let portfolioData = null;
        let sortColumn = 'pnl';
        let sortDirection = 'desc';
        
        // Request deduplication flags
        let portfolioFetching = false;
        let performanceFetching = false;
        let riskIndicatorsFetching = false;
        let statusFetching = false;

        async function fetchPortfolio() {
            // Skip if already fetching
            if (portfolioFetching) return;
            
            // Portfolio Overview is always visible at the top of the page, so always fetch
            portfolioFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                
                const res = await fetch('/api/portfolio', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();

                if (data.error) {
                    console.error('Portfolio error:', data.error);
                    return;
                }

                portfolioData = data;
                updatePortfolioOverview(data);
                updateStrategyTable(data.strategies);

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Error fetching portfolio:', e);
                }
            } finally {
                portfolioFetching = false;
            }
        }

        // ================================================================
        // Risk Indicators (P0)
        // ================================================================

        async function fetchRiskIndicators() {
            // Skip if already fetching
            if (riskIndicatorsFetching) return;
            
            // Only fetch if dashboard tab is visible (risk indicators are shown in dashboard)
            if (!isTabVisible('dashboardTab')) return;
            
            riskIndicatorsFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                
                const res = await fetch('/api/risk-indicators', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();
                updateRiskIndicators(data);
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Error fetching risk indicators:', e);
                }
            } finally {
                riskIndicatorsFetching = false;
            }
        }

        function updateRiskIndicators(data) {
            // Status color mapping
            const statusColors = {
                // Liquidation Buffer
                'safe': { color: '#10b981', text: 'Safe', dot: '#10b981' },
                'warning': { color: '#f59e0b', text: 'Warning', dot: '#f59e0b' },
                'danger': { color: '#f97316', text: 'Danger', dot: '#f97316' },
                'critical': { color: '#ef4444', text: 'CRITICAL', dot: '#ef4444' },
                // Inventory Drift
                'balanced': { color: '#10b981', text: 'Balanced', dot: '#10b981' },
                'offset': { color: '#f59e0b', text: 'Offset', dot: '#f59e0b' },
                'severe': { color: '#f97316', text: 'Severe', dot: '#f97316' },
                'extreme': { color: '#ef4444', text: 'EXTREME', dot: '#ef4444' },
                // Max Drawdown
                'excellent': { color: '#10b981', text: 'Excellent', dot: '#10b981' },
                'normal': { color: '#22c55e', text: 'Normal', dot: '#22c55e' },
            };

            // Overall Risk Level
            const overallEl = document.getElementById('overallRiskLevel');
            if (overallEl && data.overall_risk_level) {
                const riskConfig = {
                    'low': { text: 'LOW', bg: '#10b981' },
                    'medium': { text: 'MEDIUM', bg: '#f59e0b' },
                    'high': { text: 'HIGH', bg: '#f97316' },
                    'critical': { text: 'CRITICAL', bg: '#ef4444' },
                };
                const config = riskConfig[data.overall_risk_level] || riskConfig['low'];
                overallEl.innerText = config.text;
                overallEl.style.background = config.bg;
                
                // Flash animation for critical
                if (data.overall_risk_level === 'critical') {
                    overallEl.style.animation = 'pulse 1s infinite';
                } else {
                    overallEl.style.animation = 'none';
                }
            }

            // Liquidation Buffer
            const liqValueEl = document.getElementById('liqBufferValue');
            const liqStatusEl = document.getElementById('liqBufferStatus');
            const liqCardEl = document.getElementById('liqBufferCard');
            if (liqValueEl) {
                if (data.liquidation_buffer !== null && data.liquidation_buffer !== undefined) {
                    liqValueEl.innerText = data.liquidation_buffer.toFixed(1) + '%';
                    const config = statusColors[data.liquidation_buffer_status] || statusColors['safe'];
                    liqValueEl.style.color = config.color;
                    
                    if (liqStatusEl) {
                        liqStatusEl.innerHTML = `
                            <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${config.dot}; margin-right: 5px;"></span>
                            ${config.text}
                        `;
                    }
                    
                    // Border warning
                    if (liqCardEl) {
                        if (data.liquidation_buffer_status === 'critical') {
                            liqCardEl.style.borderColor = '#ef4444';
                            liqCardEl.style.animation = 'pulse 1s infinite';
                        } else if (data.liquidation_buffer_status === 'danger') {
                            liqCardEl.style.borderColor = '#f97316';
                            liqCardEl.style.animation = 'none';
                        } else {
                            liqCardEl.style.borderColor = 'transparent';
                            liqCardEl.style.animation = 'none';
                        }
                    }
                } else {
                    liqValueEl.innerText = 'N/A';
                    liqValueEl.style.color = '#6b7280';
                    if (liqStatusEl) {
                        liqStatusEl.innerHTML = `
                            <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #6b7280; margin-right: 5px;"></span>
                            No Position
                        `;
                    }
                }
            }

            // Inventory Drift
            const invValueEl = document.getElementById('invDriftValue');
            const invStatusEl = document.getElementById('invDriftStatus');
            if (invValueEl) {
                const drift = data.inventory_drift || 0;
                const sign = drift >= 0 ? '+' : '';
                invValueEl.innerText = sign + drift.toFixed(1) + '%';
                
                const config = statusColors[data.inventory_drift_status] || statusColors['balanced'];
                invValueEl.style.color = config.color;
                
                // Add direction indicator
                let directionIcon = '';
                if (data.inventory_direction === 'long') {
                    directionIcon = '‚Üë Long';
                } else if (data.inventory_direction === 'short') {
                    directionIcon = '‚Üì Short';
                } else {
                    directionIcon = '‚ü∑ Neutral';
                }
                
                if (invStatusEl) {
                    invStatusEl.innerHTML = `
                        <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${config.dot}; margin-right: 5px;"></span>
                        ${config.text} | ${directionIcon}
                    `;
                }
            }

            // Max Drawdown
            const ddValueEl = document.getElementById('maxDrawdownValue');
            const ddStatusEl = document.getElementById('maxDrawdownStatus');
            if (ddValueEl) {
                const dd = data.max_drawdown || 0;
                ddValueEl.innerText = dd.toFixed(1) + '%';
                
                const config = statusColors[data.max_drawdown_status] || statusColors['excellent'];
                ddValueEl.style.color = config.color;
                
                if (ddStatusEl) {
                    ddStatusEl.innerHTML = `
                        <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${config.dot}; margin-right: 5px;"></span>
                        ${config.text}
                    `;
                }
            }
        }

        function updatePortfolioOverview(data) {
            // Total PnL
            const totalPnlEl = document.getElementById('portfolioTotalPnl');
            if (totalPnlEl) {
                const pnl = data.total_pnl || 0;
                totalPnlEl.innerText = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
                totalPnlEl.style.color = pnl >= 0 ? '#7FC8B8' : '#FFB6C1';
            }

            // Trading Fees (Commission)
            const commissionEl = document.getElementById('portfolioCommission');
            if (commissionEl) {
                const commission = data.commission || 0;
                commissionEl.innerText = '$' + commission.toFixed(2);
            }

            // Net PnL (after fees)
            const netPnlEl = document.getElementById('portfolioNetPnl');
            if (netPnlEl) {
                const netPnl = data.net_pnl !== undefined ? data.net_pnl : (data.total_pnl || 0);
                netPnlEl.innerText = (netPnl >= 0 ? '+' : '') + '$' + netPnl.toFixed(2);
                netPnlEl.style.color = netPnl >= 0 ? '#7FC8B8' : '#FFB6C1';
            }

            // Portfolio Sharpe
            const sharpeEl = document.getElementById('portfolioSharpe');
            if (sharpeEl) {
                const sharpe = data.portfolio_sharpe;
                if (sharpe !== null && sharpe !== undefined) {
                    sharpeEl.innerText = sharpe.toFixed(2);
                    if (sharpe >= 2.0) sharpeEl.style.color = '#7FC8B8';
                    else if (sharpe >= 1.0) sharpeEl.style.color = '#FFD4A3';
                    else sharpeEl.style.color = '#FFB6C1';
                } else {
                    sharpeEl.innerText = 'N/A';
                    sharpeEl.style.color = '#94a3b8';
                }
            }

            // Active Strategies Count
            const activeCountEl = document.getElementById('portfolioActiveCount');
            if (activeCountEl) {
                activeCountEl.innerText = `${data.active_count} / ${data.total_count}`;
            }

            // Portfolio Risk
            const riskEl = document.getElementById('portfolioRisk');
            if (riskEl) {
                const riskConfig = {
                    'low': { text: 'Low ‚úì', color: '#10b981' },
                    'medium': { text: 'Medium ‚ö†', color: '#f59e0b' },
                    'high': { text: 'High ‚ö†', color: '#ef4444' },
                    'critical': { text: 'Critical ‚õî', color: '#dc2626' },
                };
                const config = riskConfig[data.risk_level] || riskConfig['low'];
                riskEl.innerText = config.text;
                riskEl.style.color = config.color;
            }

            // Capital (from Binance account)
            const capitalEl = document.getElementById('portfolioCapital');
            if (capitalEl && data.total_capital) {
                capitalEl.innerText = '$' + data.total_capital.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            // Available Balance
            const availableEl = document.getElementById('portfolioAvailable');
            if (availableEl) {
                const available = data.available_balance || data.total_capital || 0;
                availableEl.innerText = '$' + available.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            // Session Start Time
            const sessionStartEl = document.getElementById('sessionStartTime');
            if (sessionStartEl && data.session_start_time) {
                const sessionDate = new Date(data.session_start_time);
                // Format: "Nov 26, 09:00"
                const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
                sessionStartEl.innerText = sessionDate.toLocaleDateString('en-US', options);
            }
        }

        function updateStrategyTable(strategies) {
            const tbody = document.getElementById('strategyTableBody');
            if (!tbody) return;

            if (!strategies || strategies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #9ca3af;">
                            No strategies configured
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort strategies
            const sorted = [...strategies].sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (valA === null || valA === undefined) valA = -Infinity;
                if (valB === null || valB === undefined) valB = -Infinity;
                if (sortDirection === 'asc') return valA - valB;
                return valB - valA;
            });

            // Update sort icons after rendering
            updateSortIcons();
            
            tbody.innerHTML = sorted.map(strategy => {
                // Status badge
                const statusConfig = {
                    'live': { icon: 'üü¢', bg: '#d1fae5', color: '#065f46' },
                    'paper': { icon: 'üü°', bg: '#fef3c7', color: '#92400e' },
                    'paused': { icon: 'üî¥', bg: '#fee2e2', color: '#991b1b' },
                    'stopped': { icon: '‚ö´', bg: '#e5e7eb', color: '#374151' },
                };
                const statusCfg = statusConfig[strategy.status] || statusConfig['stopped'];

                // Health color (US-2.3: 80-100ÁªøËâ≤Ôºå60-79ÈªÑËâ≤Ôºå<60Á∫¢Ëâ≤)
                let healthColor = '#10b981'; // Green for 80-100
                if (strategy.health < 80) healthColor = '#f59e0b'; // Yellow for 60-79
                if (strategy.health < 60) healthColor = '#ef4444'; // Red for <60

                // PnL color
                const pnlColor = strategy.pnl >= 0 ? '#10b981' : '#ef4444';

                // ROI format
                const roiPercent = (strategy.roi * 100).toFixed(2);
                const roiColor = strategy.roi >= 0 ? '#10b981' : '#ef4444';

                // Action buttons - Strategy instance control
                const isRunning = strategy.status === 'live';
                const isPaused = strategy.status === 'paused';
                const isStopped = strategy.status === 'stopped';
                
                let controlBtn = '';
                if (isRunning) {
                    controlBtn = `<button onclick="stopStrategyInstance('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; background: #ef4444; color: white;">Stop</button>`;
                } else if (isPaused) {
                    controlBtn = `<button onclick="startStrategyInstance('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white;">Start</button>`;
                } else {
                    controlBtn = `<button onclick="startStrategyInstance('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white;">Start</button>`;
                }
                
                // Legacy pause/resume buttons (for portfolio manager status)
                const pauseResumeBtn = isPaused
                    ? `<button onclick="resumeStrategy('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white; margin-left: 4px;">Resume</button>`
                    : `<button onclick="pauseStrategy('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; background: #f59e0b; color: white; margin-left: 4px;">Pause</button>`;

                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px 8px; font-weight: 500;">${strategy.name}</td>
                        <td style="padding: 12px 8px; text-align: center;">
                            <span style="background: ${statusCfg.bg}; color: ${statusCfg.color}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${statusCfg.icon} ${strategy.status.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px 8px; text-align: right; font-weight: 600; color: ${pnlColor};">
                            ${strategy.pnl >= 0 ? '+' : ''}$${strategy.pnl.toFixed(2)}
                        </td>
                        <td style="padding: 12px 8px; text-align: right;">
                            ${strategy.sharpe !== null ? strategy.sharpe.toFixed(2) : 'N/A'}
                        </td>
                        <td style="padding: 12px 8px; text-align: center;">
                            <div style="display: inline-flex; align-items: center; gap: 8px;">
                                <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${strategy.health}%; height: 100%; background: ${healthColor};"></div>
                                </div>
                                <span style="font-size: 12px; color: ${healthColor}; font-weight: 600;">${strategy.health}</span>
                            </div>
                        </td>
                        <td style="padding: 12px 8px; text-align: right;">
                            ${(strategy.allocation * 100).toFixed(0)}%
                        </td>
                        <td style="padding: 12px 8px; text-align: right; color: ${roiColor};">
                            ${strategy.roi >= 0 ? '+' : ''}${roiPercent}%
                        </td>
                        <td style="padding: 12px 8px; text-align: center;">
                            ${controlBtn}
                            ${pauseResumeBtn}
                            <button onclick="viewStrategyDetails('${strategy.id}')" class="btn" style="padding: 4px 8px; font-size: 11px; margin-left: 4px;">
                                Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function sortStrategies(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            
            // Update sort icons
            updateSortIcons();
            
            if (portfolioData && portfolioData.strategies) {
                updateStrategyTable(portfolioData.strategies);
            }
        }
        
        function updateSortIcons() {
            // Get all sort icons
            const icons = document.querySelectorAll('.sort-icon');
            icons.forEach(icon => {
                icon.innerText = '';
            });
            
            // Find the current sort column header
            const headers = document.querySelectorAll('#strategyTable thead th');
            headers.forEach((header, index) => {
                const onclick = header.getAttribute('onclick');
                if (onclick && onclick.includes(`sortStrategies('${sortColumn}')`)) {
                    const icon = header.querySelector('.sort-icon');
                    if (icon) {
                        icon.innerText = sortDirection === 'desc' ? '‚ñº' : '‚ñ≤';
                    }
                }
            });
        }

        async function pauseStrategy(strategyId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÊöÇÂÅúÁ≠ñÁï• "${strategyId}" ÂêóÔºü`)) return;

            try {
                const res = await fetch(`/api/strategy/${strategyId}/pause`, { method: 'POST' });
                const data = await res.json();
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    showToast(`Á≠ñÁï• ${strategyId} Â∑≤ÊöÇÂÅú`, 'success');
                    fetchPortfolio();
                }
            } catch (e) {
                showToast('ÊöÇÂÅúÁ≠ñÁï•Â§±Ë¥•', 'error');
            }
        }

        async function resumeStrategy(strategyId) {
            try {
                const res = await fetch(`/api/strategy/${strategyId}/resume`, { method: 'POST' });
                const data = await res.json();
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    showToast(`Á≠ñÁï• ${strategyId} Â∑≤ÊÅ¢Â§ç`, 'success');
                    fetchPortfolio();
                }
            } catch (e) {
                showToast('ÊÅ¢Â§çÁ≠ñÁï•Â§±Ë¥•', 'error');
            }
        }

        async function startStrategyInstance(strategyId) {
            try {
                const res = await fetch(`/api/strategy/${strategyId}/control?action=start`, { method: 'POST' });
                const data = await res.json();
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    showToast(`Á≠ñÁï• ${strategyId} Â∑≤ÂêØÂä®`, 'success');
                    // Refresh data to update button states
                    await fetchPortfolio();
                    await fetchStatus();
                }
            } catch (e) {
                showToast('ÂêØÂä®Á≠ñÁï•Â§±Ë¥•', 'error');
            }
        }

        async function stopStrategyInstance(strategyId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂÅúÊ≠¢Á≠ñÁï• "${strategyId}" ÂêóÔºü`)) return;
            
            try {
                const res = await fetch(`/api/strategy/${strategyId}/control?action=stop`, { method: 'POST' });
                const data = await res.json();
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    showToast(`Á≠ñÁï• ${strategyId} Â∑≤ÂÅúÊ≠¢`, 'success');
                    // Refresh data to update button states
                    await fetchPortfolio();
                    await fetchStatus();
                }
            } catch (e) {
                showToast('ÂÅúÊ≠¢Á≠ñÁï•Â§±Ë¥•', 'error');
            }
        }

        function viewStrategyDetails(strategyId) {
            // Switch to the appropriate tab
            if (strategyId === 'fixed_spread') {
                showTab('trade');
            } else if (strategyId === 'funding_rate') {
                showTab('funding');
            }
        }

        // Optimized polling intervals to reduce server load
        // Status: 2s (reduced from 1s)
        setInterval(fetchStatus, 2000);
        // Portfolio: 5s (reduced from 2s, calls Binance API)
        setInterval(fetchPortfolio, 5000);
        // Risk indicators: 5s (reduced from 3s, calls Binance API)
        setInterval(fetchRiskIndicators, 5000);
        // Suggestions: 10s (reduced from 5s)
        setInterval(fetchSuggestions, 10000);
        // Performance: 5s (reduced from 2s, calls Binance API)
        setInterval(fetchPerformance, 5000);
        // Order history: 5s (reduced from 3s)
        setInterval(fetchOrderHistory, 5000);
        // Error history: 10s (reduced from 5s)
        setInterval(fetchErrorHistory, 10000);
        // Funding order history: 5s (reduced from 3s)
        setInterval(fetchFundingOrderHistory, 5000);
        // Funding error history: 10s (reduced from 5s)
        setInterval(fetchFundingErrorHistory, 10000);
        // Funding pairs: 120s (reduced from 60s)
        setInterval(loadFundingPairs, 120000);
        // Initialize order history symbol filter with current trading pair
        const initialPairSelect = document.getElementById('pairSelect');
        if (initialPairSelect && initialPairSelect.value) {
            updateOrderHistorySymbolFilter(initialPairSelect.value);
        }
        
        // Initialize trading pair and fetch data on page load
        async function initializePage() {
            // Get default trading pair from select element
            const pairSelect = document.getElementById('pairSelect');
            if (pairSelect && pairSelect.value) {
                // Update trading pair first to ensure backend has correct symbol (silent mode for page load)
                await updatePair(true); // true = silent mode, no toast notification
            } else {
                // If no pair selected, just fetch status
                fetchStatus();
            }
            
            // Fetch other data (these will be called after updatePair completes)
            // Note: updatePair already calls fetchStatus, fetchOrderHistory, fetchSuggestions, fetchPortfolio
            // So we only need to fetch the ones not covered by updatePair
            fetchPerformance();
            fetchErrorHistory();
            fetchFundingOrderHistory();
            fetchFundingErrorHistory();
            loadFundingPairs(); // Initial load of funding pairs
            fetchRiskIndicators(); // Initial load of risk indicators (P0)
        }
        
        // Run initialization
        initializePage();
        
        // Initialize tooltips on page load (after DOM is ready)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTooltips);
        } else {
            // DOM already loaded
            initializeTooltips();
        }
        
        // Also initialize tooltips after a short delay to ensure all elements are rendered
        setTimeout(initializeTooltips, 500);
    </script>
</body>

</html>