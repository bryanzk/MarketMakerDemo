<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Market Maker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #6b7280;
        }

        .card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .sub-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn:disabled {
            background-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-error {
            background-color: #fef3c7;
            color: #92400e;
        }

        .error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .log-console {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .toast.success {
            background-color: #10b981;
        }

        .toast.error {
            background-color: #ef4444;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="tab-nav" style="margin-bottom:20px;">
            <button class="btn btn-primary" id="tradeTabBtn" onclick="showTab('trade')">
                Fixed Spread Strategy
            </button>
            <button class="btn" id="fundingTabBtn" onclick="showTab('funding')">
                Funding Rate Skew Strategy
            </button>
            <button class="btn" id="dashboardTabBtn" onclick="showTab('dashboard')">
                Performance Dashboard
            </button>
        </div>
        <div id="tradeTab">
            <div class="header">
                <h1>Binance Market Maker (MVP)</h1>
                <div style="text-align: right;">
                    <div>
                        <span id="currentSymbol" style="font-weight: bold; margin-right: 10px;">--</span>
                        <span id="botStatus" class="status-badge status-inactive">STOPPED</span>
                    </div>
                    <div id="stageDisplay" style="font-size: 12px; color: #6b7280; margin-top: 5px; font-weight: bold;">
                        Idle
                    </div>
                </div>
            </div>

            <div id="errorDisplay" class="error-message" style="display: none;"></div>
            <div id="alertDisplay" class="error-message"
                style="display: none; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                <strong>‚ö†Ô∏è Alert:</strong> <span id="alertMessage"></span>
                <div id="alertSuggestion" style="font-size: 12px; margin-top: 5px;"></div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h3>Mid Price</h3>
                    <div class="value" id="midPrice">--</div>
                </div>
                <div class="card">
                    <h3>Position (ETH)</h3>
                    <div class="value" id="position">--</div>
                </div>
                <div class="card">
                    <h3>Balance (USDT)</h3>
                    <div class="value" id="balance">--</div>
                </div>
                <div class="card">
                    <h3>Unrealized PnL</h3>
                    <div class="value" id="pnl">--</div>
                </div>
                <div class="card">
                    <h3>Leverage</h3>
                    <div class="value" id="leverage">--</div>
                </div>
                <div class="card">
                    <h3>Realized PnL</h3>
                    <div class="value" id="realizedPnl">--</div>
                </div>
                <div class="card">
                    <h3>Total Trades</h3>
                    <div class="value" id="totalTrades">--</div>
                </div>
                <div class="card">
                    <h3>Win Rate</h3>
                    <div class="value" id="winRate">--</div>
                </div>
                <div class="card">
                    <h3>Funding Rate</h3>
                    <div class="value" id="fundingRate">--</div>
                </div>
                <div class="card">
                    <h3>Est. Daily Yield</h3>
                    <div class="value" id="dailyYield">--</div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h3>Control Panel</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="startBtn" class="btn btn-success" onclick="startFixedSpreadBot()">Start Bot</button>
                        <button id="stopBtn" class="btn btn-danger" onclick="controlBot('stop')" disabled>Stop
                            Bot</button>
                    </div>
                    <hr>
                    <div style="margin-top: 15px;">
                        <label>Trading Pair:
                            <select id="pairSelect" onchange="updatePair()" style="padding: 5px; border-radius: 4px;">
                                <optgroup label="Mainstream">
                                    <option value="BTC/USDT:USDT">BTC/USDT</option>
                                    <option value="ETH/USDT:USDT" selected>ETH/USDT</option>
                                    <option value="SOL/USDT:USDT">SOL/USDT</option>
                                </optgroup>
                                <optgroup label="Memecoins">
                                    <option value="DOGE/USDT:USDT">DOGE/USDT</option>
                                    <option value="1000SHIB/USDT:USDT">1000SHIB/USDT</option>
                                    <option value="1000PEPE/USDT:USDT">1000PEPE/USDT</option>
                                    <option value="WIF/USDT:USDT">WIF/USDT</option>
                                    <option value="1000FLOKI/USDT:USDT">1000FLOKI/USDT</option>
                                </optgroup>
                            </select>
                        </label>
                    </div>
                    <hr>
                    <div style="margin-top: 15px;">
                        <label>Strategy:
                            <select id="strategySelect" onchange="toggleStrategyParams()"
                                style="padding: 5px; border-radius: 4px; width: 100%; margin-top: 5px;">
                                <option value="fixed_spread">Fixed Spread</option>
                                <option value="funding_rate">Funding Rate Skew</option>
                            </select>
                        </label>
                    </div>
                    <hr>
                    <div style="margin-top: 15px;">
                        <label>Spread (%): <input type="number" id="spreadInput" step="0.001" value="0.002"></label>
                        <label>Qty: <input type="number" id="qtyInput" step="0.01" value="0.02"></label>

                        <div id="skewFactorContainer" style="display: none; margin-top: 10px;">
                            <label>Skew Factor: <input type="number" id="skewFactorInput" step="10" value="100"></label>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">Controls funding rate impact
                                on price skew.</div>
                        </div>

                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateConfig()">Update Config</button>
                    </div>
                    <hr>
                    <div style="margin-top: 15px;">
                        <label>Leverage (<span id="leverageRange">1-125</span>x): <input type="number"
                                id="leverageInput" min="1" max="125" value="5"></label>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateLeverage()">Update Leverage</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Strategy Suggestions</h3>
                    <div id="suggestionBox" style="margin-top: 10px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Market Condition:</div>
                        <div id="marketCondition" class="status-badge" style="background: #e5e7eb; color: #374151;">
                            Loading...</div>

                        <div style="margin-top: 15px; font-size: 14px; font-weight: bold;">Recommendation:</div>
                        <div style="font-size: 13px; margin-top: 5px;">
                            Spread: <span id="recSpread" style="font-weight: bold;">--</span> |
                            Leverage: <span id="recLeverage" style="font-weight: bold;">--</span>
                        </div>

                        <div style="margin-top: 15px; font-size: 14px; font-weight: bold;">Reasoning:</div>
                        <div id="recReason" style="font-size: 12px; color: #6b7280; margin-top: 5px; line-height: 1.4;">
                            --
                        </div>

                        <button class="btn btn-success" style="margin-top: 15px; width: 100%; font-size: 12px;"
                            onclick="applySuggestion()">Apply Recommendation</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Trading Constraints</h3>

                    <div style="margin-top: 10px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #3b82f6;">üìä Binance
                            Exchange Limits</div>
                        <table style="width: 100%; font-size: 12px; margin-top: 5px;">
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Min Quantity:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintMinQty">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Max Quantity:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintMaxQty">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Step Size:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintStepSize">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Min Notional:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintMinNotional">--</td>
                            </tr>
                        </table>
                    </div>

                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">

                    <div>
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #10b981;">‚öôÔ∏è Internal
                            Limits</div>
                        <table style="width: 100%; font-size: 12px; margin-top: 5px;">
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Max Position:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintMaxPos">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Current Leverage:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintLeverage">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Current Spread:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintSpread">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; color: #6b7280;">Order Quantity:</td>
                                <td style="text-align: right; font-weight: bold;" id="constraintQty">--</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <h3>Active Orders</h3>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders here -->
                        </tbody>
                    </table>
                </div>
                <!-- System Activity Log -->
                <div class="card" style="grid-column: span 2;">
                    <h3>System Activity</h3>
                    <div id="systemLogs"
                        style="height: 150px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb; padding: 10px; font-family: monospace; font-size: 12px; color: #374151;">
                        <div style="color: #9ca3af;">Waiting for activity...</div>
                    </div>
                </div>

                <!-- Order History -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Order History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="historySymbolFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Symbols</option>
                            <option value="ETH/USDT:USDT">ETH/USDT</option>
                            <option value="BTC/USDT:USDT">BTC/USDT</option>
                        </select>
                        <select id="historyStatusFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Status</option>
                            <option value="placed">Placed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="filled">Filled</option>
                        </select>
                        <select id="historyTimeFilter" onchange="fetchOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="orderHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Side</th>
                                    <th style="padding: 8px; text-align: right;">Price</th>
                                    <th style="padding: 8px; text-align: right;">Qty</th>
                                    <th style="padding: 8px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="orderHistoryBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No orders
                                        yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Settings -->
                <div class="card" style="grid-column: span 2;">
                    <h3>PnL Trend Chart</h3>
                    <canvas id="pnlChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div id="fundingTab" style="display: none;">
            <div class="header">
                <h1>Funding Rate Skew Strategy</h1>
                <div style="text-align: right;">
                    <div>
                        <span id="currentSymbolFunding" style="font-weight: bold; margin-right: 10px;">--</span>
                        <span id="botStatusFunding" class="status-badge status-inactive">STOPPED</span>
                    </div>
                    <div id="stageDisplayFunding"
                        style="font-size: 12px; color: #6b7280; margin-top: 5px; font-weight: bold;">
                        Idle
                    </div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h3>Funding Overview</h3>
                    <div style="font-size: 13px; color: #6b7280;">Current Funding Rate</div>
                    <div class="value" id="fundingRateFunding">--</div>
                    <div class="sub-text">Positive = Paying, Negative = Receiving</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">Est. Daily Yield (Funding Only)
                    </div>
                    <div class="value" id="dailyFundingYield">--</div>
                </div>
                <div class="card">
                    <h3>Position & Notional</h3>
                    <div style="font-size: 13px; color: #6b7280;">Net Position</div>
                    <div class="value" id="positionFunding">--</div>
                    <div class="sub-text">Base asset (e.g., ETH)</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">Notional Value</div>
                    <div class="value" id="notionalFunding">--</div>
                </div>
                <div class="card">
                    <h3>Spread & Skew</h3>
                    <div style="font-size: 13px; color: #6b7280;">Base Spread</div>
                    <div class="value" id="spreadFunding">--</div>
                    <div class="sub-text">From current strategy config</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 10px;">Funding Skew Factor</div>
                    <div class="value" id="skewFunding">--</div>
                </div>
                <div class="card">
                    <h3>Funding Condition</h3>
                    <div id="fundingConditionBadge" class="status-badge"
                        style="background: #e5e7eb; color: #374151; font-size: 12px;">
                        Loading...
                    </div>
                    <div id="fundingConditionText"
                        style="font-size: 12px; color: #6b7280; margin-top: 10px; line-height: 1.5;">
                        This tab focuses on Funding Rate Skew strategy. When funding is positive, the bot prefers short
                        bias; when negative, it prefers long bias.
                    </div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card" style="grid-column: span 2;">
                    <h3>Funding Strategy Control</h3>
                    <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin-top: 5px;">
                        Âú®ËøôÈáå‰Ω†ÂèØ‰ª•Áõ¥Êé•ÂêØÂä® / ÂÅúÊ≠¢ BotÔºåÂπ∂‰∏ìÈó®‰∏∫ Funding Rate Skew Á≠ñÁï•Ë∞ÉÊï¥ÂèÇÊï∞„ÄÇ
                        Â∫ïÂ±Ç‰ªçÁÑ∂Â§çÁî®‰∏é Trade È°µÁõ∏ÂêåÁöÑÂêéÁ´ØÈÖçÁΩÆÊé•Âè£„ÄÇ
                    </p>

                    <!-- Bot Start / Stop -->
                    <div style="display: flex; gap: 10px; margin-top: 15px; margin-bottom: 10px;">
                        <button id="startFundingBtn" class="btn btn-success" onclick="startFundingBot()">Start
                            Bot</button>
                        <button id="stopFundingBtn" class="btn btn-danger" onclick="controlBot('stop')" disabled>Stop
                            Bot</button>

                    </div>

                    <hr>

                    <!-- Pair Select -->
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            Trading Pair (Funding Tab):
                            <select id="pairSelectFunding" onchange="updateFundingPair()"
                                style="padding: 5px; border-radius: 4px; margin-left: 5px;">
                                <option value="">Loading funding rates...</option>
                            </select>
                        </label>
                    </div>

                    <hr>

                    <!-- Funding-specific Parameters -->
                    <div style="margin-top: 10px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-size: 13px;">
                                Spread (%):
                                <input type="number" id="spreadFundingInput" step="0.001" value="0.002"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                            <label style="font-size: 13px;">
                                Qty:
                                <input type="number" id="qtyFundingInput" step="0.01" value="0.02"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                            <label style="font-size: 13px;">
                                Skew Factor:
                                <input type="number" id="skewFactorFundingInput" step="10" value="100"
                                    style="margin-left: 5px; width: 90px;">
                            </label>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                            Ë∞ÉÊï¥ÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆÔºå‰ºö‰ª• Funding Rate Skew Á≠ñÁï•Á±ªÂûãÊõ¥Êñ∞ÂêéÁ´ØÈÖçÁΩÆ„ÄÇ
                        </div>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateFundingConfig()">
                            Update Funding Config
                        </button>
                    </div>

                    <hr>

                    <!-- Leverage for Funding -->
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            Leverage (Funding):
                            <input type="number" id="leverageFundingInput" min="1" max="125" value="5"
                                style="margin-left: 5px; width: 80px;">
                        </label>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;"
                            onclick="updateFundingLeverage()">
                            Update Funding Leverage
                        </button>
                    </div>

                    <div style="margin-top: 15px; font-size: 12px; color: #6b7280;">
                        ÊèêÁ§∫ÔºöFunding Tab ÁöÑÂèÇÊï∞Êõ¥Êñ∞‰ºöÂêåÊ≠•Âà∞Â∫ïÂ±ÇÁ≠ñÁï•Ôºå‰Ω†‰πüÂèØ‰ª•Âú® Trade È°µÁúãÂà∞ÊïàÊûú„ÄÇ
                    </div>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <h3>Funding Strategy Order History</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="fundingHistoryStatusFilter" onchange="fetchFundingOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Status</option>
                            <option value="placed">Placed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="filled">Filled</option>
                        </select>
                        <select id="fundingHistoryTimeFilter" onchange="fetchFundingOrderHistory()"
                            style="padding: 5px; border-radius: 4px;">
                            <option value="">All Time</option>
                            <option value="3600">Last 1h</option>
                            <option value="21600">Last 6h</option>
                            <option value="86400">Last 24h</option>
                        </select>
                    </div>
                    <div id="fundingOrderHistoryContainer"
                        style="height: 200px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead
                                style="position: sticky; top: 0; background: #fff; border-bottom: 2px solid #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">Side</th>
                                    <th style="padding: 8px; text-align: right;">Price</th>
                                    <th style="padding: 8px; text-align: right;">Qty</th>
                                    <th style="padding: 8px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="fundingOrderHistoryBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">
                                        No funding strategy orders yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardTab" style="display: none;">
        <div class="header">
            <h1>Performance Dashboard</h1>
            <div style="text-align: right;">
                <button class="btn btn-success" onclick="fetchPerformance()">Refresh Data</button>
            </div>
        </div>

        <div class="card-grid">
            <!-- Key Business Metrics -->
            <div class="card">
                <h3>Realized PnL</h3>
                <div class="value" id="dashRealizedPnl" style="color: #10b981;">--</div>
                <div class="sub-text">Total Profit/Loss</div>
            </div>
            <div class="card">
                <h3>Win Rate</h3>
                <div class="value" id="dashWinRate">--</div>
                <div class="sub-text">Winning Trades / Total</div>
            </div>
            <div class="card">
                <h3>Sharpe Ratio</h3>
                <div class="value" id="dashSharpe">--</div>
                <div class="sub-text">Risk-Adjusted Return</div>
            </div>
            <div class="card">
                <h3>Max Drawdown</h3>
                <div class="value" id="dashDrawdown" style="color: #ef4444;">--</div>
                <div class="sub-text">Peak to Trough Decline</div>
            </div>
        </div>

        <div class="card-grid" style="grid-template-columns: 2fr 1fr;">
            <!-- PnL Chart -->
            <div class="card">
                <h3>PnL Growth</h3>
                <canvas id="dashPnlChart" style="max-height: 300px;"></canvas>
            </div>
            <!-- Trade Distribution -->
            <div class="card">
                <h3>Trade Distribution</h3>
                <canvas id="dashTradeDistChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div class="card-grid">
            <!-- Operational Metrics -->
            <div class="card">
                <h3>Tick-to-Trade Latency</h3>
                <div class="value" id="dashLatency">--</div>
                <div class="sub-text">Avg time to execute</div>
            </div>
            <div class="card">
                <h3>Fill Rate</h3>
                <div class="value" id="dashFillRate">--</div>
                <div class="sub-text">Filled / Placed Orders</div>
            </div>
            <div class="card">
                <h3>Slippage</h3>
                <div class="value" id="dashSlippage">--</div>
                <div class="sub-text">Avg execution slippage</div>
            </div>
            <div class="card">
                <h3>Total Trades</h3>
                <div class="value" id="dashTotalTrades">--</div>
                <div class="sub-text">Count of all trades</div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        function isTabVisible(tabId) {
            const el = document.getElementById(tabId);
            if (!el) return false;
            // ÈªòËÆ§Ê≤°ÊúâÊòæÂºè display ÁöÑËßÜ‰∏∫ÂèØËßÅ
            return el.style.display === '' || el.style.display === 'block';
        }

        function showTab(tabName) {
            document.getElementById('tradeTab').style.display = tabName === 'trade' ? 'block' : 'none';
            document.getElementById('fundingTab').style.display = tabName === 'funding' ? 'block' : 'none';
            document.getElementById('dashboardTab').style.display = tabName === 'dashboard' ? 'block' : 'none';

            // Update buttons
            document.getElementById('tradeTabBtn').className = tabName === 'trade' ? 'btn btn-primary' : 'btn';
            document.getElementById('fundingTabBtn').className = tabName === 'funding' ? 'btn btn-primary' : 'btn';
            document.getElementById('dashboardTabBtn').className = tabName === 'dashboard' ? 'btn btn-primary' : 'btn';

            // ‰∏çÂêå Tab ÂàáÊç¢Êó∂Ôºå‰∏ªÂä®Âà∑Êñ∞‰∏éÂΩìÂâçÁ≠ñÁï•Áõ∏ÂÖ≥ÁöÑÂÖ≥ÈîÆÊï∞ÊçÆÔºå‰øùËØÅÂÜ≥Á≠ñÊó∂ÁúãÂà∞ÁöÑÊòØÊúÄÊñ∞Áä∂ÊÄÅ
            if (tabName === 'trade') {
                // Fixed Spread Á≠ñÁï•ËßÜËßíÔºöÁä∂ÊÄÅ + Áª©Êïà + Âª∫ËÆÆ + ÂÖ®Â±ÄËÆ¢ÂçïÂéÜÂè≤
                fetchStatus();
                fetchPerformance();
                fetchSuggestions();
                fetchOrderHistory();
            } else if (tabName === 'dashboard') {
                // ÂàáÂà∞ Dashboard Êó∂Âà∑Êñ∞Áª©ÊïàÊï∞ÊçÆ
                fetchPerformance();
            } else if (tabName === 'funding') {
                // Funding Skew Á≠ñÁï•ËßÜËßíÔºöÁä∂ÊÄÅ + Áª©Êïà + Âª∫ËÆÆ + Funding ‰∏ìÁî®ËÆ¢ÂçïÂéÜÂè≤ + Âä®ÊÄÅ‰∫§ÊòìÂØπÂä†ËΩΩ
                fetchStatus();
                fetchPerformance();
                fetchSuggestions();
                fetchFundingOrderHistory();
                loadFundingPairs(); // Load funding rates and update pair dropdown
            }
        }

        function showToast(message, type = 'success') {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "toast show " + type;
            setTimeout(function () { x.className = x.className.replace("show", "").replace(type, ""); }, 3000);
        }

        function toggleStrategyParams() {
            const strategy = document.getElementById('strategySelect').value;
            const skewContainer = document.getElementById('skewFactorContainer');
            if (strategy === 'funding_rate') {
                skewContainer.style.display = 'block';
            } else {
                skewContainer.style.display = 'none';
            }
        }



        async function startFixedSpreadBot() {
            // Á°Æ‰øùÂΩìÂâçÁ≠ñÁï•‰∏∫ Fixed SpreadÔºåÂπ∂‰ΩøÁî® Trade Tab ‰∏äÁöÑÂèÇÊï∞
            const strategySelect = document.getElementById('strategySelect');
            if (strategySelect) {
                strategySelect.value = 'fixed_spread';
                toggleStrategyParams();
            }
            // Áõ¥Êé•Áî®‰∏ªÊéßÂà∂Èù¢ÊùøÂΩìÂâçÂèÇÊï∞Êõ¥Êñ∞ÈÖçÁΩÆÔºåÁÑ∂ÂêéÂêØÂä®
            await updateConfig();
            await controlBot('start');
        }

        async function startFundingBot() {
            // Â∞Ü Funding Tab ‰∏äÁöÑÂèÇÊï∞ÂêåÊ≠•Âà∞‰∏ªÊéßÂà∂Èù¢ÊùøËæìÂÖ•
            const spreadFundingInput = document.getElementById('spreadFundingInput');
            const qtyFundingInput = document.getElementById('qtyFundingInput');
            const skewFactorFundingInput = document.getElementById('skewFactorFundingInput');

            const mainSpread = document.getElementById('spreadInput');
            const mainQty = document.getElementById('qtyInput');
            const mainSkew = document.getElementById('skewFactorInput');
            const strategySelect = document.getElementById('strategySelect');

            if (spreadFundingInput && mainSpread) {
                mainSpread.value = spreadFundingInput.value;
            }
            if (qtyFundingInput && mainQty) {
                mainQty.value = qtyFundingInput.value;
            }
            if (skewFactorFundingInput && mainSkew) {
                mainSkew.value = skewFactorFundingInput.value;
            }
            if (strategySelect) {
                strategySelect.value = 'funding_rate';
                toggleStrategyParams();
            }

            // ‰ª• Funding Rate Á≠ñÁï•Êõ¥Êñ∞ÈÖçÁΩÆÂπ∂ÂêØÂä®
            await updateFundingConfig();
            await controlBot('start');
        }

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                if (data.error) return;

                document.getElementById('midPrice').innerText = data.mid_price ? data.mid_price.toFixed(2) : '--';
                document.getElementById('position').innerText = data.position;
                document.getElementById('balance').innerText = data.balance ? data.balance.toFixed(2) : '--';
                document.getElementById('pnl').innerText = data.pnl ? data.pnl.toFixed(4) : '--';
                document.getElementById('pnl').innerText = data.pnl ? data.pnl.toFixed(4) : '--';
                document.getElementById('currentSymbol').innerText = data.symbol || '--';

                // Mirror into Funding tab: symbol, position, notional
                const currentSymbolFunding = document.getElementById('currentSymbolFunding');
                if (currentSymbolFunding) {
                    currentSymbolFunding.innerText = data.symbol || '--';
                }
                const positionFunding = document.getElementById('positionFunding');
                const notionalFunding = document.getElementById('notionalFunding');
                if (positionFunding) {
                    positionFunding.innerText = data.position;
                }
                if (notionalFunding && data.mid_price && data.position !== undefined) {
                    const notional = data.mid_price * data.position;
                    notionalFunding.innerText = notional.toFixed(2) + ' USDT';
                }

                // Update Funding Rate and Yield
                if (data.funding_rate !== undefined) {
                    const rate = data.funding_rate * 100;
                    document.getElementById('fundingRate').innerText = rate.toFixed(4) + '%';
                    document.getElementById('dailyYield').innerText = (rate * 3).toFixed(4) + '%';

                    // Funding tab mirrors funding metrics
                    const fundingRateFunding = document.getElementById('fundingRateFunding');
                    const dailyFundingYield = document.getElementById('dailyFundingYield');
                    if (fundingRateFunding) {
                        fundingRateFunding.innerText = rate.toFixed(4) + '%';
                    }
                    if (dailyFundingYield) {
                        dailyFundingYield.innerText = (rate * 3).toFixed(4) + '%';
                    }

                    // Color code funding rate
                    const fundingElem = document.getElementById('fundingRate');
                    if (rate > 0) fundingElem.style.color = '#ef4444'; // Red (paying)
                    else if (rate < 0) fundingElem.style.color = '#10b981'; // Green (receiving)
                    else fundingElem.style.color = '#1f2937';

                    // Funding condition badge
                    const conditionBadge = document.getElementById('fundingConditionBadge');
                    const conditionText = document.getElementById('fundingConditionText');
                    if (conditionBadge && conditionText) {
                        let conditionLabel = 'Neutral Funding';
                        let badgeBg = '#e5e7eb';
                        let badgeColor = '#374151';
                        if (rate > 0.03) {
                            conditionLabel = 'Positive Funding (Short-biased)';
                            badgeBg = '#fee2e2';
                            badgeColor = '#991b1b';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéá‰∏∫Ê≠£ÔºåÁ©∫Â§¥‰∏Ä‰æßËé∑ÂæóËµÑÈáëË¥πÁî®ÔºåÁ≠ñÁï•ÂèØ‰ª•ÈÄÇÂΩìÂÅèÁ©∫ÔºàÂçñÂá∫‰∏Ä‰æßÊõ¥ÁßØÊûÅÊä•‰ª∑Ôºâ„ÄÇ';
                        } else if (rate < -0.03) {
                            conditionLabel = 'Negative Funding (Long-biased)';
                            badgeBg = '#d1fae5';
                            badgeColor = '#065f46';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéá‰∏∫Ë¥üÔºåÂ§öÂ§¥‰∏Ä‰æßËé∑ÂæóËµÑÈáëË¥πÁî®ÔºåÁ≠ñÁï•ÂèØ‰ª•ÈÄÇÂΩìÂÅèÂ§öÔºà‰π∞ÂÖ•‰∏Ä‰æßÊõ¥ÁßØÊûÅÊä•‰ª∑Ôºâ„ÄÇ';
                        } else {
                            conditionLabel = 'Near-Neutral Funding';
                            badgeBg = '#e5e7eb';
                            badgeColor = '#374151';
                            conditionText.innerText = 'ËµÑÈáëË¥πÁéáÊé•Ëøë‰∏≠ÊÄßÔºåÂèØ‰ª•ËßÜ‰∏∫ÊôÆÈÄöÂÅöÂ∏ÇÁéØÂ¢ÉÔºå‰ª•Âü∫Á°Ä Fixed Spread ÈÖçÁΩÆ‰∏∫‰∏ª„ÄÇ';
                        }
                        conditionBadge.innerText = conditionLabel;
                        conditionBadge.style.backgroundColor = badgeBg;
                        conditionBadge.style.color = badgeColor;
                    }
                }

                // Update Strategy UI if not focused (to avoid overwriting user input while typing)
                const strategySelect = document.getElementById('strategySelect');
                if (document.activeElement !== strategySelect && data.strategy_type) {
                    strategySelect.value = data.strategy_type;
                    toggleStrategyParams();
                }

                const skewInput = document.getElementById('skewFactorInput');
                const skewFundingInput = document.getElementById('skewFactorFundingInput');
                if (document.activeElement !== skewInput && data.skew_factor !== undefined) {
                    skewInput.value = data.skew_factor;
                }
                if (skewFundingInput && document.activeElement !== skewFundingInput && data.skew_factor !== undefined) {
                    skewFundingInput.value = data.skew_factor;
                }

                // Sync spread & qty from backend into both tabsÔºå‰øùËØÅÁúãÂà∞ÁöÑÊòØÂºïÊìéÂΩìÂâçÁúüÂÆûÈÖçÁΩÆ
                const spreadInput = document.getElementById('spreadInput');
                const spreadFundingInput = document.getElementById('spreadFundingInput');
                const qtyInputEl = document.getElementById('qtyInput');
                const qtyFundingInput = document.getElementById('qtyFundingInput');
                const spreadFunding = document.getElementById('spreadFunding');
                const skewFunding = document.getElementById('skewFunding');

                if (data.spread !== undefined && data.spread !== null) {
                    const spreadPct = data.spread * 100;
                    // ‰∏ªÊéßÂà∂Èù¢ÊùøËæìÂÖ•ÔºàÈÅøÂÖçÊâìÂ≠óÊó∂Ë¢´Ë¶ÜÁõñÔºâ
                    if (spreadInput && document.activeElement !== spreadInput) {
                        spreadInput.value = spreadPct.toFixed(3);
                    }
                    // Funding Tab ËæìÂÖ•
                    if (spreadFundingInput && document.activeElement !== spreadFundingInput) {
                        spreadFundingInput.value = spreadPct.toFixed(3);
                    }
                    // Funding Tab ÁöÑ„ÄåSpread & Skew„ÄçÂ±ïÁ§∫Âç°Áâá
                    if (spreadFunding) {
                        spreadFunding.innerText = spreadPct.toFixed(3) + '%';
                    }
                }

                if (data.quantity !== undefined && data.quantity !== null) {
                    if (qtyInputEl && document.activeElement !== qtyInputEl) {
                        qtyInputEl.value = data.quantity;
                    }
                    if (qtyFundingInput && document.activeElement !== qtyFundingInput) {
                        qtyFundingInput.value = data.quantity;
                    }
                }

                if (skewFunding && data.skew_factor !== undefined) {
                    skewFunding.innerText = data.skew_factor;
                }

                // Update Leverage Input Max and Value if not focused
                const leverageInput = document.getElementById('leverageInput');
                const leverageFundingInput = document.getElementById('leverageFundingInput');
                if (data.max_leverage) {
                    leverageInput.max = data.max_leverage;
                    if (leverageFundingInput) {
                        leverageFundingInput.max = data.max_leverage;
                    }
                    document.getElementById('leverageRange').innerText = `1-${data.max_leverage}`;
                }
                if (document.activeElement !== leverageInput && data.leverage) {
                    leverageInput.value = data.leverage;
                }
                if (leverageFundingInput && document.activeElement !== leverageFundingInput && data.leverage) {
                    leverageFundingInput.value = data.leverage;
                }

                // Update Qty Input Limits
                if (data.limits) {
                    if (data.limits.minQty && qtyInputEl) qtyInputEl.min = data.limits.minQty;
                    if (data.limits.stepSize && qtyInputEl) qtyInputEl.step = data.limits.stepSize;

                    // Update Binance Constraints Display
                    document.getElementById('constraintMinQty').innerText = data.limits.minQty || '--';
                    document.getElementById('constraintMaxQty').innerText = data.limits.maxQty || '--';
                    document.getElementById('constraintStepSize').innerText = data.limits.stepSize || '--';
                    document.getElementById('constraintMinNotional').innerText = data.limits.minNotional ? data.limits.minNotional.toFixed(2) + ' USDT' : '--';
                }

                // Update Internal Constraints Display
                document.getElementById('constraintMaxPos').innerText = '0.5';  // From config.py MAX_POSITION
                document.getElementById('constraintLeverage').innerText = data.leverage ? data.leverage + 'x' : '--';

                const constraintSpread = document.getElementById('constraintSpread');
                const constraintQty = document.getElementById('constraintQty');
                if (constraintSpread) {
                    if (data.spread !== undefined && data.spread !== null) {
                        const spreadPct = data.spread * 100;
                        constraintSpread.innerText = spreadPct.toFixed(3) + '%';
                    } else if (spreadInput) {
                        constraintSpread.innerText = spreadInput.value + '%';
                    }
                }
                if (constraintQty) {
                    if (data.quantity !== undefined && data.quantity !== null) {
                        constraintQty.innerText = data.quantity;
                    } else if (qtyInputEl) {
                        constraintQty.innerText = qtyInputEl.value;
                    }
                }

                const statusBadge = document.getElementById('botStatus');
                const statusBadgeFunding = document.getElementById('botStatusFunding');
                const errorDisplay = document.getElementById('errorDisplay');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const startFundingBtn = document.getElementById('startFundingBtn');
                const stopFundingBtn = document.getElementById('stopFundingBtn');

                // Update error display
                if (data.error) {
                    errorDisplay.innerText = `Error: ${data.error}`;
                    errorDisplay.style.display = 'block';
                    statusBadge.innerText = "ERROR";
                    statusBadge.className = "status-badge status-error";
                    if (statusBadgeFunding) {
                        statusBadgeFunding.innerText = "ERROR";
                        statusBadgeFunding.className = "status-badge status-error";
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    if (startFundingBtn && stopFundingBtn) {
                        startFundingBtn.disabled = false;
                        stopFundingBtn.disabled = true;
                    }
                } else {
                    errorDisplay.style.display = 'none';

                    if (data.active) {
                        statusBadge.innerText = "RUNNING";
                        statusBadge.className = "status-badge status-active";
                        if (statusBadgeFunding) {
                            statusBadgeFunding.innerText = "RUNNING";
                            statusBadgeFunding.className = "status-badge status-active";
                        }
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        if (startFundingBtn && stopFundingBtn) {
                            startFundingBtn.disabled = true;
                            stopFundingBtn.disabled = false;
                        }
                    } else {
                        statusBadge.innerText = "STOPPED";
                        statusBadge.className = "status-badge status-inactive";
                        if (statusBadgeFunding) {
                            statusBadgeFunding.innerText = "STOPPED";
                            statusBadgeFunding.className = "status-badge status-inactive";
                        }
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        if (startFundingBtn && stopFundingBtn) {
                            startFundingBtn.disabled = false;
                            stopFundingBtn.disabled = true;
                        }
                    }

                    // Update Stage Display
                    const stageDisplay = document.getElementById('stageDisplay');
                    const stageDisplayFunding = document.getElementById('stageDisplayFunding');
                    if (data.stage) {
                        stageDisplay.innerText = data.stage;
                        if (stageDisplayFunding) {
                            stageDisplayFunding.innerText = data.stage;
                        }

                        // Highlight Risk Check
                        if (data.stage === 'Risk Check') {
                            stageDisplay.style.color = '#d97706'; // Amber
                            stageDisplay.innerText = '‚ö†Ô∏è Risk Checking...';
                            if (stageDisplayFunding) {
                                stageDisplayFunding.style.color = '#d97706';
                                stageDisplayFunding.innerText = '‚ö†Ô∏è Risk Checking...';
                            }
                        } else if (data.stage === 'Execution') {
                            stageDisplay.style.color = '#10b981'; // Green
                            if (stageDisplayFunding) {
                                stageDisplayFunding.style.color = '#10b981';
                            }
                        } else {
                            stageDisplay.style.color = '#6b7280'; // Gray
                            if (stageDisplayFunding) {
                                stageDisplayFunding.style.color = '#6b7280';
                            }
                        }
                    }

                    // Update System Logs
                    const logsContainer = document.getElementById('systemLogs');
                    if (data.logs && data.logs.length > 0) {
                        logsContainer.innerHTML = ''; // Clear current
                        data.logs.forEach(log => {
                            const line = document.createElement('div');
                            line.innerHTML = `<span style="color: #6b7280;">[${log.timestamp}]</span> <b>${log.stage}</b>`;
                            logsContainer.appendChild(line);
                        });
                        // Auto-scroll to bottom
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                }

                // Update Alert Display
                const alertDisplay = document.getElementById('alertDisplay');
                if (data.alert) {
                    document.getElementById('alertMessage').innerText = data.alert.message;

                    let suggestionHtml = `<div style="margin-top: 5px;">${data.alert.suggestion || ''}</div>`;

                    // Check for structured suggestions options
                    if (data.alert.options) {
                        suggestionHtml += `<div style="display: flex; gap: 5px; margin-top: 10px;">`;
                        data.alert.options.forEach(opt => {
                            suggestionHtml += `
                                <button class="btn" style="padding: 5px 10px; font-size: 11px; background: #fff; border: 1px solid #d1d5db;"
                                    onclick="applySuggestionOption(${opt.spread})">
                                    <strong>${opt.label}</strong><br>${(opt.spread * 100).toFixed(2)}%
                                </button>
                            `;
                        });
                        suggestionHtml += `</div>`;
                    }

                    document.getElementById('alertSuggestion').innerHTML = suggestionHtml;
                    alertDisplay.style.display = 'block';
                } else {
                    alertDisplay.style.display = 'none';
                }

                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';
                data.orders.forEach(o => {
                    const row = `<tr><td>${o.id}</td><td>${o.side}</td><td>${o.price}</td><td>${o.amount}</td></tr>`;
                    tbody.innerHTML += row;
                });

            } catch (e) {
                console.error(e);
            }
        }

        async function controlBot(action) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const startFundingBtn = document.getElementById('startFundingBtn');
            const stopFundingBtn = document.getElementById('stopFundingBtn');

            // Immediately update button states for responsive feedback
            if (action === 'start') {
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.innerText = 'Starting...';
                }
                if (startFundingBtn) {
                    startFundingBtn.disabled = true;
                    startFundingBtn.innerText = 'Starting...';
                }
            } else {
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.innerText = 'Stopping...';
                }
                if (stopFundingBtn) {
                    stopFundingBtn.disabled = true;
                    stopFundingBtn.innerText = 'Stopping...';
                }
            }

            try {
                await fetch(`/api/control?action=${action}`, { method: 'POST' });
                fetchStatus();
            } catch (e) {
                console.error(e);
            } finally {
                // Reset button text
                if (startBtn) startBtn.innerText = 'Start Bot';
                if (stopBtn) stopBtn.innerText = 'Stop Bot';
                if (startFundingBtn) startFundingBtn.innerText = 'Start Bot';
                if (stopFundingBtn) stopFundingBtn.innerText = 'Stop Bot';
            }
        }

        async function updateConfig() {
            const spread = parseFloat(document.getElementById('spreadInput').value);
            const qty = parseFloat(document.getElementById('qtyInput').value);
            const strategy = document.getElementById('strategySelect').value;
            const skewFactor = parseFloat(document.getElementById('skewFactorInput').value);

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spread,
                        quantity: qty,
                        strategy_type: strategy,
                        skew_factor: skewFactor
                    })
                });

                const data = await res.json();

                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('Config Updated Successfully!', 'success');
                    // Clear alert display if it was showing
                    document.getElementById('alertDisplay').style.display = 'none';
                }
            } catch (e) {
                showToast('Network Error', 'error');
            }
        }

        async function updateFundingConfig() {
            const spreadInput = document.getElementById('spreadFundingInput');
            const qtyInput = document.getElementById('qtyFundingInput');
            const skewInput = document.getElementById('skewFactorFundingInput');

            const spread = parseFloat(spreadInput.value);
            const qty = parseFloat(qtyInput.value);
            const skewFactor = parseFloat(skewInput.value);
            const strategy = 'funding_rate';

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spread,
                        quantity: qty,
                        strategy_type: strategy,
                        skew_factor: skewFactor
                    })
                });

                const data = await res.json();

                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('Funding Config Updated Successfully!', 'success');
                    // ÂêåÊ≠•‰∏ªÊéßÂà∂Èù¢ÊùøÁöÑËæìÂÖ•ÂÄº‰∏éÁ≠ñÁï•ÈÄâÊã©
                    const mainSpread = document.getElementById('spreadInput');
                    const mainQty = document.getElementById('qtyInput');
                    const mainSkew = document.getElementById('skewFactorInput');
                    const strategySelect = document.getElementById('strategySelect');
                    if (mainSpread) mainSpread.value = spreadInput.value;
                    if (mainQty) mainQty.value = qtyInput.value;
                    if (mainSkew) mainSkew.value = skewInput.value;
                    if (strategySelect) {
                        strategySelect.value = strategy;
                        toggleStrategyParams();
                    }
                    document.getElementById('alertDisplay').style.display = 'none';
                }
            } catch (e) {
                showToast('Network Error', 'error');
            }
        }

        async function updateLeverage() {
            const leverage = parseInt(document.getElementById('leverageInput').value);
            if (leverage < 1 || leverage > 125) {
                showToast('Leverage must be between 1 and 125', 'error');
                return;
            }
            const res = await fetch('/api/leverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leverage)
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Leverage updated to ' + leverage + 'x', 'success');
                // Wait a bit for backend to update status
                await new Promise(resolve => setTimeout(resolve, 500));
                fetchStatus();
            }
        }

        async function updateFundingLeverage() {
            const leverageInputFunding = document.getElementById('leverageFundingInput');
            const leverage = parseInt(leverageInputFunding.value);
            if (leverage < 1 || leverage > 125) {
                showToast('Leverage must be between 1 and 125', 'error');
                return;
            }
            const res = await fetch('/api/leverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leverage)
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Leverage updated to ' + leverage + 'x', 'success');
                // ÂêåÊ≠•‰∏ªÊéßÂà∂Èù¢ÊùøÁöÑÊù†ÊùÜËæìÂÖ•
                const mainLev = document.getElementById('leverageInput');
                if (mainLev) mainLev.value = leverageInputFunding.value;
                await new Promise(resolve => setTimeout(resolve, 500));
                fetchStatus();
            }
        }

        async function updatePair() {
            const symbol = document.getElementById('pairSelect').value;
            const res = await fetch('/api/pair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Switched to ' + symbol, 'success');
                // Immediately refresh status to update mid_price and symbol display
                fetchStatus();
                fetchSuggestions(); // Fetch new suggestions for new pair
            }
        }

        async function updateFundingPair() {
            const fundingSelect = document.getElementById('pairSelectFunding');
            if (!fundingSelect) return;
            const symbol = fundingSelect.value;

            // ÂêåÊ≠•‰∏ªÊéßÂà∂Èù¢ÊùøÁöÑ‰∫§ÊòìÂØπÈÄâÊã©
            const mainSelect = document.getElementById('pairSelect');
            if (mainSelect) {
                mainSelect.value = symbol;
            }

            const res = await fetch('/api/pair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });
            const result = await res.json();
            if (result.error) {
                showToast('Error: ' + result.error, 'error');
            } else {
                showToast('Switched to ' + symbol, 'success');
                fetchStatus();
                fetchSuggestions();
            }
        }

        let currentSuggestion = null;

        async function fetchSuggestions() {
            try {
                // Âª∫ËÆÆÂå∫ÂüüÂè™Âú® Trade Tab ‰∏≠Â±ïÁ§∫ÔºõÂ¶ÇÊûúÂΩìÂâç‰∏çÂú®ËØ• TabÔºåÂèØ‰ª•‰øùÊåÅ‰∏äÊ¨°ÁªìÊûúÔºå‰∏çÂøÖÂº∫Âà∂Âà∑Êñ∞
                if (!isTabVisible('tradeTab')) {
                    return;
                }

                const res = await fetch('/api/suggestions');
                const data = await res.json();

                const marketCondEl = document.getElementById('marketCondition');
                const recSpreadEl = document.getElementById('recSpread');
                const recLevEl = document.getElementById('recLeverage');
                const recReasonEl = document.getElementById('recReason');

                if (data.error) {
                    console.error('Suggestions error:', data.error);
                    if (marketCondEl) marketCondEl.innerText = 'Error';
                    if (recSpreadEl) recSpreadEl.innerText = '--';
                    if (recLevEl) recLevEl.innerText = '--';
                    if (recReasonEl) recReasonEl.innerText = data.error;
                    return;
                }

                currentSuggestion = data;

                if (marketCondEl) marketCondEl.innerText = data.condition || 'N/A';
                if (recSpreadEl) recSpreadEl.innerText = (data.spread !== undefined && data.spread !== null ? data.spread + '%' : '--');
                if (recLevEl) recLevEl.innerText = (data.leverage ? data.leverage + 'x' : '--');
                if (recReasonEl) recReasonEl.innerText = data.reason || 'No recommendation available';

            } catch (e) {
                console.error('Error fetching suggestions:', e);
                // Clear loading state even on error
                const marketCondEl = document.getElementById('marketCondition');
                const recSpreadEl = document.getElementById('recSpread');
                const recLevEl = document.getElementById('recLeverage');
                const recReasonEl = document.getElementById('recReason');
                if (marketCondEl) marketCondEl.innerText = 'Error';
                if (recSpreadEl) recSpreadEl.innerText = '--';
                if (recLevEl) recLevEl.innerText = '--';
                if (recReasonEl) recReasonEl.innerText = 'Failed to load suggestions';
            }
        }

        async function applySuggestionOption(spread) {
            document.getElementById('spreadInput').value = spread;
            await updateConfig();
        }

        async function applySuggestion() {
            if (!currentSuggestion) return;

            // Update Inputs
            document.getElementById('spreadInput').value = currentSuggestion.spread;
            document.getElementById('leverageInput').value = currentSuggestion.leverage;

            // Apply Config
            await updateConfig();
            // Apply Leverage
            await updateLeverage();
        }

        async function loadFundingPairs() {
            try {
                const res = await fetch('/api/funding-rates');
                const data = await res.json();

                if (data.error) {
                    console.error('Error loading funding rates:', data.error);
                    return;
                }

                const select = document.getElementById('pairSelectFunding');
                if (!select) return;

                // Get current selection
                const currentSymbol = select.value || 'ETH/USDT:USDT';

                // Build options HTML
                let optionsHTML = '';

                // High funding rate group (top 3 by absolute value)
                const topPairs = data.slice(0, 3);
                if (topPairs.length > 0) {
                    optionsHTML += '<optgroup label="üî• High Funding Rate (Recommended)">';
                    topPairs.forEach(item => {
                        const rate = (item.funding_rate * 100).toFixed(3);
                        const symbol = item.symbol.split('/')[0];
                        const indicator = item.direction === 'short_favored' ? '‚ñº' : item.direction === 'long_favored' ? '‚ñ≤' : '‚îÄ';
                        optionsHTML += `<option value="${item.symbol}">${symbol} [${rate > 0 ? '+' : ''}${rate}%] ${indicator}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }

                // All pairs group
                optionsHTML += '<optgroup label="All Pairs">';
                data.forEach(item => {
                    const rate = (item.funding_rate * 100).toFixed(3);
                    const symbol = item.symbol.split('/')[0];
                    optionsHTML += `<option value="${item.symbol}">${symbol} [${rate > 0 ? '+' : ''}${rate}%]</option>`;
                });
                optionsHTML += '</optgroup>';

                select.innerHTML = optionsHTML;

                // Restore or select highest funding rate pair
                if (data.length > 0) {
                    const hasCurrentSymbol = data.some(item => item.symbol === currentSymbol);
                    select.value = hasCurrentSymbol ? currentSymbol : data[0].symbol;
                }
            } catch (e) {
                console.error('Error loading funding pairs:', e);
            }
        }

        let pnlChart = null;
        let dashPnlChart = null;
        let dashTradeDistChart = null;

        async function fetchPerformance() {
            try {
                // ‰ªÖÂΩìÊúâÈúÄË¶ÅÂ±ïÁ§∫Áª©ÊïàÁöÑ Tab ÂèØËßÅÊó∂ÊâçËØ∑Ê±ÇÔºåÈÅøÂÖçÈ°µÈù¢Á©∫Èó≤Êó∂ÁöÑÊó†Ë∞ìËΩÆËØ¢
                if (!isTabVisible('tradeTab') && !isTabVisible('dashboardTab') && !isTabVisible('fundingTab')) {
                    return;
                }

                const res = await fetch('/api/performance');
                const data = await res.json();

                if (data.error) return;

                // Update Trade Tab Metrics (existing)
                document.getElementById('realizedPnl').innerText = data.realized_pnl ? data.realized_pnl.toFixed(4) + ' USDT' : '0.0000 USDT';
                document.getElementById('totalTrades').innerText = data.total_trades || 0;
                document.getElementById('winRate').innerText = data.win_rate ? data.win_rate.toFixed(2) + '%' : '0.00%';

                // Update Dashboard Metrics
                if (document.getElementById('dashRealizedPnl')) {
                    document.getElementById('dashRealizedPnl').innerText = data.realized_pnl ? data.realized_pnl.toFixed(4) + ' USDT' : '0.0000 USDT';
                    document.getElementById('dashWinRate').innerText = data.win_rate ? data.win_rate.toFixed(2) + '%' : '0.00%';
                    document.getElementById('dashTotalTrades').innerText = data.total_trades || 0;

                    // Metrics from DataAgent
                    const metrics = data.metrics || {};
                    document.getElementById('dashSharpe').innerText = metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : '0.00';
                    document.getElementById('dashLatency').innerText = metrics.tick_to_trade_latency ? metrics.tick_to_trade_latency.toFixed(2) + 'ms' : 'N/A';
                    document.getElementById('dashSlippage').innerText = metrics.slippage_bps ? metrics.slippage_bps.toFixed(2) + ' bps' : '0 bps';
                    document.getElementById('dashFillRate').innerText = metrics.fill_rate ? (metrics.fill_rate * 100).toFixed(1) + '%' : 'N/A';

                    // Mock Drawdown for now if not in metrics
                    document.getElementById('dashDrawdown').innerText = '0.00%';
                }

                // Update Charts
                updatePnLChart(data.pnl_history || [], 'pnlChart'); // Trade Tab Chart
                updatePnLChart(data.pnl_history || [], 'dashPnlChart'); // Dashboard Chart
                updateTradeDistChart(data.winning_trades, data.losing_trades);

            } catch (e) {
                console.error(e);
            }
        }

        function updatePnLChart(pnlHistory, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let chartInstance = canvasId === 'pnlChart' ? pnlChart : dashPnlChart;

            // Extract labels (timestamps) and data (pnl values)
            const labels = pnlHistory.map(item => {
                const date = new Date(item[0]);
                return date.toLocaleTimeString();
            });
            const data = pnlHistory.map(item => item[1]);

            if (chartInstance) {
                // Update existing chart
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update('none'); // 'none' for no animation
            } else {
                // Create new chart
                const newChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Realized PnL (USDT)',
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value.toFixed(2) + ' USDT';
                                    }
                                }
                            },
                            x: {
                                display: true
                            }
                        }
                    }
                });

                if (canvasId === 'pnlChart') {
                    pnlChart = newChart;
                } else {
                    dashPnlChart = newChart;
                }
            }
        }

        function updateTradeDistChart(winning, losing) {
            const ctx = document.getElementById('dashTradeDistChart').getContext('2d');

            if (dashTradeDistChart) {
                dashTradeDistChart.data.datasets[0].data = [winning, losing];
                dashTradeDistChart.update();
            } else {
                dashTradeDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Winning', 'Losing'],
                        datasets: [{
                            data: [winning, losing],
                            backgroundColor: ['#10b981', '#ef4444'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        async function fetchOrderHistory() {
            try {
                // ËÆ¢ÂçïÂéÜÂè≤Âè™Âú® Trade Tab ‰∏≠Â±ïÁ§∫
                if (!isTabVisible('tradeTab')) {
                    return;
                }
                const symbolFilter = document.getElementById('historySymbolFilter').value;
                const statusFilter = document.getElementById('historyStatusFilter').value;
                const timeFilter = document.getElementById('historyTimeFilter').value;

                let url = '/api/order-history?';
                if (symbolFilter) url += `symbol=${symbolFilter}&`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const orders = await res.json();

                const tbody = document.getElementById('orderHistoryBody');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const time = new Date(order.timestamp * 1000).toLocaleTimeString();
                    let statusColor = '#3b82f6'; // Default Blue (Placed)
                    let statusText = order.status.toUpperCase();

                    if (order.status === 'cancelled') {
                        statusColor = '#9ca3af'; // Gray
                    } else if (order.status === 'filled') {
                        statusColor = '#10b981'; // Green
                    }

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${time}</td>
                            <td style="padding: 8px;">${order.symbol}</td>
                            <td style="padding: 8px; color: ${order.side === 'buy' ? '#10b981' : '#ef4444'}; font-weight: bold;">${order.side.toUpperCase()}</td>
                            <td style="padding: 8px; text-align: right;">${order.price.toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${order.quantity.toFixed(4)}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching order history:', e);
            }
        }

        async function fetchFundingOrderHistory() {
            try {
                // Funding Á≠ñÁï•ËÆ¢ÂçïÂéÜÂè≤Âè™Âú® Funding Tab ÂèØËßÅÊó∂ËØ∑Ê±Ç
                if (!isTabVisible('fundingTab')) {
                    return;
                }
                const statusFilter = document.getElementById('fundingHistoryStatusFilter').value;
                const timeFilter = document.getElementById('fundingHistoryTimeFilter').value;

                // ÈªòËÆ§ËøêË°å ETHUSDT ÁöÑ Funding Á≠ñÁï•Ôºå‰πüÂèØ‰ª•Áî®ÂΩìÂâç Funding Tab ÁöÑ symbol
                const currentSymbolFunding = document.getElementById('currentSymbolFunding').innerText || '';
                const symbolParam = currentSymbolFunding || 'ETH/USDT:USDT';

                let url = `/api/order-history?symbol=${encodeURIComponent(symbolParam)}&strategy_type=funding_rate&`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (timeFilter) {
                    const fromTime = Date.now() / 1000 - parseInt(timeFilter);
                    url += `from_time=${fromTime}&`;
                }

                const res = await fetch(url);
                const orders = await res.json();

                const tbody = document.getElementById('fundingOrderHistoryBody');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No funding strategy orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const time = new Date(order.timestamp * 1000).toLocaleTimeString();
                    let statusColor = '#3b82f6'; // Default Blue (Placed)
                    let statusText = order.status.toUpperCase();

                    if (order.status === 'cancelled') {
                        statusColor = '#9ca3af'; // Gray
                    } else if (order.status === 'filled') {
                        statusColor = '#10b981'; // Green
                    }

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${time}</td>
                            <td style="padding: 8px;">${order.symbol}</td>
                            <td style="padding: 8px; color: ${order.side === 'buy' ? '#10b981' : '#ef4444'}; font-weight: bold;">${order.side.toUpperCase()}</td>
                            <td style="padding: 8px; text-align: right;">${order.price.toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${order.quantity.toFixed(4)}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error fetching funding order history:', e);
            }
        }

        // Poll every 1 second
        setInterval(fetchStatus, 1000);
        setInterval(fetchSuggestions, 5000); // Fetch suggestions every 5s
        setInterval(fetchPerformance, 2000); // Fetch performance every 2s
        setInterval(fetchOrderHistory, 3000); // Fetch order history every 3s
        setInterval(fetchFundingOrderHistory, 3000); // Fetch funding strategy order history every 3s
        setInterval(loadFundingPairs, 60000); // Reload funding pairs every 60s
        fetchStatus();
        fetchSuggestions();
        fetchPerformance();
        fetchOrderHistory();
        fetchFundingOrderHistory();
        loadFundingPairs(); // Initial load of funding pairs
    </script>
</body>

</html>