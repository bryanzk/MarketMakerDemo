<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Hyperliquid Trading Page / Hyperliquid äº¤æ˜“é¡µé¢</title>
    <style>
        body {
            margin: 0;
            font-family: "Inter", "PingFang SC", sans-serif;
            background: #f5f5fa;
            color: #1f2937;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .panel {
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
            padding: 24px;
            margin-bottom: 24px;
        }

        .panel h2 {
            margin: 0 0 16px;
            font-size: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        label {
            font-size: 13px;
            color: #6b7280;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            box-sizing: border-box;
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary {
            background: #4f46e5;
            color: #fff;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-success {
            background: #22c55e;
            color: #fff;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table th,
        table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .message {
            margin-top: 12px;
            font-size: 13px;
        }

        .message.error {
            color: #b91c1c;
        }

        .message.success {
            color: #059669;
        }

        .consensus-card {
            border: 1px dashed #c4b5fd;
            padding: 12px;
            border-radius: 10px;
            background: #f5f3ff;
            margin-top: 16px;
        }

        .nav-link {
            font-size: 14px;
            padding: 8px 14px;
            border-radius: 999px;
            background: #eef2ff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .info-card {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
    </style>
    <!-- Error handling styles / é”™è¯¯å¤„ç†æ ·å¼ -->
    <link rel="stylesheet" href="/static/error_styles.css">
    <link rel="stylesheet" href="/static/debug_panel.css">
    <link rel="stylesheet" href="/static/validation.css">
    <link rel="stylesheet" href="/static/error_history.css">
    <!-- API Diagnostics and Error Handler / API è¯Šæ–­å’Œé”™è¯¯å¤„ç† -->
    <script src="/static/api_diagnostics.js"></script>
    <script src="/static/error_handler.js"></script>
    <script src="/static/debug_panel.js"></script>
    <script src="/static/validation.js"></script>
    <script src="/static/error_history.js"></script>
</head>

<body>
    <div class="page">
        <header>
            <div>
                <h1 style="margin:0;">Hyperliquid Trading Page / Hyperliquid äº¤æ˜“é¡µé¢</h1>
                <div style="font-size:13px; color:#6b7280;">Dedicated interface for Hyperliquid exchange trading / ä¸“ç”¨ Hyperliquid äº¤æ˜“æ‰€äº¤æ˜“ç•Œé¢</div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <span id="connectionStatus" class="status-badge status-disconnected">Checking...</span>
                <a class="nav-link" href="/">â† Back to Dashboard</a>
            </div>
        </header>

        <!-- Connection Status Panel / è¿æ¥çŠ¶æ€é¢æ¿ -->
        <section class="panel">
            <h2>Connection Status / è¿æ¥çŠ¶æ€</h2>
            <div id="connectionInfo" class="info-card">
                <div>Exchange: <strong>Hyperliquid</strong></div>
                <div id="connectionDetails" style="margin-top:8px; font-size:13px; color:#6b7280;">Loading connection status...</div>
            </div>
        </section>

        <!-- Position and Balance Panel / ä»“ä½ä¸ä½™é¢é¢æ¿ -->
        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">Position & Balance / ä»“ä½ä¸ä½™é¢</h2>
                <button class="btn btn-secondary" onclick="refreshPosition()">ğŸ”„ Refresh</button>
            </div>
            <div id="positionStatus" class="message" style="color:#6b7280; margin-top:12px;">Loading position data...</div>
            <div id="positionData" style="display:none; margin-top:16px;">
                <div class="grid">
                    <div>
                        <label>Total Balance / æ€»ä½™é¢</label>
                        <div style="font-size:20px; font-weight:bold;" id="totalBalance">--</div>
                    </div>
                    <div>
                        <label>Available Balance / å¯ç”¨ä½™é¢</label>
                        <div style="font-size:20px; font-weight:bold;" id="availableBalance">--</div>
                    </div>
                    <div>
                        <label>Position Amount / ä»“ä½æ•°é‡</label>
                        <div style="font-size:20px; font-weight:bold;" id="positionAmount">--</div>
                    </div>
                    <div>
                        <label>Unrealized PnL / æœªå®ç°ç›ˆäº</label>
                        <div style="font-size:20px; font-weight:bold;" id="unrealizedPnL">--</div>
                    </div>
                </div>
                <div style="margin-top:16px;">
                    <h3 style="font-size:14px; margin-bottom:8px;">Open Positions / æœªå¹³ä»“</h3>
                    <div id="positionsTable" style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr style="background:#f3f4f6;">
                                    <th>Symbol / äº¤æ˜“å¯¹</th>
                                    <th>Side / æ–¹å‘</th>
                                    <th>Size / æ•°é‡</th>
                                    <th>Entry Price / å…¥åœºä»·</th>
                                    <th>Mark Price / æ ‡è®°ä»·</th>
                                    <th>PnL / ç›ˆäº</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                <tr><td colspan="6" style="text-align:center; color:#6b7280;">No open positions / æ— æœªå¹³ä»“</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Strategy Control Panel / ç­–ç•¥æ§åˆ¶é¢æ¿ -->
        <section class="panel">
            <h2>Fixed Spread Strategy Control Panel / å›ºå®šä»·å·®ç­–ç•¥æ§åˆ¶é¢æ¿</h2>
            <div class="grid">
                <div>
                    <label>Trading Pair / äº¤æ˜“å¯¹</label>
                    <div style="display:flex; gap:8px;">
                        <select id="pairSelect">
                            <option value="ETH/USDT:USDT">ETH/USDT:USDT</option>
                            <option value="BTC/USDT:USDT">BTC/USDT:USDT</option>
                            <option value="SOL/USDT:USDT">SOL/USDT:USDT</option>
                        </select>
                        <button class="btn btn-secondary" onclick="switchPair()">Switch</button>
                    </div>
                </div>
            </div>
            <div class="grid" style="margin-top: 16px;">
                <div>
                    <label>Spread (%) / ä»·å·® (%)</label>
                    <input type="number" id="spreadInput" step="0.01" value="1.5">
                </div>
                <div>
                    <label>Quantity / æ•°é‡</label>
                    <input type="number" id="quantityInput" step="0.01" value="0.1">
                </div>
                <div>
                    <label>Skew Factor / å€¾æ–œå› å­</label>
                    <input type="number" id="skewInput" step="5" value="120">
                </div>
                <div>
                    <label>Leverage / æ æ†</label>
                    <input type="number" id="leverageInput" min="1" max="125" value="5">
                </div>
            </div>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn btn-primary" onclick="updateConfig()">ğŸ’¾ Save Strategy Config</button>
                <button class="btn btn-secondary" onclick="updateLeverage()">âš¡ Update Leverage</button>
            </div>
            <div id="controlMessage" class="message"></div>
        </section>

        <!-- LLM Evaluation Panel / LLM è¯„ä¼°é¢æ¿ -->
        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0;">Multi-LLM Evaluation / å¤šæ¨¡å‹è¯„ä¼°</h2>
                    <div style="font-size:13px; color:#6b7280;">Gemini Â· OpenAI Â· Claude (Hyperliquid Context)</div>
                </div>
                <button id="runEvaluationBtn" class="btn btn-primary" onclick="runEvaluation()">ğŸš€ Run Evaluation</button>
            </div>
            <div id="evaluationStatusText" class="message" style="color:#6b7280; margin-top:12px;">Ready.</div>
            <div id="evaluationErrorBox" class="message error" style="display:none;"></div>

            <div id="evaluationConsensusCard" class="consensus-card" style="display:none;">
                <div style="font-size:14px; font-weight:bold; color:#6d28d9;">ğŸ¤ Consensus Recommendation / å…±è¯†å»ºè®®</div>
                <div style="margin-top:8px; font-size:13px;">
                    <div>Strategy: <span id="evaluationConsensusStrategy" style="font-weight:bold;">--</span></div>
                    <div>Spread / Skew / Qty / Lev:
                        <span id="evaluationConsensusParams" style="font-weight:bold;">--</span>
                    </div>
                </div>
                <div id="evaluationConsensusStats" style="margin-top:6px; font-size:12px; color:#4b5563;">--</div>
                <div id="evaluationConsensusReasoning" style="margin-top:8px; font-size:12px; color:#6b7280;">--</div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn btn-success" style="flex:1;"
                        onclick="applyEvaluation('consensus')">Apply Consensus</button>
                    <button class="btn btn-primary" style="flex:1;"
                        onclick="startBotWithLLMSuggestion()">ğŸš€ Start Bot</button>
                </div>
            </div>

            <div id="evaluationResultsWrapper" style="margin-top:20px; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:13px; font-weight:bold;">Model Comparison / æ¨¡å‹å¯¹æ¯”</div>
                    <div id="evaluationLastRun" style="font-size:11px; color:#6b7280;"></div>
                </div>
                <div style="overflow-x:auto; margin-top:8px;">
                    <table>
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th>Rank</th>
                                <th>Provider</th>
                                <th>Strategy</th>
                                <th>Spread</th>
                                <th>Skew</th>
                                <th>Qty</th>
                                <th>Lev</th>
                                <th>Confidence</th>
                                <th>PnL</th>
                                <th>Sharpe</th>
                                <th>Win%</th>
                                <th>Score</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="evaluationResultsBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Orders Panel / è®¢å•é¢æ¿ -->
        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0;">Current Orders / å½“å‰è®¢å•</h2>
                    <div style="font-size:13px; color:#6b7280;">Real-time order status</div>
                </div>
                <button class="btn btn-secondary" onclick="refreshOrders()">ğŸ”„ Refresh</button>
            </div>
            <div id="ordersStatusText" class="message" style="color:#6b7280; margin-top:12px;">Loading orders...</div>
            <div id="ordersTableWrapper" style="margin-top:16px; display:none;">
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th>Order ID</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
                <div id="ordersEmptyMessage" style="text-align:center; padding:24px; color:#6b7280; display:none;">
                    No active orders / æ— æ´»è·ƒè®¢å•
                </div>
            </div>
        </section>

        <!-- Error History Panel / é”™è¯¯å†å²é¢æ¿ -->
        <section class="panel">
            <div id="errorHistoryPanel"></div>
        </section>
    </div>

    <script>
        const controlMessage = document.getElementById('controlMessage');
        let currentEvalSymbol = 'ETHUSDT';
        let evaluationState = {
            loading: false,
            results: [],
            aggregated: null,
            lastError: null,
            lastRunSymbol: null,
            lastRunAt: null,
        };

        function showMessage(el, text, isError = false) {
            if (!el) return;
            el.innerText = text;
            el.classList.toggle('error', isError);
            el.classList.toggle('success', !isError);
        }

        function normalizeSymbol(symbol) {
            if (!symbol) return 'ETHUSDT';
            return symbol.toUpperCase().replace(/[:\/-]/g, '');
        }

        // Connection Status / è¿æ¥çŠ¶æ€
        async function checkConnection() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                // Try to get exchange status by calling evaluation API with hyperliquid
                // å°è¯•é€šè¿‡è°ƒç”¨ hyperliquid çš„è¯„ä¼° API è·å–äº¤æ˜“æ‰€çŠ¶æ€
                const res = await diagnosticFetch('/api/evaluation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: 'ETH/USDT:USDT',
                        exchange: 'hyperliquid',
                        simulation_steps: 1
                    }),
                });
                const data = await res.json();
                
                const statusEl = document.getElementById('connectionStatus');
                const detailsEl = document.getElementById('connectionDetails');
                
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    if (data.error && (data.error.includes('not connected') || data.error.includes('æœªè¿æ¥'))) {
                        statusEl.className = 'status-badge status-disconnected';
                        statusEl.innerText = 'Disconnected / æœªè¿æ¥';
                        detailsEl.innerHTML = '<span style="color:#991b1b;">Hyperliquid exchange is not connected. Please connect first. / Hyperliquid äº¤æ˜“æ‰€æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥ã€‚</span>';
                    } else {
                        statusEl.className = 'status-badge status-disconnected';
                        statusEl.innerText = 'Error / é”™è¯¯';
                    }
                } else {
                    statusEl.className = 'status-badge status-connected';
                    statusEl.innerText = 'Connected / å·²è¿æ¥';
                    const symbol = data.market_data?.symbol || 'N/A';
                    const price = data.market_data?.mid_price || 0;
                    detailsEl.innerHTML = `Symbol: <strong>${symbol}</strong> | Price: <strong>$${price.toFixed(2)}</strong>`;
                }
            } catch (err) {
                displayError(err, errorBox);
                const statusEl = document.getElementById('connectionStatus');
                const detailsEl = document.getElementById('connectionDetails');
                statusEl.className = 'status-badge status-disconnected';
                statusEl.innerText = 'Error / é”™è¯¯';
            }
        }

        // Position and Balance / ä»“ä½ä¸ä½™é¢
        async function refreshPosition() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                const statusEl = document.getElementById('positionStatus');
                statusEl.innerText = 'Loading position data...';
                
                // Get status which should include position info
                const res = await diagnosticFetch('/api/hyperliquid/status');
                const data = await res.json();
                
                const positionData = document.getElementById('positionData');
                const totalBalanceEl = document.getElementById('totalBalance');
                const availableBalanceEl = document.getElementById('availableBalance');
                const positionAmountEl = document.getElementById('positionAmount');
                const unrealizedPnLEl = document.getElementById('unrealizedPnL');
                
                if (data.balance !== undefined) {
                    positionData.style.display = 'block';
                    totalBalanceEl.innerText = `$${data.balance.toFixed(2)}`;
                    availableBalanceEl.innerText = `$${(data.balance - (data.position || 0) * (data.mid_price || 0)).toFixed(2)}`;
                    positionAmountEl.innerText = `${(data.position || 0).toFixed(4)}`;
                    unrealizedPnLEl.innerText = `$${((data.unrealized_pnl || 0)).toFixed(2)}`;
                    statusEl.innerText = 'Position data loaded / ä»“ä½æ•°æ®å·²åŠ è½½';
                } else {
                    positionData.style.display = 'none';
                    statusEl.innerText = 'Position data not available / ä»“ä½æ•°æ®ä¸å¯ç”¨';
                }
            } catch (err) {
                displayError(err, errorBox);
                const statusEl = document.getElementById('positionStatus');
                statusEl.innerText = `Error: ${err.message}`;
                statusEl.classList.add('error');
            }
        }

        async function loadStatus() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                const res = await diagnosticFetch('/api/status');
                const data = await res.json();
                
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                if (data.spread !== undefined) {
                    document.getElementById('spreadInput').value = (data.spread * 100).toFixed(3);
                }
                document.getElementById('quantityInput').value = data.quantity ?? 0.1;
                if (data.skew_factor !== undefined) {
                    document.getElementById('skewInput').value = data.skew_factor;
                }
                document.getElementById('leverageInput').value = data.leverage ?? 5;
                currentEvalSymbol = normalizeSymbol(data.symbol);

                const pairSelect = document.getElementById('pairSelect');
                if (pairSelect && data.symbol) {
                    for (const option of pairSelect.options) {
                        if (option.value.toUpperCase() === data.symbol.toUpperCase()) {
                            pairSelect.value = option.value;
                            break;
                        }
                    }
                }
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, `Failed to load status: ${err.message}`, true);
            }
        }

        async function updateConfig() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            clearValidationErrors(errorBox);
            
            // Validate inputs / éªŒè¯è¾“å…¥
            const spread = parseFloat(document.getElementById('spreadInput').value || '0');
            const quantity = parseFloat(document.getElementById('quantityInput').value || '0');
            
            const validation = validateOrder({
                spread: spread,
                quantity: quantity
            });
            
            if (!validation.valid) {
                displayValidationErrors(validation, errorBox);
                return;
            }
            
            try {
                const payload = {
                    spread: spread,
                    quantity: quantity,
                    strategy_type: 'fixed_spread',
                    strategy_id: 'default',
                    skew_factor: parseFloat(document.getElementById('skewInput').value || '0'),
                };
                const res = await diagnosticFetch('/api/hyperliquid/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, 'Strategy config updated. / ç­–ç•¥é…ç½®å·²æ›´æ–°ã€‚');
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to update config / æ›´æ–°é…ç½®å¤±è´¥', true);
            }
        }

        async function updateLeverage() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            clearValidationErrors(errorBox);
            
            // Validate leverage / éªŒè¯æ æ†
            const leverage = parseInt(document.getElementById('leverageInput').value || '1', 10);
            const validation = validateLeverage(leverage);
            
            if (!validation.valid) {
                displayValidationErrors(validation, errorBox);
                return;
            }
            
            try {
                const res = await diagnosticFetch('/api/hyperliquid/leverage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leverage),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, `Leverage updated to ${data.leverage}x / æ æ†å·²æ›´æ–°è‡³ ${data.leverage}x`);
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to update leverage / æ›´æ–°æ æ†å¤±è´¥', true);
            }
        }

        async function switchPair() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            clearValidationErrors(errorBox);
            
            // Validate symbol / éªŒè¯äº¤æ˜“å¯¹
            const symbol = document.getElementById('pairSelect').value;
            const validation = validateSymbol(symbol);
            
            if (!validation.valid) {
                displayValidationErrors(validation, errorBox);
                return;
            }
            
            try {
                const res = await diagnosticFetch('/api/hyperliquid/pair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol }),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                currentEvalSymbol = normalizeSymbol(symbol);
                showMessage(controlMessage, `Switched to ${symbol} / å·²åˆ‡æ¢åˆ° ${symbol}`);
                loadStatus();
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to switch pair / åˆ‡æ¢äº¤æ˜“å¯¹å¤±è´¥', true);
            }
        }

        function getEvaluationSymbol() {
            const select = document.getElementById('pairSelect');
            const raw = select && select.value ? select.value : currentEvalSymbol;
            return normalizeSymbol(raw);
        }

        function formatPercent(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `${(value * 100).toFixed(decimals)}%`;
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return Number(value).toFixed(decimals);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `$${Number(value).toFixed(2)}`;
        }

        function updateEvaluationUI() {
            const statusEl = document.getElementById('evaluationStatusText');
            const runBtn = document.getElementById('runEvaluationBtn');
            const errorBox = document.getElementById('evaluationErrorBox');
            const consensusCard = document.getElementById('evaluationConsensusCard');
            const resultsWrapper = document.getElementById('evaluationResultsWrapper');
            const resultsBody = document.getElementById('evaluationResultsBody');
            const lastRunEl = document.getElementById('evaluationLastRun');

            if (runBtn) runBtn.disabled = evaluationState.loading;
            if (evaluationState.loading) {
                statusEl.innerText = 'Running evaluation... Please wait. / æ­£åœ¨è¿è¡Œè¯„ä¼°... è¯·ç¨å€™ã€‚';
            } else if (evaluationState.lastRunAt) {
                statusEl.innerText = `Last run: ${evaluationState.lastRunSymbol} @ ${new Date(evaluationState.lastRunAt).toLocaleTimeString()} / ä¸Šæ¬¡è¿è¡Œ: ${evaluationState.lastRunSymbol} @ ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`;
            } else {
                statusEl.innerText = 'Ready. / å°±ç»ªã€‚';
            }

            if (evaluationState.lastError) {
                errorBox.style.display = 'block';
                errorBox.innerText = evaluationState.lastError;
            } else {
                errorBox.style.display = 'none';
            }

            if (consensusCard) {
                const aggregated = evaluationState.aggregated;
                if (aggregated && aggregated.consensus_proposal && aggregated.strategy_consensus) {
                    const proposal = aggregated.consensus_proposal;
                    consensusCard.style.display = 'block';
                    document.getElementById('evaluationConsensusStrategy').innerText = proposal.recommended_strategy || '--';
                    document.getElementById('evaluationConsensusParams').innerText =
                        `${formatPercent(proposal.spread || 0, 2)} Â· Skew ${formatNumber(proposal.skew_factor || 0, 0)} Â· Qty ${formatNumber(proposal.quantity || 0, 3)} Â· Lev ${formatNumber(proposal.leverage || 0, 1)}x`;
                    document.getElementById('evaluationConsensusReasoning').innerText =
                        proposal.reasoning || 'Consensus reasoning unavailable. / å…±è¯†æ¨ç†ä¸å¯ç”¨ã€‚';
                    document.getElementById('evaluationConsensusStats').innerText =
                        `Avg PnL ${formatCurrency(aggregated.avg_pnl || 0)} Â· Avg Sharpe ${formatNumber(aggregated.avg_sharpe || 0, 2)} Â· Avg Win ${formatPercent(aggregated.avg_win_rate || 0, 1)}`;
                } else {
                    consensusCard.style.display = 'none';
                }
            }

            if (resultsWrapper) {
                if (evaluationState.results.length > 0) {
                    resultsWrapper.style.display = 'block';
                    lastRunEl.innerText = evaluationState.lastRunAt
                        ? `Updated ${new Date(evaluationState.lastRunAt).toLocaleTimeString()} / æ›´æ–°äº ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`
                        : '';
                    const rows = evaluationState.results.map((result) => {
                        const proposal = result.proposal || {};
                        const simulation = result.simulation || {};
                        const disabledApply = !proposal.parse_success ? 'disabled' : '';
                        const providerSafe = (result.provider_name || '').replace(/"/g, '&quot;');
                        const highlight = result.rank === 1 ? 'style="background:#fef3c7;"' : '';
                        return `
                            <tr ${highlight}>
                                <td>${result.rank ?? '--'}</td>
                                <td>${result.provider_name || '--'}</td>
                                <td>${proposal.recommended_strategy || '--'}</td>
                                <td>${formatPercent(proposal.spread || 0, 2)}</td>
                                <td>${formatNumber(proposal.skew_factor || 0, 0)}</td>
                                <td>${formatNumber(proposal.quantity || 0, 3)}</td>
                                <td>${formatNumber(proposal.leverage || 0, 1)}x</td>
                                <td>${formatPercent(proposal.confidence || 0, 1)}</td>
                                <td>${formatCurrency(simulation.realized_pnl)}</td>
                                <td>${formatNumber(simulation.sharpe_ratio || 0, 2)}</td>
                                <td>${formatPercent(simulation.win_rate || 0, 1)}</td>
                                <td>${formatNumber(result.score || 0, 1)}</td>
                                <td><button class="btn btn-secondary" style="font-size:11px;" ${disabledApply}
                                    onclick="applyEvaluation('individual', '${providerSafe}')">Apply</button></td>
                            </tr>`;
                    }).join('');
                    resultsBody.innerHTML = rows;
                } else {
                    resultsWrapper.style.display = 'none';
                    lastRunEl.innerText = '';
                }
            }
        }

        async function runEvaluation() {
            if (evaluationState.loading) return;
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            evaluationState.loading = true;
            evaluationState.lastError = null;
            updateEvaluationUI();
            try {
                const res = await diagnosticFetch('/api/evaluation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: getEvaluationSymbol(),
                        exchange: 'hyperliquid',  // Always use hyperliquid exchange
                        simulation_steps: 500
                    }),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    evaluationState.lastError = data.message || data.error || 'Failed to run evaluation / è¿è¡Œè¯„ä¼°å¤±è´¥';
                } else {
                    evaluationState.results = data.individual_results || [];
                    evaluationState.aggregated = data.aggregated || null;
                    evaluationState.lastRunSymbol = data.symbol || getEvaluationSymbol();
                    evaluationState.lastRunAt = new Date().toISOString();
                }
            } catch (err) {
                displayError(err, errorBox);
                evaluationState.lastError = err.message || 'Failed to run evaluation / è¿è¡Œè¯„ä¼°å¤±è´¥';
            } finally {
                evaluationState.loading = false;
                updateEvaluationUI();
            }
        }

        async function applyEvaluation(source, providerName = null) {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                const payload = { 
                    source,
                    exchange: 'hyperliquid'  // Always use hyperliquid exchange
                };
                if (providerName) payload.provider_name = providerName;
                const res = await diagnosticFetch('/api/evaluation/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, 'Applied evaluation proposal. / å·²åº”ç”¨è¯„ä¼°å»ºè®®ã€‚');
                loadStatus();
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to apply proposal / åº”ç”¨å»ºè®®å¤±è´¥', true);
            }
        }

        async function startBotWithLLMSuggestion() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                await applyEvaluation('consensus');
                const res = await diagnosticFetch('/api/control?action=start', {
                    method: 'POST',
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, 'âœ… Bot started with LLM suggestion! / Bot å·²ä½¿ç”¨ LLM å»ºè®®å¯åŠ¨ï¼');
                setTimeout(refreshOrders, 1000);
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to start bot / å¯åŠ¨ Bot å¤±è´¥', true);
            }
        }

        async function refreshOrders() {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                const statusEl = document.getElementById('ordersStatusText');
                const tableWrapper = document.getElementById('ordersTableWrapper');
                const tableBody = document.getElementById('ordersTableBody');
                const emptyMessage = document.getElementById('ordersEmptyMessage');
                
                statusEl.innerText = 'Loading orders... / æ­£åœ¨åŠ è½½è®¢å•...';
                
                const res = await diagnosticFetch('/api/hyperliquid/status');
                const data = await res.json();
                
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                
                const orders = data.orders || [];
                
                if (orders.length === 0) {
                    tableWrapper.style.display = 'none';
                    emptyMessage.style.display = 'block';
                    statusEl.innerText = 'No active orders / æ— æ´»è·ƒè®¢å•';
                } else {
                    tableWrapper.style.display = 'block';
                    emptyMessage.style.display = 'none';
                    statusEl.innerText = `Found ${orders.length} active order(s) / æ‰¾åˆ° ${orders.length} ä¸ªæ´»è·ƒè®¢å•`;
                    
                    const rows = orders.map(order => {
                        const orderId = order.id || order.orderId || '--';
                        const side = order.side || '--';
                        const price = formatNumber(order.price || 0, 4);
                        const quantity = formatNumber(order.amount || order.quantity || 0, 4);
                        const status = order.status || 'open';
                        const timestamp = order.timestamp ? new Date(order.timestamp).toLocaleTimeString() : '--';
                        
                        const sideColor = side.toLowerCase() === 'buy' ? '#22c55e' : '#ef4444';
                        
                        return `
                            <tr>
                                <td style="font-family:monospace; font-size:11px;">${orderId.substring(0, 20)}${orderId.length > 20 ? '...' : ''}</td>
                                <td><span style="color:${sideColor}; font-weight:bold;">${side.toUpperCase()}</span></td>
                                <td>${price}</td>
                                <td>${quantity}</td>
                                <td><span style="padding:2px 6px; border-radius:4px; background:#e5e7eb; font-size:11px;">${status}</span></td>
                                <td style="font-size:11px; color:#6b7280;">${timestamp}</td>
                                <td><button class="btn btn-danger" style="font-size:11px; padding:4px 8px;" onclick="cancelOrder('${orderId}')">Cancel</button></td>
                            </tr>`;
                    }).join('');
                    
                    tableBody.innerHTML = rows;
                }
            } catch (err) {
                displayError(err, errorBox);
                const statusEl = document.getElementById('ordersStatusText');
                statusEl.innerText = `Error loading orders: ${err.message} / åŠ è½½è®¢å•é”™è¯¯: ${err.message}`;
                statusEl.classList.add('error');
            }
        }

        async function cancelOrder(orderId) {
            const errorBox = document.getElementById('evaluationErrorBox');
            clearError(errorBox);
            
            try {
                const res = await diagnosticFetch('/api/hyperliquid/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId }),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, 'Order cancelled successfully. / è®¢å•å·²æˆåŠŸå–æ¶ˆã€‚');
                setTimeout(refreshOrders, 500);
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to cancel order / å–æ¶ˆè®¢å•å¤±è´¥', true);
            }
        }

        // Auto-refresh
        let ordersRefreshInterval = null;
        let positionRefreshInterval = null;
        function startAutoRefresh() {
            if (ordersRefreshInterval) clearInterval(ordersRefreshInterval);
            if (positionRefreshInterval) clearInterval(positionRefreshInterval);
            refreshOrders();
            refreshPosition();
            checkConnection();
            ordersRefreshInterval = setInterval(refreshOrders, 3000);
            positionRefreshInterval = setInterval(refreshPosition, 5000);
            setInterval(checkConnection, 10000);  // Check connection every 10 seconds
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            updateEvaluationUI();
            checkConnection();
            refreshPosition();
            refreshOrders();
            startAutoRefresh();
            
            // Initialize error history panel / åˆå§‹åŒ–é”™è¯¯å†å²é¢æ¿
            if (window.ErrorHistoryPanel) {
                new ErrorHistoryPanel('errorHistoryPanel', {
                    autoRefresh: true,
                    refreshInterval: 5000,
                    showTraceId: true
                });
            }
        });
    </script>
</body>

</html>




