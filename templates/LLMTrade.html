<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>LLM Trade Lab</title>
    <style>
        body {
            margin: 0;
            font-family: "Inter", "PingFang SC", sans-serif;
            background: #f5f5fa;
            color: #1f2937;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .panel {
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
            padding: 24px;
            margin-bottom: 24px;
        }

        .panel h2 {
            margin: 0 0 16px;
            font-size: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        label {
            font-size: 13px;
            color: #6b7280;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            box-sizing: border-box;
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary {
            background: #4f46e5;
            color: #fff;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-success {
            background: #22c55e;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table th,
        table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .message {
            margin-top: 12px;
            font-size: 13px;
        }

        .message.error {
            color: #b91c1c;
        }

        .consensus-card {
            border: 1px dashed #c4b5fd;
            padding: 12px;
            border-radius: 10px;
            background: #f5f3ff;
            margin-top: 16px;
        }

        .nav-link {
            font-size: 14px;
            padding: 8px 14px;
            border-radius: 999px;
            background: #eef2ff;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background: #6b7280;
            color: white;
            font-size: 10px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            width: 320px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text strong {
            color: #60a5fa;
            display: block;
            margin-bottom: 4px;
        }

        .tooltip-text .formula {
            background: #374151;
            padding: 6px;
            border-radius: 4px;
            margin: 6px 0;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
    <!-- Error handling styles / ÈîôËØØÂ§ÑÁêÜÊ†∑Âºè -->
    <link rel="stylesheet" href="/static/error_styles.css">
    <!-- API Diagnostics and Error Handler / API ËØäÊñ≠ÂíåÈîôËØØÂ§ÑÁêÜ -->
    <script src="/static/api_diagnostics.js"></script>
    <script src="/static/error_handler.js"></script>
</head>

<body>
    <div class="page">
        <header>
            <div>
                <h1 style="margin:0;">LLM Trade Lab</h1>
                <div style="font-size:13px; color:#6b7280;">Fixed Spread Controls + Multi-LLM Evaluation</div>
            </div>
            <div style="display:flex; gap:12px;">
                <a class="nav-link" href="/hyperliquid">‚ö° Hyperliquid Trading</a>
                <a class="nav-link" href="/">‚Üê Back to Dashboard</a>
            </div>
        </header>

        <section class="panel">
            <h2>Fixed Spread Strategy Control Panel / Âõ∫ÂÆö‰ª∑Â∑ÆÁ≠ñÁï•ÊéßÂà∂Èù¢Êùø</h2>
            <div class="grid">
                <div>
                    <label>Trading Pair / ‰∫§ÊòìÂØπ</label>
                    <div style="display:flex; gap:8px;">
                        <select id="pairSelect">
                            <option value="ETH/USDT:USDT">ETH/USDT:USDT</option>
                            <option value="BTC/USDT:USDT">BTC/USDT:USDT</option>
                            <option value="SOL/USDT:USDT">SOL/USDT:USDT</option>
                        </select>
                        <button class="btn btn-secondary" onclick="switchPair()">Switch</button>
                    </div>
                </div>
            </div>
            <div class="grid" style="margin-top: 16px;">
                <div>
                    <label>Spread (%) / ‰ª∑Â∑Æ (%)</label>
                    <input type="number" id="spreadInput" step="0.01" value="1.5">
                </div>
                <div>
                    <label>Quantity / Êï∞Èáè</label>
                    <input type="number" id="quantityInput" step="0.01" value="0.1">
                </div>
                <div>
                    <label>Skew Factor / ÂÄæÊñúÂõ†Â≠ê</label>
                    <input type="number" id="skewInput" step="5" value="120">
                </div>
                <div>
                    <label>Leverage / Êù†ÊùÜ</label>
                    <input type="number" id="leverageInput" min="1" max="125" value="5">
                </div>
            </div>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn btn-primary" onclick="updateConfig()">üíæ Save Strategy Config</button>
                <button class="btn btn-secondary" onclick="updateLeverage()">‚ö° Update Leverage</button>
            </div>
            <div id="controlMessage" class="message"></div>
        </section>

        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0;">Multi-LLM Evaluation / Â§öÊ®°ÂûãËØÑ‰º∞</h2>
                    <div style="font-size:13px; color:#6b7280;">Gemini ¬∑ OpenAI ¬∑ Claude</div>
                </div>
                <button id="runEvaluationBtn" class="btn btn-primary" onclick="runEvaluation()">üöÄ Run Evaluation</button>
            </div>
            <div id="evaluationStatusText" class="message" style="color:#6b7280; margin-top:12px;">Ready.</div>
            <div id="evaluationErrorBox" class="message error" style="display:none;"></div>

            <div id="evaluationConsensusCard" class="consensus-card" style="display:none;">
                <div style="font-size:14px; font-weight:bold; color:#6d28d9;">ü§ù Consensus Recommendation / ÂÖ±ËØÜÂª∫ËÆÆ</div>
                <div style="margin-top:8px; font-size:13px;">
                    <div style="margin-bottom:8px;">
                        <button class="btn btn-secondary" style="font-size:11px; padding:4px 8px;" onclick="toggleLLMDetails()">
                            üìä Show LLM Input/Output Details
                        </button>
                    </div>
                    <div id="llmDetailsSection" style="display:block; background:#f9fafb; padding:12px; border-radius:8px; margin-bottom:12px; font-size:12px;">
                        <div style="font-weight:bold; margin-bottom:8px; color:#374151;">LLM ËæìÂÖ•Êï∞ÊçÆ / Input Data:</div>
                        <div id="llmInputData" style="color:#6b7280; font-family:monospace; white-space:pre-wrap; max-height:200px; overflow-y:auto; min-height:50px; background:#ffffff; padding:8px; border-radius:4px; border:1px solid #e5e7eb;">Loading...</div>
                        <div style="margin-top:12px; font-weight:bold; color:#374151;">ËÆ°ÁÆóËøáÁ®ã / Calculation Process:</div>
                        <div id="llmCalculationProcess" style="color:#6b7280; margin-top:4px; min-height:50px; background:#ffffff; padding:8px; border-radius:4px; border:1px solid #e5e7eb;">Loading...</div>
                    </div>
                    <div>Strategy: <span id="evaluationConsensusStrategy" style="font-weight:bold;">--</span></div>
                    <div style="display:none;">
                        Consensus Level: 
                        <span id="evaluationConsensusLevel">--</span>
                        <span class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Consensus Level / ÂÖ±ËØÜÁ®ãÂ∫¶</strong>
                                <div style="margin-top:6px;">
                                    <strong>ËÆ°ÁÆóÊñπÊ≥ï / Calculation:</strong>
                                    <div class="formula">consensus_ratio = ÂêåÊÑèÊ®°ÂûãÊï∞ / ÊÄªÊ®°ÂûãÊï∞</div>
                                </div>
                                <div style="margin-top:6px;">
                                    <strong>Á∫ßÂà´ÂÆö‰πâ / Levels:</strong>
                                    <div style="margin-top:4px;">
                                        ‚Ä¢ FULL (100%): ÊâÄÊúâÊ®°ÂûãÈÉΩÂêåÊÑèËØ•Á≠ñÁï•<br/>
                                        ‚Ä¢ MAJORITY (>50%): Â§öÊï∞Ê®°ÂûãÂêåÊÑè<br/>
                                        ‚Ä¢ SPLIT (0-50%): Ê®°ÂûãÈó¥ÊúâÂàÜÊ≠ß<br/>
                                        ‚Ä¢ NONE (0%): Êó†ÂÖ±ËØÜ
                                    </div>
                                </div>
                                <div style="margin-top:6px; font-size:11px; color:#9ca3af;">
                                    Êù•Ê∫ê: src/ai/evaluation/evaluator.py
                                </div>
                            </span>
                        </span>
                    </div>
                    <div style="display:none;">
                        Confidence: 
                        <span id="evaluationConsensusConfidence">--</span>
                        <span class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Confidence / ÁΩÆ‰ø°Â∫¶</strong>
                                <div style="margin-top:6px;">
                                    <strong>ËÆ°ÁÆóÊñπÊ≥ï / Calculation:</strong>
                                    <div class="formula">consensus_confidence = agreement_factor √ó weighted_confidence</div>
                                </div>
                                <div style="margin-top:6px;">
                                    <strong>ÁªÑÊàêÈÉ®ÂàÜ / Components:</strong>
                                    <div style="margin-top:4px;">
                                        ‚Ä¢ agreement_factor: Âü∫‰∫éÂÖ±ËØÜÁ∫ßÂà´<br/>
                                        &nbsp;&nbsp;FULL=1.0, MAJORITY=0.8, SPLIT=0.5<br/>
                                        ‚Ä¢ weighted_confidence: ÂêåÊÑèÊ®°ÂûãÁöÑÁΩÆ‰ø°Â∫¶Âä†ÊùÉÂπ≥Âùá<br/>
                                        &nbsp;&nbsp;ÊùÉÈáç‰∏∫Ê®°ÊãüÂæóÂàÜ (simulation score)
                                    </div>
                                </div>
                                <div style="margin-top:6px; font-size:11px; color:#9ca3af;">
                                    Êù•Ê∫ê: src/ai/evaluation/evaluator.py::calculate_consensus_confidence()
                                </div>
                            </span>
                        </span>
                    </div>
                    <div>Spread / Skew / Qty / Lev:
                        <span id="evaluationConsensusParams" style="font-weight:bold;">--</span>
                    </div>
                </div>
                <div id="evaluationConsensusStats" style="margin-top:6px; font-size:12px; color:#4b5563;">--</div>
                <div id="evaluationConsensusReasoning" style="margin-top:8px; font-size:12px; color:#6b7280;">--</div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn btn-success" style="flex:1;"
                        onclick="applyEvaluation('consensus')">Apply Consensus</button>
                    <button class="btn btn-primary" style="flex:1;"
                        onclick="startBotWithLLMSuggestion()">üöÄ Start Bot</button>
                </div>
            </div>

            <div id="evaluationResultsWrapper" style="margin-top:20px; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:13px; font-weight:bold;">Model Comparison / Ê®°ÂûãÂØπÊØî</div>
                    <div id="evaluationLastRun" style="font-size:11px; color:#6b7280;"></div>
                </div>
                <div style="overflow-x:auto; margin-top:8px;">
                    <table>
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th>Rank</th>
                                <th>Provider</th>
                                <th>Strategy</th>
                                <th>Spread</th>
                                <th>Skew</th>
                                <th>Qty</th>
                                <th>Lev</th>
                                <th>Confidence</th>
                                <th>PnL</th>
                                <th>Sharpe</th>
                                <th>Win%</th>
                                <th>Score</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="evaluationResultsBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0;">Current Orders / ÂΩìÂâçËÆ¢Âçï</h2>
                    <div style="font-size:13px; color:#6b7280;">Real-time order status</div>
                </div>
                <button class="btn btn-secondary" onclick="refreshOrders()">üîÑ Refresh</button>
            </div>
            <div id="ordersStatusText" class="message" style="color:#6b7280; margin-top:12px;">Loading orders...</div>
            <div id="ordersTableWrapper" style="margin-top:16px; display:none;">
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th>Order ID</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
                <div id="ordersEmptyMessage" style="text-align:center; padding:24px; color:#6b7280; display:none;">
                    No active orders
                </div>
            </div>
        </section>
    </div>

    <script>
        const controlMessage = document.getElementById('controlMessage');
        let currentEvalSymbol = 'ETHUSDT';
        let evaluationState = {
            loading: false,
            results: [],
            aggregated: null,
            lastError: null,
            lastRunSymbol: null,
            lastRunAt: null,
            marketContext: null,  // Store market context for display
        };

        function showMessage(el, text, isError = false) {
            if (!el) return;
            el.innerText = text;
            el.classList.toggle('error', isError);
        }

        function normalizeSymbol(symbol) {
            if (!symbol) return 'ETHUSDT';
            return symbol.toUpperCase().replace(/[:\/-]/g, '');
        }

        async function loadStatus() {
            const errorBox = document.getElementById('evaluationErrorBox') || document.getElementById('controlMessage');
            clearError(errorBox);
            
            try {
                const res = await diagnosticFetch('/api/status');
                const data = await res.json();
                
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                if (data.spread !== undefined) {
                    document.getElementById('spreadInput').value = (data.spread * 100).toFixed(3);
                }
                document.getElementById('quantityInput').value = data.quantity ?? 0.1;
                if (data.skew_factor !== undefined) {
                    document.getElementById('skewInput').value = data.skew_factor;
                }
                document.getElementById('leverageInput').value = data.leverage ?? 5;
                currentEvalSymbol = normalizeSymbol(data.symbol);

                const pairSelect = document.getElementById('pairSelect');
                if (pairSelect && data.symbol) {
                    for (const option of pairSelect.options) {
                        if (option.value.toUpperCase() === data.symbol.toUpperCase()) {
                            pairSelect.value = option.value;
                            break;
                        }
                    }
                }
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, `Failed to load status: ${err.message}`, true);
            }
        }

        async function updateConfig() {
            const errorBox = document.getElementById('evaluationErrorBox') || document.getElementById('controlMessage');
            clearError(errorBox);
            
            try {
                const payload = {
                    spread: parseFloat(document.getElementById('spreadInput').value || '0'),
                    quantity: parseFloat(document.getElementById('quantityInput').value || '0'),
                    strategy_type: 'fixed_spread',
                    strategy_id: 'default',
                    skew_factor: parseFloat(document.getElementById('skewInput').value || '0'),
                };
                const res = await diagnosticFetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.error || !data.ok) {
                    handleApiError(data, errorBox);
                    return;
                }
                showMessage(controlMessage, 'Strategy config updated.');
            } catch (err) {
                displayError(err, errorBox);
                showMessage(controlMessage, err.message || 'Failed to update config', true);
            }
        }

        async function updateLeverage() {
            try {
                const leverage = parseInt(document.getElementById('leverageInput').value || '1', 10);
                const res = await diagnosticFetch('/api/leverage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leverage),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showMessage(controlMessage, `Leverage updated to ${data.leverage}x`);
            } catch (err) {
                showMessage(controlMessage, err.message || 'Failed to update leverage', true);
            }
        }

        async function switchPair() {
            try {
                const symbol = document.getElementById('pairSelect').value;
                const res = await diagnosticFetch('/api/pair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol }),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                currentEvalSymbol = normalizeSymbol(symbol);
                showMessage(controlMessage, `Switched to ${symbol}`);
                loadStatus();
            } catch (err) {
                showMessage(controlMessage, err.message || 'Failed to switch pair', true);
            }
        }

        function getEvaluationSymbol() {
            const select = document.getElementById('pairSelect');
            const raw = select && select.value ? select.value : currentEvalSymbol;
            return normalizeSymbol(raw);
        }

        function formatPercent(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `${(value * 100).toFixed(decimals)}%`;
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return Number(value).toFixed(decimals);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return `$${Number(value).toFixed(2)}`;
        }

        function updateEvaluationUI() {
            const statusEl = document.getElementById('evaluationStatusText');
            const runBtn = document.getElementById('runEvaluationBtn');
            const errorBox = document.getElementById('evaluationErrorBox');
            const consensusCard = document.getElementById('evaluationConsensusCard');
            const resultsWrapper = document.getElementById('evaluationResultsWrapper');
            const resultsBody = document.getElementById('evaluationResultsBody');
            const lastRunEl = document.getElementById('evaluationLastRun');

            if (runBtn) runBtn.disabled = evaluationState.loading;
            if (evaluationState.loading) {
                statusEl.innerText = 'Running evaluation... Please wait.';
            } else if (evaluationState.lastRunAt) {
                statusEl.innerText = `Last run: ${evaluationState.lastRunSymbol} @ ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`;
            } else {
                statusEl.innerText = 'Ready.';
            }

            if (evaluationState.lastError) {
                errorBox.style.display = 'block';
                errorBox.innerText = evaluationState.lastError;
            } else {
                errorBox.style.display = 'none';
            }

            if (consensusCard) {
                const aggregated = evaluationState.aggregated;
                if (aggregated && aggregated.consensus_proposal && aggregated.strategy_consensus) {
                    const proposal = aggregated.consensus_proposal;
                    const consensus = aggregated.strategy_consensus;
                    const confidence = aggregated.consensus_confidence ?? 0;
                    consensusCard.style.display = 'block';
                    document.getElementById('evaluationConsensusStrategy').innerText = proposal.recommended_strategy || '--';
                    document.getElementById('evaluationConsensusLevel').innerText =
                        `${(consensus.consensus_level || '--').toUpperCase()} (${formatPercent(consensus.consensus_ratio || 0, 1)})`;
                    document.getElementById('evaluationConsensusConfidence').innerText = formatPercent(confidence, 1);
                    document.getElementById('evaluationConsensusParams').innerText =
                        `${formatPercent(proposal.spread || 0, 2)} ¬∑ Skew ${formatNumber(proposal.skew_factor || 0, 0)} ¬∑ Qty ${formatNumber(proposal.quantity || 0, 3)} ¬∑ Lev ${formatNumber(proposal.leverage || 0, 1)}x`;
                    document.getElementById('evaluationConsensusReasoning').innerText =
                        proposal.reasoning || 'Consensus reasoning unavailable.';
                    document.getElementById('evaluationConsensusStats').innerText =
                        `Avg PnL ${formatCurrency(aggregated.avg_pnl || 0)} ¬∑ Avg Sharpe ${formatNumber(aggregated.avg_sharpe || 0, 2)} ¬∑ Avg Win ${formatPercent(aggregated.avg_win_rate || 0, 1)}`;
                    
                    // Always update LLM details when consensus card is shown
                    // ÂΩìÂÖ±ËØÜÂç°ÁâáÊòæÁ§∫Êó∂ÊÄªÊòØÊõ¥Êñ∞ LLM ËØ¶ÊÉÖ
                    updateLLMDetails();
                } else {
                    consensusCard.style.display = 'none';
                }
            }

            if (resultsWrapper) {
                if (evaluationState.results.length > 0) {
                    resultsWrapper.style.display = 'block';
                    lastRunEl.innerText = evaluationState.lastRunAt
                        ? `Updated ${new Date(evaluationState.lastRunAt).toLocaleTimeString()}`
                        : '';
                    const rows = evaluationState.results.map((result) => {
                        const proposal = result.proposal || {};
                        const simulation = result.simulation || {};
                        const disabledApply = !proposal.parse_success ? 'disabled' : '';
                        const providerSafe = (result.provider_name || '').replace(/"/g, '&quot;');
                        const highlight = result.rank === 1 ? 'style="background:#fef3c7;"' : '';
                        return `
                            <tr ${highlight}>
                                <td>${result.rank ?? '--'}</td>
                                <td>${result.provider_name || '--'}</td>
                                <td>${proposal.recommended_strategy || '--'}</td>
                                <td>${formatPercent(proposal.spread || 0, 2)}</td>
                                <td>${formatNumber(proposal.skew_factor || 0, 0)}</td>
                                <td>${formatNumber(proposal.quantity || 0, 3)}</td>
                                <td>${formatNumber(proposal.leverage || 0, 1)}x</td>
                                <td>${formatPercent(proposal.confidence || 0, 1)}</td>
                                <td>${formatCurrency(simulation.realized_pnl)}</td>
                                <td>${formatNumber(simulation.sharpe_ratio || 0, 2)}</td>
                                <td>${formatPercent(simulation.win_rate || 0, 1)}</td>
                                <td>${formatNumber(result.score || 0, 1)}</td>
                                <td><button class="btn btn-secondary" style="font-size:11px;" ${disabledApply}
                                    onclick="applyEvaluation('individual', '${providerSafe}')">Apply</button></td>
                            </tr>`;
                    }).join('');
                    resultsBody.innerHTML = rows;
                } else {
                    resultsWrapper.style.display = 'none';
                    lastRunEl.innerText = '';
                }
            }
        }

        async function runEvaluation() {
            if (evaluationState.loading) return;
            evaluationState.loading = true;
            evaluationState.lastError = null;
            updateEvaluationUI();
            try {
                const res = await diagnosticFetch('/api/evaluation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: getEvaluationSymbol() }),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                evaluationState.results = data.individual_results || [];
                evaluationState.aggregated = data.aggregated || null;
                evaluationState.lastRunSymbol = data.symbol || getEvaluationSymbol();
                evaluationState.lastRunAt = new Date().toISOString();
                // Store market context if available in response
                if (data.market_context) {
                    evaluationState.marketContext = data.market_context;
                }
            } catch (err) {
                evaluationState.lastError = err.message || 'Failed to run evaluation';
            } finally {
                evaluationState.loading = false;
                updateEvaluationUI();
            }
        }

        function toggleLLMDetails() {
            const detailsSection = document.getElementById('llmDetailsSection');
            const button = event.target;
            if (detailsSection.style.display === 'none') {
                detailsSection.style.display = 'block';
                button.innerText = 'üìä Hide LLM Input/Output Details';
                updateLLMDetails();
            } else {
                detailsSection.style.display = 'none';
                button.innerText = 'üìä Show LLM Input/Output Details';
            }
        }
        
        // Auto-update LLM details when consensus card is shown
        // ÂΩìÂÖ±ËØÜÂç°ÁâáÊòæÁ§∫Êó∂Ëá™Âä®Êõ¥Êñ∞ LLM ËØ¶ÊÉÖ

        async function updateLLMDetails() {
            const inputDataEl = document.getElementById('llmInputData');
            const calcProcessEl = document.getElementById('llmCalculationProcess');
            
            // Try to get market context from evaluation results first, then fallback to status API
            // ‰ºòÂÖà‰ªéËØÑ‰º∞ÁªìÊûúËé∑ÂèñÂ∏ÇÂú∫‰∏ä‰∏ãÊñáÔºåÂê¶ÂàôÂõûÈÄÄÂà∞Áä∂ÊÄÅ API
            const evalResults = evaluationState.results || [];
            const evalAggregated = evaluationState.aggregated || {};
            
            let inputData = '„ÄêMarket Context / Â∏ÇÂú∫‰∏ä‰∏ãÊñá„Äë\n';
            inputData += 'Data sent to each LLM model (Gemini, OpenAI, Claude):\n\n';
            
            // Try to reconstruct market context from evaluation results
            // Â∞ùËØï‰ªéËØÑ‰º∞ÁªìÊûúÈáçÂª∫Â∏ÇÂú∫‰∏ä‰∏ãÊñá
            if (evalResults.length > 0 && evalResults[0].proposal) {
                // Market context is the same for all models, so we can use any result
                // ÊâÄÊúâÊ®°ÂûãÁöÑÂ∏ÇÂú∫‰∏ä‰∏ãÊñáÁõ∏ÂêåÔºåÂèØ‰ª•‰ΩøÁî®‰ªª‰ΩïÁªìÊûú
                try {
                    const statusRes = await diagnosticFetch('/api/status');
                    const status = await statusRes.json();
                    
                    const symbol = evaluationState.symbol || status.symbol || 'ETH/USDT:USDT';
                    const midPrice = status.mid_price || 0;
                    const bestBid = status.best_bid || midPrice * 0.999;
                    const bestAsk = status.best_ask || midPrice * 1.001;
                    const spreadBps = midPrice > 0 ? ((bestAsk - bestBid) / midPrice) * 10000 : 10.0;
                    const fundingRate = status.funding_rate || 0;
                    const position = status.position || 0;
                    const balance = status.balance || 0;
                    const leverage = status.leverage || 1;
                    
                    inputData += `‚Ä¢ Symbol: ${symbol}\n`;
                    inputData += `‚Ä¢ Mid Price: $${midPrice.toFixed(2)}\n`;
                    inputData += `‚Ä¢ Best Bid: $${bestBid.toFixed(2)}\n`;
                    inputData += `‚Ä¢ Best Ask: $${bestAsk.toFixed(2)}\n`;
                    inputData += `‚Ä¢ Market Spread: ${spreadBps.toFixed(2)} bps\n`;
                    inputData += `‚Ä¢ Volatility (1h): ~1% (estimated from price history)\n`;
                    inputData += `‚Ä¢ Volatility (24h): ~3% (estimated from price history)\n`;
                    inputData += `‚Ä¢ Funding Rate: ${(fundingRate * 100).toFixed(4)}%\n`;
                    inputData += `‚Ä¢ Funding Rate Trend: stable (estimated)\n`;
                    inputData += `‚Ä¢ Current Position: ${position} (${position > 0 ? 'long' : position < 0 ? 'short' : 'neutral'})\n`;
                    inputData += `‚Ä¢ Available Balance: $${balance.toFixed(2)}\n`;
                    inputData += `‚Ä¢ Current Leverage: ${leverage}x\n`;
                    inputData += `‚Ä¢ Historical Performance:\n`;
                    inputData += `  - Win Rate: ~0% (if available)\n`;
                    inputData += `  - Sharpe Ratio: ~0.0 (if available)\n`;
                    inputData += `  - Recent PnL: $0.00 (if available)\n`;
                } catch (err) {
                    inputData += 'Error loading market data. Please run evaluation first.\n';
                }
            } else {
                inputData += 'No evaluation results available. Please run evaluation first.\n';
            }
            
            inputDataEl.innerText = inputData;
            
            // Construct calculation process
            let calcProcess = '';
            
            if (evalResults.length > 0) {
                calcProcess += '<div style="margin-bottom:8px;"><strong>Step 1: LLM Inference / LLM Êé®ÁêÜ</strong></div>';
                calcProcess += `Each LLM (Gemini, OpenAI, Claude) receives the market context above and returns:<br/>`;
                calcProcess += `<div style="background:#e5e7eb; padding:6px; border-radius:4px; margin:4px 0; font-family:monospace; font-size:11px;">`;
                calcProcess += `{<br/>`;
                calcProcess += `&nbsp;&nbsp;"recommended_strategy": "FixedSpread" (only supported strategy),<br/>`;
                calcProcess += `&nbsp;&nbsp;"spread": 0.01,<br/>`;
                calcProcess += `&nbsp;&nbsp;"skew_factor": 100 (not used in simulation),<br/>`;
                calcProcess += `&nbsp;&nbsp;"quantity": 0.1,<br/>`;
                calcProcess += `&nbsp;&nbsp;"leverage": 1.0,<br/>`;
                calcProcess += `&nbsp;&nbsp;"confidence": 0.85,<br/>`;
                calcProcess += `&nbsp;&nbsp;"reasoning": "..."<br/>`;
                calcProcess += `}</div>`;
                calcProcess += `<div style="margin-top:4px; font-size:11px; color:#6b7280;">`;
                calcProcess += `Note: Only FixedSpread strategy is supported in simulation.<br/>`;
                calcProcess += `Ê≥®ÊÑèÔºöÊ®°Êãü‰∏≠‰ªÖÊîØÊåÅ FixedSpread Á≠ñÁï•„ÄÇ`;
                calcProcess += `</div><br/>`;
                
                calcProcess += '<div style="margin-bottom:8px; margin-top:12px;"><strong>Step 2: Simulation & Scoring / Ê®°Êãü‰∏éËØÑÂàÜ</strong></div>';
                calcProcess += `Each proposal is tested with ${evalAggregated.simulation_steps || 500} simulation steps<br/>`;
                calcProcess += `<div style="margin-top:4px;">`;
                calcProcess += `<strong>Simulation Process:</strong><br/>`;
                calcProcess += `1. Generate market data: Random walk with volatility (price ¬± volatility)<br/>`;
                calcProcess += `2. Calculate orders: Strategy generates buy/sell orders<br/>`;
                calcProcess += `3. Simulate fills: Orders fill if price crosses (buy: price‚â•bid, sell: price‚â§ask)<br/>`;
                calcProcess += `4. Track performance: PnL, win rate, Sharpe ratio<br/>`;
                calcProcess += `</div>`;
                calcProcess += `<div style="margin-top:8px;">`;
                calcProcess += `<strong>Score Formula / ËØÑÂàÜÂÖ¨Âºè:</strong><br/>`;
                calcProcess += `<code style="background:#e5e7eb; padding:4px 8px; border-radius:4px; display:inline-block; margin-top:4px;">`;
                calcProcess += `Score = PnL√ó40% + Sharpe√ó30% + WinRate√ó20% + Confidence√ó10%`;
                calcProcess += `</code><br/>`;
                calcProcess += `<div style="margin-top:4px; font-size:11px; color:#6b7280;">`;
                calcProcess += `‚Ä¢ Confidence: LLM's self-reported certainty (0-1) from JSON response<br/>`;
                calcProcess += `‚Ä¢ Source: src/ai/evaluation/evaluator.py::_score_and_rank()<br/>`;
                calcProcess += `</div>`;
                calcProcess += `</div><br/>`;
                
                calcProcess += '<div style="margin-bottom:8px; margin-top:12px;"><strong>Step 3: Consensus Calculation / ÂÖ±ËØÜËÆ°ÁÆó</strong></div>';
                if (evalAggregated.strategy_consensus) {
                    const consensus = evalAggregated.strategy_consensus;
                    calcProcess += `1. Count strategy votes: ${JSON.stringify(consensus.strategy_votes || {})}<br/>`;
                    calcProcess += `2. Calculate consensus ratio: ${((consensus.consensus_ratio || 0) * 100).toFixed(1)}%<br/>`;
                    calcProcess += `3. Select agreeing models (those voting for consensus strategy)<br/>`;
                }
                calcProcess += `4. Select final parameters from <strong>best-performing model</strong> among agreeing models:<br/>`;
                calcProcess += `<div style="margin-left:12px; margin-top:4px; color:#059669;">`;
                calcProcess += `‚úì Use <strong>complete parameter set</strong> from highest-scoring model<br/>`;
                calcProcess += `‚úì Ensures parameter coherence (parameters work together as atomic unit)<br/>`;
                calcProcess += `‚úì Avoids mixing parameters from different models<br/>`;
                calcProcess += `</div>`;
                calcProcess += `<div style="margin-left:12px; margin-top:4px; font-size:11px; color:#6b7280;">`;
                calcProcess += `Note: Previously used independent medians (FIXED in v1.6.6)<br/>`;
                calcProcess += `</div>`;
                
                if (evalAggregated.consensus_proposal) {
                    const proposal = evalAggregated.consensus_proposal;
                    calcProcess += `<div style="margin-top:8px; padding:6px; background:#dbeafe; border-radius:4px;">`;
                    calcProcess += `<strong>Final Consensus Parameters:</strong><br/>`;
                    calcProcess += `Spread: ${(proposal.spread * 100).toFixed(2)}%, `;
                    calcProcess += `Skew: ${proposal.skew_factor}, `;
                    calcProcess += `Qty: ${proposal.quantity}, `;
                    calcProcess += `Lev: ${proposal.leverage}x`;
                    calcProcess += `</div>`;
                }
            } else {
                calcProcess = '<em style="color:#9ca3af;">Run evaluation to see calculation process</em>';
            }
            
            calcProcessEl.innerHTML = calcProcess;
        }

        async function applyEvaluation(source, providerName = null) {
            try {
                const payload = { source };
                if (providerName) payload.provider_name = providerName;
                const res = await diagnosticFetch('/api/evaluation/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showMessage(controlMessage, 'Applied evaluation proposal.');
                loadStatus();
            } catch (err) {
                showMessage(controlMessage, err.message || 'Failed to apply proposal', true);
            }
        }

        async function startBotWithLLMSuggestion() {
            try {
                // First apply the consensus suggestion
                await applyEvaluation('consensus');
                
                // Then start the bot
                const res = await diagnosticFetch('/api/control?action=start', {
                    method: 'POST',
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showMessage(controlMessage, '‚úÖ Bot started with LLM suggestion!');
                
                // Refresh orders after starting
                setTimeout(refreshOrders, 1000);
            } catch (err) {
                showMessage(controlMessage, err.message || 'Failed to start bot', true);
            }
        }

        async function refreshOrders() {
            try {
                const statusEl = document.getElementById('ordersStatusText');
                const tableWrapper = document.getElementById('ordersTableWrapper');
                const tableBody = document.getElementById('ordersTableBody');
                const emptyMessage = document.getElementById('ordersEmptyMessage');
                
                statusEl.innerText = 'Loading orders...';
                
                const res = await fetch('/api/status');
                const data = await res.json();
                
                const orders = data.orders || [];
                
                if (orders.length === 0) {
                    tableWrapper.style.display = 'none';
                    emptyMessage.style.display = 'block';
                    statusEl.innerText = 'No active orders';
                } else {
                    tableWrapper.style.display = 'block';
                    emptyMessage.style.display = 'none';
                    statusEl.innerText = `Found ${orders.length} active order(s)`;
                    
                    const rows = orders.map(order => {
                        const orderId = order.id || order.orderId || '--';
                        const side = order.side || '--';
                        const price = formatNumber(order.price || 0, 4);
                        const quantity = formatNumber(order.amount || order.quantity || 0, 4);
                        const status = order.status || 'open';
                        const timestamp = order.timestamp ? new Date(order.timestamp).toLocaleTimeString() : '--';
                        
                        const sideColor = side.toLowerCase() === 'buy' ? '#22c55e' : '#ef4444';
                        
                        return `
                            <tr>
                                <td style="font-family:monospace; font-size:11px;">${orderId.substring(0, 20)}${orderId.length > 20 ? '...' : ''}</td>
                                <td><span style="color:${sideColor}; font-weight:bold;">${side.toUpperCase()}</span></td>
                                <td>${price}</td>
                                <td>${quantity}</td>
                                <td><span style="padding:2px 6px; border-radius:4px; background:#e5e7eb; font-size:11px;">${status}</span></td>
                                <td style="font-size:11px; color:#6b7280;">${timestamp}</td>
                            </tr>`;
                    }).join('');
                    
                    tableBody.innerHTML = rows;
                }
            } catch (err) {
                const statusEl = document.getElementById('ordersStatusText');
                statusEl.innerText = `Error loading orders: ${err.message}`;
                statusEl.classList.add('error');
            }
        }

        // Auto-refresh orders every 3 seconds
        let ordersRefreshInterval = null;
        function startOrdersAutoRefresh() {
            if (ordersRefreshInterval) clearInterval(ordersRefreshInterval);
            refreshOrders();
            ordersRefreshInterval = setInterval(refreshOrders, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            updateEvaluationUI();
            refreshOrders();
            startOrdersAutoRefresh();
        });
    </script>
</body>

</html>

